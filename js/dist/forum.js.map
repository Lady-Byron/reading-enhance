{"version":3,"file":"forum.js","mappings":"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","sources":["webpack://@lady-byron/reading-enhance-js/webpack/bootstrap","webpack://@lady-byron/reading-enhance-js/webpack/runtime/compat get default export","webpack://@lady-byron/reading-enhance-js/webpack/runtime/define property getters","webpack://@lady-byron/reading-enhance-js/webpack/runtime/hasOwnProperty shorthand","webpack://@lady-byron/reading-enhance-js/external root \"flarum.reg.get('core', 'forum/app')\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.reg.get('core', 'common/extend')\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.reg.get('core', 'forum/components/DiscussionPage')\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.reg.get('core', 'forum/components/PostStream')\"","webpack://@lady-byron/reading-enhance-js/./src/forum/index.ts"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.reg.get('core', 'forum/app');","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.reg.get('core', 'common/extend');","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.reg.get('core', 'forum/components/DiscussionPage');","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.reg.get('core', 'forum/components/PostStream');","import app from 'flarum/forum/app';\nimport { extend, override } from 'flarum/common/extend';\nimport DiscussionPage from 'flarum/forum/components/DiscussionPage';\nimport PostStream from 'flarum/forum/components/PostStream';\nfunction hasExplicitTarget() {\n  // 显式 URL/near 始终优先\n  const near = m.route.param && m.route.param('near') || null;\n  const hash = typeof window !== 'undefined' && window.location.hash || '';\n  return !!near || /^#p\\d+$/i.test(hash);\n}\nfunction extractTopVisiblePostNumber() {\n  // 兜底：从 DOM 计算“首个完全可见”的楼层号（Post DOM 带 data-number）\n  const items = document.querySelectorAll('.PostStream-item[data-number]');\n  const topOffset = 0; // 可按需扣掉页头高度\n  for (const el of Array.from(items)) {\n    const rect = el.getBoundingClientRect();\n    if (rect.top >= topOffset && rect.bottom <= (window.innerHeight || 0)) {\n      const num = parseInt(el.dataset.number || '', 10);\n      if (num > 0) return num;\n    }\n  }\n  return null;\n}\nfunction savePosition(discussionId, postNumber) {\n  // 去抖：在 PostStream 内部已有 calculatePositionTimeout 节流，我们不再二次节流\n  return app.request({\n    method: 'POST',\n    url: \"\".concat(app.forum.attribute('apiUrl'), \"/discussions/\").concat(discussionId, \"/reading-position\"),\n    body: {\n      postNumber\n    }\n  }).catch(() => {});\n}\napp.initializers.add('lady-byron/reading-enhance', () => {\n  // 1) 覆盖开场定位：如果没有显式 near/hash，就用我们记录的阅读位置\n  extend(DiscussionPage.prototype, 'oncreate', function () {\n    if (!app.session.user) return;\n    const discussion = this.discussion;\n    if (!discussion) return;\n    const recorded = discussion.attribute('lbReadingPosition') || null;\n    if (!hasExplicitTarget() && recorded && this.stream) {\n      // 延迟到下一帧，避免与核心初始定位竞争\n      requestAnimationFrame(() => {\n        this.stream.goToNumber(recorded);\n      });\n    }\n  });\n\n  // 2) 在渲染树里给 PostStream 注入 onPositionChange 回调（复用官方时机/节流）\n  override(DiscussionPage.prototype, 'view', function (original) {\n    var _this = this;\n    for (var _len = arguments.length, args = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {\n      args[_key - 1] = arguments[_key];\n    }\n    const vdom = original(...args);\n    const inject = node => {\n      if (!node) return;\n      if (Array.isArray(node)) return node.forEach(inject);\n      if (node.children) inject(node.children);\n      const tag = node.tag;\n      if (tag === PostStream) {\n        node.attrs = node.attrs || {};\n        const prev = node.attrs.onPositionChange;\n        node.attrs.onPositionChange = function () {\n          // 先调用已有的回调，保持兼容\n          if (typeof prev === 'function') prev(...arguments);\n          if (!app.session.user) return;\n          const dp = _this;\n          const discussion = dp == null ? void 0 : dp.discussion;\n          if (!discussion) return;\n\n          // “最后一次稳定停留的楼层”：优先用回调参数；若无，则用 DOM 兜底\n          // 说明：PostStream 的 onPositionChange 被核心以节流时机触发，足够代表“稳定停留”:contentReference[oaicite:7]{index=7}\n          let number = null;\n\n          // 若未来需要，可根据 cbArgs 结构解析首/末可见楼层；此处用 DOM 方案更兼容\n          number = extractTopVisiblePostNumber();\n          if (number && typeof number === 'number') {\n            // 需求：发新帖不强制把书签跳到自己新帖 —— 我们记录“首个完全可见楼层”，通常不会是最末回复\n            savePosition(discussion.id(), number).then(() => {\n              // 同步前端缓存，避免二次拉取\n              const current = discussion.attribute('lbReadingPosition');\n              if (current !== number) discussion.pushAttributes({\n                lbReadingPosition: number\n              });\n            });\n          }\n        };\n\n        // 并且在没有显式 near/hash 时，把 targetPost 也定成我们记录的楼层（再次兜底）\n        const discussion = this.discussion;\n        const recorded = (discussion == null ? void 0 : discussion.attribute('lbReadingPosition')) || null;\n        if (!hasExplicitTarget() && recorded) {\n          node.attrs.targetPost = recorded;\n        }\n      }\n    };\n    inject(vdom);\n    return vdom;\n  });\n});"],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","flarum","reg","hasExplicitTarget","near","m","route","param","hash","window","location","test","add","extend","user","discussion","this","recorded","attribute","stream","requestAnimationFrame","goToNumber","override","original","_this","_len","arguments","length","args","Array","_key","vdom","inject","node","isArray","forEach","children","tag","attrs","prev","onPositionChange","number","discussionId","postNumber","items","document","querySelectorAll","el","from","rect","getBoundingClientRect","top","bottom","innerHeight","num","parseInt","dataset","extractTopVisiblePostNumber","id","method","url","concat","body","catch","then","pushAttributes","lbReadingPosition","targetPost"],"sourceRoot":""}