{"version":3,"file":"forum.js","mappings":"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","sources":["webpack://@lady-byron/reading-enhance-js/webpack/bootstrap","webpack://@lady-byron/reading-enhance-js/webpack/runtime/compat get default export","webpack://@lady-byron/reading-enhance-js/webpack/runtime/define property getters","webpack://@lady-byron/reading-enhance-js/webpack/runtime/hasOwnProperty shorthand","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/app']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/states/PostStreamState']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/PostStream']\"","webpack://@lady-byron/reading-enhance-js/./src/forum/features/replyJumpInterceptor.ts","webpack://@lady-byron/reading-enhance-js/./src/forum/features/readingShortcuts.ts","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['common/extend']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/DiscussionPage']\"","webpack://@lady-byron/reading-enhance-js/./src/forum/features/readingPositionRecorder.ts","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/DiscussionListItem']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['common/components/Link']\"","webpack://@lady-byron/reading-enhance-js/./src/forum/features/discussionNavigation.ts","webpack://@lady-byron/reading-enhance-js/./src/forum/index.ts"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/states/PostStreamState'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/PostStream'];","// js/src/forum/features/replyJumpInterceptor.ts\nimport app from 'flarum/forum/app';\nimport PostStreamState from 'flarum/forum/states/PostStreamState';\nimport PostStream from 'flarum/forum/components/PostStream';\n\n/**\n * 精确令牌拦截：\n * - 仅在“提交新回复成功（POST /posts）”后，给对应讨论 did 上一次性令牌（可消费 2~3 次滚动入口）。\n * - 在 goToNumber('reply') / scrollToNumber(newNumber) / triggerScroll等入口，命中当前讨论且目标=回复/末楼时吞掉滚动。\n * - 不影响 near 跳转、点楼号、路由初始定位等其它行为。\n */\n\ntype Token = {\n  did: string | null;\n  targetNum: number | null; // 新回复的楼号（来自 POST /posts 响应）\n  left: number;             // 可吞次数（冗余入口链路下通常 2~3 次足够）\n  expiresAt: number;        // TTL，毫秒级\n};\n\nconst token: Token = {\n  did: null,\n  targetNum: null,\n  left: 0,\n  expiresAt: 0,\n};\n\nfunction now() {\n  return Date.now();\n}\nfunction activeFor(did: string | null): boolean {\n  return (\n    !!did &&\n    token.did === did &&\n    token.left > 0 &&\n    now() < token.expiresAt\n  );\n}\nfunction arm(did: string, targetNum: number | null, ttlMs = 1800, times = 3) {\n  token.did = did;\n  token.targetNum = typeof targetNum === 'number' && targetNum > 0 ? targetNum : null;\n  token.left = Math.max(1, times);\n  token.expiresAt = now() + Math.max(300, ttlMs);\n}\nfunction consume() {\n  if (token.left > 0) token.left -= 1;\n  if (token.left <= 0) {\n    token.did = null;\n    token.targetNum = null;\n    token.expiresAt = 0;\n  }\n}\n\nfunction isReplyJump(discussion: any, target: 'reply' | number | any): boolean {\n  // 仅判断“发帖后滚动到底部/新楼”的特征\n  if (!discussion) return false;\n\n  if (target === 'reply') return true;\n\n  const last: number | null =\n    typeof discussion.lastPostNumber === 'function'\n      ? discussion.lastPostNumber()\n      : discussion.attribute?.('lastPostNumber');\n\n  if (typeof target === 'number' && target > 0) {\n    // 目标是“末楼或更后”（保守 ≥）\n    if (typeof last === 'number' && last > 0 && target >= last) return true;\n    // 若有 POST 返回的确切新楼号，用它作判定更稳\n    if (token.targetNum && target >= token.targetNum) return true;\n  }\n\n  return false;\n}\n\nfunction installRequestHook() {\n  // 只包一次\n  if ((app as any).__lbReqHooked) return;\n  (app as any).__lbReqHooked = true;\n\n  const orig = app.request.bind(app);\n\n  app.request = function (opts: any) {\n    const p = orig(opts);\n    try {\n      const method = String(opts?.method || '').toUpperCase();\n      const url = String(opts?.url || '');\n      const isCreatePost =\n        method === 'POST' &&\n        /\\/posts(?:\\?|$|\\/)/.test(url); // .../api/posts\n\n      if (!isCreatePost) return p;\n\n      return p.then((res: any) => {\n        // 解析 discussionId 与新楼号\n        const did =\n          res?.data?.relationships?.discussion?.data?.id ??\n          res?.data?.attributes?.discussionId ??\n          null;\n        const num: number | null =\n          typeof res?.data?.attributes?.number === 'number'\n            ? res.data.attributes.number\n            : null;\n\n        if (did) {\n          arm(String(did), num, 1800, 3);\n        }\n        return res;\n      });\n    } catch {\n      // 出错不影响请求链路\n      return p;\n    }\n  };\n}\n\nfunction installScrollGuards() {\n  // --- goToNumber(entry)：最早的定位入口 ---\n  const goToOrig = (PostStreamState as any).prototype.goToNumber;\n  (PostStreamState as any).prototype.goToNumber = function (target: any, ...rest: any[]) {\n    try {\n      const discussion = (this as any)?.discussion;\n      const did =\n        discussion?.id?.() ??\n        (typeof discussion?.id === 'function' ? discussion.id() : null);\n\n      if (activeFor(did) && isReplyJump(discussion, target)) {\n        consume();\n        return; // 吞掉这一次“发帖后自动滚动”\n      }\n    } catch {}\n    return goToOrig.apply(this, [target, ...rest]);\n  };\n\n  // --- PostStream.prototype.triggerScroll：滚动触发（适配不同核心版本） ---\n  const psProto: any = (PostStream as any).prototype;\n\n  if (typeof psProto.triggerScroll === 'function') {\n    const trigOrig = psProto.triggerScroll;\n    psProto.triggerScroll = function (...args: any[]) {\n      try {\n        const state = this?.attrs?.state;\n        const discussion = state?.discussion;\n        const did =\n          discussion?.id?.() ??\n          (typeof discussion?.id === 'function' ? discussion.id() : null);\n        const target =\n          state?.targetPostNumber ??\n          state?.index ??\n          (state?.visible && state.visible.number) ??\n          null;\n\n        if (activeFor(did) && isReplyJump(discussion, target)) {\n          consume();\n          return;\n        }\n      } catch {}\n      return trigOrig.apply(this, args);\n    };\n  }\n\n  // --- PostStream.prototype.scrollToNumber：另一实现路径 ---\n  if (typeof psProto.scrollToNumber === 'function') {\n    const toNumOrig = psProto.scrollToNumber;\n    psProto.scrollToNumber = function (n: number, ...rest: any[]) {\n      try {\n        const state = this?.attrs?.state;\n        const discussion = state?.discussion;\n        const did =\n          discussion?.id?.() ??\n          (typeof discussion?.id === 'function' ? discussion.id() : null);\n\n        if (activeFor(did) && isReplyJump(discussion, n)) {\n          consume();\n          return;\n        }\n      } catch {}\n      return toNumOrig.apply(this, [n, ...rest]);\n    };\n  }\n\n  // --- PostStream.prototype.scrollToIndex：极少数路径（保守） ---\n  if (typeof psProto.scrollToIndex === 'function') {\n    const toIdxOrig = psProto.scrollToIndex;\n    psProto.scrollToIndex = function (i: number, ...rest: any[]) {\n      try {\n        const state = this?.attrs?.state;\n        const discussion = state?.discussion;\n        const did =\n          discussion?.id?.() ??\n          (typeof discussion?.id === 'function' ? discussion.id() : null);\n        const approxTarget =\n          state?.visible?.number && typeof state.visible.number === 'number'\n            ? state.visible.number\n            : i;\n\n        if (activeFor(did) && isReplyJump(discussion, approxTarget)) {\n          consume();\n          return;\n        }\n      } catch {}\n      return toIdxOrig.apply(this, [i, ...rest]);\n    };\n  }\n}\n\nexport default function installReplyJumpInterceptor() {\n  app.initializers.add('lady-byron/reading-enhance-reply-jump', () => {\n    // 1) 监听“发帖成功”\n    installRequestHook();\n\n    // 2) 拦截“仅限由发帖引发的滚动”\n    installScrollGuards();\n  });\n}\n","// js/src/forum/features/readingShortcuts.ts\nimport app from 'flarum/forum/app';\n\n/**\n * 半屏/整屏翻页快捷键（桌面端优先）\n * - Shift+D  半屏下\n * - Shift+U  半屏上\n * - Shift+J  整屏下\n * - Shift+K  整屏上\n *\n * 仅在非输入/编辑状态触发；不影响弹窗、编辑器、Composer。\n */\n\ntype Options = {\n  halfRatio: number;       // 半屏比例\n  smooth: boolean;         // 是否平滑滚动\n  headerSelector: string;  // 顶栏选择器，用于抵扣可视高度\n};\n\nconst DEFAULTS: Options = {\n  halfRatio: 0.5,\n  smooth: true,\n  headerSelector: '.App-header',\n};\n\nfunction isEditableTarget(t: EventTarget | null): boolean {\n  const el = t instanceof Element ? t : null;\n  if (!el) return false;\n\n  // 常见可编辑/输入容器\n  const editable = el.closest(\n    'input, textarea, [contenteditable=\"true\"], .TextEditor, .CodeMirror, .ProseMirror, .Composer, .Modal'\n  );\n  // Composer 打开时整体禁用\n  const composerOpen = !!(app as any)?.composer?.isVisible?.();\n\n  return !!editable || composerOpen;\n}\n\nfunction headerOffsetPx(sel: string): number {\n  try {\n    const h = document.querySelector(sel);\n    return h ? h.getBoundingClientRect().height : 0;\n  } catch {\n    return 0;\n  }\n}\n\nfunction scrollByAmount(px: number, smooth: boolean) {\n  if ('scrollBy' in window) {\n    window.scrollBy({ top: px, left: 0, behavior: smooth ? 'smooth' : 'auto' });\n  } else {\n    const sc = document.scrollingElement || document.documentElement || document.body;\n    sc.scrollTop += px;\n  }\n}\n\nfunction keySig(e: KeyboardEvent): string {\n  // 只关心 Shift + 字母，不处理 Ctrl/Meta/Alt，避免系统/浏览器冲突\n  if (e.ctrlKey || e.metaKey || e.altKey) return '';\n  const parts: string[] = [];\n  if (e.shiftKey) parts.push('Shift');\n  const k = e.key.length === 1 ? e.key.toUpperCase() : e.key;\n  parts.push(k);\n  return parts.join('+');\n}\n\nexport default function installReadingShortcuts(opts?: Partial<Options>) {\n  const options: Options = Object.assign({}, DEFAULTS, opts || {});\n  let attached = false;\n\n  app.initializers.add('lady-byron/reading-enhance-shortcuts', () => {\n    if (attached) return;\n    attached = true;\n\n    const onKeydown = (e: KeyboardEvent) => {\n      // 在输入/编辑/弹窗内不触发；忽略按住不放的连发\n      if (isEditableTarget(e.target) || e.repeat) return;\n\n      const sig = keySig(e);\n      if (!sig) return;\n\n      const offset = headerOffsetPx(options.headerSelector);\n      const vh = window.innerHeight || 0;\n\n      switch (sig) {\n        case 'Shift+D': {\n          e.preventDefault(); e.stopPropagation();\n          const delta = Math.max(1, Math.round(vh * options.halfRatio) - Math.round(offset / 2));\n          scrollByAmount(delta, options.smooth);\n          break;\n        }\n        case 'Shift+U': {\n          e.preventDefault(); e.stopPropagation();\n          const delta = Math.max(1, Math.round(vh * options.halfRatio) - Math.round(offset / 2));\n          scrollByAmount(-delta, options.smooth);\n          break;\n        }\n        case 'Shift+J': {\n          e.preventDefault(); e.stopPropagation();\n          scrollByAmount(vh, options.smooth);\n          break;\n        }\n        case 'Shift+K': {\n          e.preventDefault(); e.stopPropagation();\n          scrollByAmount(-vh, options.smooth);\n          break;\n        }\n        default:\n          // 其它组合不处理\n          break;\n      }\n    };\n\n    // 捕获阶段优先处理，但不干扰其它键位\n    window.addEventListener('keydown', onKeydown, true);\n\n    // 若未来需要卸载，可暴露到全局（调试用）\n    (window as any).__lb_shortcuts = {\n      detach() {\n        window.removeEventListener('keydown', onKeydown, true);\n      },\n    };\n  });\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionPage'];","// js/src/forum/features/readingPositionRecorder.ts\nimport app from 'flarum/forum/app';\nimport { override } from 'flarum/common/extend';\nimport DiscussionPage from 'flarum/forum/components/DiscussionPage';\nimport PostStream from 'flarum/forum/components/PostStream';\n\n/** ---- 工具：从 onPositionChange 的参数中提取楼号（与原版一致） ---- */\nfunction derivePostNumberFromPositionChangeArgs(args: any[]): number | null {\n  for (const a of args) {\n    if (a == null) continue;\n\n    if (typeof a === 'number') {\n      if (a > 0) return a;\n    } else if (typeof a === 'object') {\n      if (typeof (a as any).number === 'number' && (a as any).number > 0) {\n        return (a as any).number;\n      }\n      if (typeof (a as any).postNumber === 'number' && (a as any).postNumber > 0) {\n        return (a as any).postNumber;\n      }\n      if (typeof (a as any).near === 'number' && (a as any).near > 0) {\n        return (a as any).near;\n      }\n      if (\n        (a as any).visible &&\n        typeof (a as any).visible.number === 'number' &&\n        (a as any).visible.number > 0\n      ) {\n        return (a as any).visible.number as number;\n      }\n    }\n  }\n  return null;\n}\n\n/** 从当前 URL 提取 near（/d/:id/:near 或 ?near=） */\nfunction extractNearFromUrl(): number | null {\n  try {\n    const url = new URL(window.location.href);\n    const parts = url.pathname.split('/').filter(Boolean);\n    const dIndex = parts.indexOf('d');\n    if (dIndex !== -1 && parts.length > dIndex + 2) {\n      const maybeNear = parseInt(parts[dIndex + 2], 10);\n      if (!Number.isNaN(maybeNear) && maybeNear > 0) return maybeNear;\n    }\n    const qNear = parseInt(url.searchParams.get('near') || '', 10);\n    if (!Number.isNaN(qNear) && qNear > 0) return qNear;\n  } catch {}\n  return null;\n}\n\n/** 作为最后退路：扫描顶部附近的 .PostStream-item[data-number] */\nfunction extractTopPartiallyVisible(): number | null {\n  const items = document.querySelectorAll<HTMLElement>('.PostStream-item[data-number]');\n  const viewportTop = 4;\n\n  for (const el of Array.from(items)) {\n    const rect = el.getBoundingClientRect();\n    if (rect.top <= viewportTop && rect.bottom > viewportTop) {\n      const n = parseInt(el.dataset.number || '', 10);\n      if (n > 0) return n;\n    }\n  }\n\n  for (const el of Array.from(items)) {\n    const rect = el.getBoundingClientRect();\n    if (rect.top >= viewportTop && rect.top < (window.innerHeight || 0)) {\n      const n = parseInt(el.dataset.number || '', 10);\n      if (n > 0) return n;\n    }\n  }\n\n  return null;\n}\n\n/** 写库（静默失败即可） */\nfunction savePosition(discussionId: string, postNumber: number) {\n  return app\n    .request({\n      method: 'POST',\n      url: `${app.forum.attribute('apiUrl')}/ladybyron/reading-position`,\n      body: { discussionId, postNumber },\n    })\n    .catch(() => {});\n}\n\n/** 200ms 轻节流 + 去重（双向允许） */\nconst DEBOUNCE_MS = 200;\nconst pendingTimerByDiscussion: Record<string, number> = Object.create(null);\nconst pendingCandidateByDiscussion: Record<string, number> = Object.create(null);\nconst lastCommittedByDiscussion: Record<string, number> = Object.create(null);\n\nfunction scheduleSaveBidirectional(discussion: any, candidate: number) {\n  const id: string = discussion.id();\n  if (pendingCandidateByDiscussion[id] === candidate) return;\n\n  pendingCandidateByDiscussion[id] = candidate;\n\n  if (pendingTimerByDiscussion[id]) {\n    window.clearTimeout(pendingTimerByDiscussion[id]);\n  }\n\n  pendingTimerByDiscussion[id] = window.setTimeout(() => {\n    const toSend = pendingCandidateByDiscussion[id];\n    if (typeof toSend !== 'number' || toSend <= 0) return;\n\n    const current = discussion.attribute('lbReadingPosition') ?? 0;\n    const lastCommitted = lastCommittedByDiscussion[id] ?? current;\n    if (toSend === current || toSend === lastCommitted) return;\n\n    savePosition(id, toSend).then(() => {\n      lastCommittedByDiscussion[id] = toSend;\n      if (discussion.attribute('lbReadingPosition') !== toSend) {\n        discussion.pushAttributes({ lbReadingPosition: toSend });\n      }\n    });\n  }, DEBOUNCE_MS);\n}\n\nlet attached = false;\n\nexport default function installReadingPositionRecorder() {\n  if (attached) return;\n  attached = true;\n\n  app.initializers.add('lady-byron/reading-enhance-position', () => {\n    override(DiscussionPage.prototype, 'view', function (original: any, ...args: any[]) {\n      const vdom = original(...args);\n\n      const inject = (node: any) => {\n        if (!node) return;\n        if (Array.isArray(node)) return node.forEach(inject);\n        if (node.children) inject(node.children);\n\n        if (node.tag === PostStream) {\n          node.attrs = node.attrs || {};\n          const prev = node.attrs.onPositionChange;\n\n          node.attrs.onPositionChange = (...cbArgs: any[]) => {\n            if (typeof prev === 'function') prev(...cbArgs);\n            if (!app.session.user) return;\n\n            const dp = this as any;\n            const discussion = dp?.discussion;\n            if (!discussion) return;\n\n            let n = derivePostNumberFromPositionChangeArgs(cbArgs);\n            if (!n) n = extractNearFromUrl();\n            if (!n) n = extractTopPartiallyVisible();\n\n            if (n && typeof n === 'number' && n > 0) {\n              scheduleSaveBidirectional(discussion, n);\n            }\n          };\n        }\n      };\n\n      inject(vdom);\n      return vdom;\n    });\n  });\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionListItem'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/components/Link'];","// js/src/forum/features/discussionNavigation.ts\nimport app from 'flarum/forum/app';\nimport { extend } from 'flarum/common/extend';\nimport DiscussionListItem from 'flarum/forum/components/DiscussionListItem';\nimport Link from 'flarum/common/components/Link';\n\n/** ---- v17 blog 路由判定（与你现有实现一致） ---- */\n// @ts-ignore\ndeclare const flarum: any;\n\nfunction shouldRedirectDiscussionToBlog(discussion: any): boolean {\n  try {\n    // flarum.extensions 由内核注入到 window 作用域\n    // @ts-ignore\n    if (!flarum || !('v17development-blog' in flarum.extensions)) return false;\n  } catch {\n    return false;\n  }\n\n  const redirects = app.forum.attribute('blogRedirectsEnabled');\n  const discussionRedirectEnabled =\n    redirects === 'both' || redirects === 'discussions_only';\n\n  const tags = discussion.tags?.() || [];\n  if (!discussionRedirectEnabled || tags.length === 0) return false;\n\n  const blogTags = app.forum.attribute<string[]>('blogTags') || [];\n\n  return tags.some((tag: any) => {\n    if (!tag) return false;\n    const parent = tag.parent?.() || null;\n    return (\n      blogTags.indexOf(tag.id?.()!) !== -1 ||\n      (parent && blogTags.indexOf(parent.id?.()!) !== -1)\n    );\n  });\n}\n\n/** ---- URL 工具 ---- */\nfunction sameOrigin(u: URL): boolean {\n  try {\n    const base = new URL(app.forum.attribute('baseUrl'));\n    return u.origin === base.origin;\n  } catch {\n    return false;\n  }\n}\n\nfunction parseDiscussionIdFromUrl(u: URL): string | null {\n  const parts = u.pathname.split('/').filter(Boolean);\n  const dIndex = parts.indexOf('d');\n  if (dIndex === -1 || parts.length <= dIndex + 1) return null;\n  const idPart = parts[dIndex + 1];\n  const match = /^(\\d+)/.exec(idPart);\n  return match ? match[1] : null;\n}\n\n/** 显式 near 识别：数字 | 'first' | 'last' | #p123 | #reply/#last/#first */\nfunction hasExplicitNear(u: URL): number | 'first' | 'last' | null {\n  const parts = u.pathname.split('/').filter(Boolean);\n  const dIndex = parts.indexOf('d');\n\n  // /d/:id/:near（数字）\n  if (dIndex !== -1 && parts.length > dIndex + 2) {\n    const n = parseInt(parts[dIndex + 2], 10);\n    if (!Number.isNaN(n) && n > 0) return n; // near=1 也视为显式\n  }\n\n  // ?near=（数字 | first | last）\n  const nearRaw = u.searchParams.get('near');\n  if (nearRaw) {\n    const n = parseInt(nearRaw, 10);\n    if (!Number.isNaN(n) && n > 0) return n;\n    const s = nearRaw.toLowerCase();\n    if (s === 'first') return 'first';\n    if (s === 'last') return 'last';\n  }\n\n  // 锚点：#p123 / #reply / #last / #first\n  if (u.hash) {\n    const h = u.hash.toLowerCase();\n    if (/^#p\\d+$/.test(h)) return parseInt(h.slice(2), 10);\n    if (h === '#reply' || h === '#last') return 'last';\n    if (h === '#first') return 'first';\n  }\n  return null;\n}\n\n/** 从前端 store 读取 near（lbReadingPosition > lastReadPostNumber > null） */\nfunction nearFromStore(id: string): number | null {\n  const d = app.store.getById('discussions', id);\n  if (!d) return null;\n\n  const lb =\n    typeof d.attribute === 'function'\n      ? d.attribute('lbReadingPosition')\n      : (d as any).lbReadingPosition;\n\n  const last =\n    typeof d.lastReadPostNumber === 'function'\n      ? d.lastReadPostNumber()\n      : typeof d.attribute === 'function'\n      ? d.attribute('lastReadPostNumber')\n      : null;\n\n  const lbNum = typeof lb === 'number' ? lb : null;\n  const lastNum = typeof last === 'number' ? last : null;\n\n  return lbNum && lbNum > 1\n    ? lbNum\n    : lastNum && lastNum > 1\n    ? lastNum\n    : null;\n}\n\n/** 把 /d/:id[/slug] 改成 /d/:id[/slug]/:near（移除 ?near，去掉 #p123） */\nfunction buildNearUrl(u: URL, near: number): string {\n  const parts = u.pathname.split('/').filter(Boolean);\n  const dIndex = parts.indexOf('d');\n  if (dIndex === -1 || parts.length <= dIndex + 1) return u.pathname + u.search + u.hash;\n\n  const prefix = '/' + parts.slice(0, dIndex + 2).join('/');\n  u.pathname = `${prefix}/${near}`;\n  u.searchParams.delete('near');\n  if (u.hash && /^#p\\d+$/i.test(u.hash)) u.hash = '';\n\n  return u.pathname + u.search + u.hash;\n}\n\n/** 从事件 target 向上寻找 <a> */\nfunction findAnchor(target: EventTarget | null): HTMLAnchorElement | null {\n  let el = target as HTMLElement | null;\n  while (el && el !== document.body) {\n    if (el instanceof HTMLAnchorElement) return el;\n    el = el.parentElement;\n  }\n  return null;\n}\n\n/** Scrubber 相关元素：完全放行 */\nconst SCRUBBER_SKIP = '.PostStreamScrubber, .Scrubber, .item-scrubber, .PostStream-scrubber';\n\nlet attached = false;\n\nexport default function installDiscussionNavigation() {\n  if (attached) return;\n  attached = true;\n\n  app.initializers.add('lady-byron/reading-enhance-navigation', () => {\n    /** 1) 列表项改写（保留 v17 blog 支持 & 搜索页特例） */\n    extend(DiscussionListItem.prototype, 'view', function (vdom: any) {\n      // 搜索页（params.q）不改写，保留“最相关”体验\n      if ((this as any).attrs?.params?.q) return;\n\n      const discussion = (this as any).attrs?.discussion;\n      if (!discussion) return;\n\n      const recorded: number | null = discussion.attribute('lbReadingPosition') ?? null;\n      if (!recorded || recorded <= 1) return;\n\n      (vdom.children as any[]).forEach((child: any) => {\n        if (\n          !child ||\n          !child.attrs ||\n          !child.attrs.className ||\n          child.attrs.className.indexOf('DiscussionListItem-content') === -1\n        ) {\n          return;\n        }\n\n        (child.children as any[]).forEach((sub: any) => {\n          if (!sub || sub.tag !== Link) return;\n\n          let href: string;\n\n          if (shouldRedirectDiscussionToBlog(discussion)) {\n            href =\n              recorded > 1\n                ? app.route('blogArticle.near', { id: discussion.slug(), near: recorded })\n                : app.route('blogArticle', { id: discussion.slug() });\n          } else {\n            href = app.route.discussion(discussion, recorded);\n          }\n\n          sub.attrs = sub.attrs || {};\n          sub.attrs.href = href;\n          sub.attrs['data-lbRewritten'] = '1';\n        });\n      });\n    });\n\n    /** 2) Link.view 级别的通用 near 注入（不打 API） */\n    extend(Link.prototype as any, 'view', function (vdom: any) {\n      const attrs = vdom.attrs || {};\n      if (attrs['data-lbRewritten']) return;\n\n      const href: string | undefined = attrs.href;\n      if (typeof href !== 'string' || !href.trim()) return;\n\n      let u: URL;\n      try {\n        u = new URL(href, app.forum.attribute('baseUrl'));\n      } catch {\n        return;\n      }\n\n      if (!sameOrigin(u)) return;\n\n      const explicit = hasExplicitNear(u);\n      if (explicit) return;\n\n      const id = parseDiscussionIdFromUrl(u);\n      if (!id) return;\n\n      const near = nearFromStore(id);\n      if (!near || near <= 1) return;\n\n      const target = buildNearUrl(u, near);\n      vdom.attrs.href = target;\n      vdom.attrs['data-lbRewritten'] = '1';\n    });\n\n    /** 3) 兜底补丁：程序化 m.route.set('/d/:id[..]') 时补一个 near */\n    // @ts-ignore\n    const oldSet = m.route.set.bind(m.route);\n    // @ts-ignore\n    m.route.set = function (path: string, data?: any, options?: any) {\n      try {\n        if (typeof path === 'string') {\n          const url = new URL(path, window.location.origin);\n          const parts = url.pathname.split('/').filter(Boolean);\n          const dIndex = parts.indexOf('d');\n\n          if (dIndex !== -1 && parts.length > dIndex + 1) {\n            const hasNearPath =\n              parts.length > dIndex + 2 && /^\\d+$/.test(parts[dIndex + 2]);\n            const hasNearQuery = url.searchParams.has('near'); // near=first/last 也算显式\n\n            if (!hasNearPath && !hasNearQuery) {\n              const idPart = parts[dIndex + 1];\n              const idMatch = /^(\\d+)/.exec(idPart);\n              const id = idMatch ? idMatch[1] : null;\n\n              if (id) {\n                const near = nearFromStore(id);\n                if (near && near > 1) {\n                  const prefix = '/' + parts.slice(0, dIndex + 2).join('/');\n                  url.pathname = `${prefix}/${near}`;\n                  url.searchParams.delete('near');\n                  path = url.pathname + url.search + url.hash;\n                }\n              }\n            }\n          }\n        }\n      } catch {}\n\n      // @ts-ignore\n      return oldSet(path, data, options);\n    };\n\n    /** 4) DOM 级兜底：点击任意 <a> 时，只改 href，不阻断，覆盖导航栏/组件内帖子 */\n    const onDocumentClick = (e: MouseEvent) => {\n      // 已经被别的 handler 阻止的，就不碰\n      if (e.defaultPrevented) return;\n\n      // 只处理左键单击，不处理中键/右键及组合键（避免破坏“新标签页”行为）\n      if (e.button !== 0) return;\n      if (e.metaKey || e.ctrlKey || e.altKey) return;\n\n      const a = findAnchor(e.target);\n      if (!a) return;\n\n      // Scrubber / 楼层滑条相关链接：完全放行\n      if (a.matches('.Scrubber-first, .Scrubber-last') || a.closest(SCRUBBER_SKIP)) {\n        return;\n      }\n\n      const hrefAttr = a.getAttribute('href');\n      if (!hrefAttr || !hrefAttr.trim()) return;\n\n      let u: URL;\n      try {\n        u = new URL(a.href, window.location.href);\n      } catch {\n        return;\n      }\n\n      if (!sameOrigin(u)) return;\n\n      const explicit = hasExplicitNear(u);\n      if (explicit) return;\n\n      const id = parseDiscussionIdFromUrl(u);\n      if (!id) return;\n\n      const near = nearFromStore(id);\n      if (!near || near <= 1) return;\n\n      const target = buildNearUrl(u, near);\n\n      // 只修改 href，不 preventDefault；后续由 Flarum 或浏览器按新的 href 导航\n      if (a.href !== target) {\n        a.href = target;\n        a.dataset.lbRewritten = '1';\n      }\n    };\n\n    document.addEventListener('click', onDocumentClick, true);\n\n    // 调试/卸载用\n    (window as any).__lb_reading_nav = {\n      detach() {\n        document.removeEventListener('click', onDocumentClick, true);\n      },\n    };\n  });\n}\n","// js/src/forum/index.ts\nimport installReplyJumpInterceptor from './features/replyJumpInterceptor';\nimport installReadingShortcuts from './features/readingShortcuts';\nimport installReadingPositionRecorder from './features/readingPositionRecorder';\nimport installDiscussionNavigation from './features/discussionNavigation';\n\n// 纯入口：只负责注册各模块的 initializer\ninstallReplyJumpInterceptor();\ninstallReadingShortcuts();\ninstallReadingPositionRecorder();\ninstallDiscussionNavigation();\n"],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","flarum","core","compat","token","did","targetNum","left","expiresAt","now","Date","activeFor","consume","isReplyJump","discussion","target","last","lastPostNumber","attribute","DEFAULTS","halfRatio","smooth","headerSelector","scrollByAmount","px","window","scrollBy","top","behavior","document","scrollingElement","documentElement","body","scrollTop","pendingTimerByDiscussion","create","pendingCandidateByDiscussion","lastCommittedByDiscussion","attached","sameOrigin","u","base","URL","app","origin","_unused2","parseDiscussionIdFromUrl","parts","pathname","split","filter","Boolean","dIndex","indexOf","length","idPart","match","exec","hasExplicitNear","n","parseInt","Number","isNaN","nearRaw","searchParams","s","toLowerCase","hash","h","test","slice","nearFromStore","id","getById","lb","lbReadingPosition","lastReadPostNumber","lbNum","lastNum","buildNearUrl","near","search","prefix","join","add","orig","bind","opts","p","method","String","toUpperCase","url","then","res","_ref","_res$data$relationshi","_res$data","_res$data2","_res$data3","data","relationships","attributes","discussionId","num","number","ttlMs","times","Math","max","arm","_unused","installRequestHook","goToOrig","PostStreamState","goToNumber","_discussion$id","this","_len","arguments","rest","Array","_key","apply","concat","psProto","PostStream","triggerScroll","trigOrig","_this$attrs","_discussion$id2","_ref2","_ref3","_state$targetPostNumb","state","attrs","targetPostNumber","index","visible","_unused3","_len2","args","_key2","scrollToNumber","toNumOrig","_this$attrs2","_discussion$id3","_unused4","_len3","_key3","scrollToIndex","toIdxOrig","i","_this$attrs3","_discussion$id4","_state$visible","approxTarget","_unused5","_len4","_key4","installScrollGuards","options","assign","onKeydown","e","t","_composer","el","Element","editable","closest","composerOpen","isVisible","isEditableTarget","repeat","sig","ctrlKey","metaKey","altKey","shiftKey","push","k","keySig","offset","sel","querySelector","getBoundingClientRect","height","headerOffsetPx","vh","innerHeight","preventDefault","stopPropagation","round","addEventListener","__lb_shortcuts","detach","removeEventListener","installReadingShortcuts","override","DiscussionPage","original","_this","vdom","inject","node","isArray","forEach","children","tag","prev","onPositionChange","cbArgs","user","_step","_iterator","_createForOfIteratorHelperLoose","done","value","postNumber","derivePostNumberFromPositionChangeArgs","location","href","maybeNear","qNear","extractNearFromUrl","items","querySelectorAll","_i","_Array$from","from","rect","bottom","dataset","_i2","_Array$from2","extractTopPartiallyVisible","candidate","clearTimeout","setTimeout","_discussion$attribute","_lastCommittedByDiscu","toSend","current","lastCommitted","pushAttributes","scheduleSaveBidirectional","extend","DiscussionListItem","_attrs","_attrs2","params","q","recorded","child","className","sub","Link","extensions","redirects","discussionRedirectEnabled","tags","blogTags","some","parent","shouldRedirectDiscussionToBlog","slug","trim","oldSet","m","route","set","path","hasNearPath","hasNearQuery","has","idMatch","onDocumentClick","defaultPrevented","button","HTMLAnchorElement","parentElement","findAnchor","matches","hrefAttr","getAttribute","lbRewritten","__lb_reading_nav"],"ignoreList":[],"sourceRoot":""}