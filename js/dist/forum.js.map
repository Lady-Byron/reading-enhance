{"version":3,"file":"forum.js","mappings":"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","sources":["webpack://@lady-byron/reading-enhance-js/webpack/bootstrap","webpack://@lady-byron/reading-enhance-js/webpack/runtime/compat get default export","webpack://@lady-byron/reading-enhance-js/webpack/runtime/define property getters","webpack://@lady-byron/reading-enhance-js/webpack/runtime/hasOwnProperty shorthand","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/app']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/states/PostStreamState']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/PostStream']\"","webpack://@lady-byron/reading-enhance-js/./src/forum/features/replyJumpInterceptor.ts","webpack://@lady-byron/reading-enhance-js/./src/forum/features/readingShortcuts.ts","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['common/extend']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/DiscussionPage']\"","webpack://@lady-byron/reading-enhance-js/./src/forum/features/readingPositionRecorder.ts","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/DiscussionListItem']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['common/components/Link']\"","webpack://@lady-byron/reading-enhance-js/./src/forum/features/discussionNavigation.ts","webpack://@lady-byron/reading-enhance-js/./src/forum/index.ts"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/states/PostStreamState'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/PostStream'];","// js/src/forum/features/replyJumpInterceptor.ts\nimport app from 'flarum/forum/app';\nimport PostStreamState from 'flarum/forum/states/PostStreamState';\nimport PostStream from 'flarum/forum/components/PostStream';\n\n/**\n * 精确令牌拦截：\n * - 仅在“提交新回复成功（POST /posts）”后，给对应讨论 did 上一次性令牌（可消费 2~3 次滚动入口）。\n * - 在 goToNumber('reply') / scrollToNumber(newNumber) / triggerScroll等入口，命中当前讨论且目标=回复/末楼时吞掉滚动。\n * - 不影响 near 跳转、点楼号、路由初始定位等其它行为。\n */\n\ntype Token = {\n  did: string | null;\n  targetNum: number | null; // 新回复的楼号（来自 POST /posts 响应）\n  left: number;             // 可吞次数（冗余入口链路下通常 2~3 次足够）\n  expiresAt: number;        // TTL，毫秒级\n};\n\nconst token: Token = {\n  did: null,\n  targetNum: null,\n  left: 0,\n  expiresAt: 0,\n};\n\nfunction now() {\n  return Date.now();\n}\nfunction activeFor(did: string | null): boolean {\n  return (\n    !!did &&\n    token.did === did &&\n    token.left > 0 &&\n    now() < token.expiresAt\n  );\n}\nfunction arm(did: string, targetNum: number | null, ttlMs = 1800, times = 3) {\n  token.did = did;\n  token.targetNum = typeof targetNum === 'number' && targetNum > 0 ? targetNum : null;\n  token.left = Math.max(1, times);\n  token.expiresAt = now() + Math.max(300, ttlMs);\n}\nfunction consume() {\n  if (token.left > 0) token.left -= 1;\n  if (token.left <= 0) {\n    token.did = null;\n    token.targetNum = null;\n    token.expiresAt = 0;\n  }\n}\n\nfunction isReplyJump(discussion: any, target: 'reply' | number | any): boolean {\n  // 仅判断“发帖后滚动到底部/新楼”的特征\n  if (!discussion) return false;\n\n  if (target === 'reply') return true;\n\n  const last: number | null =\n    typeof discussion.lastPostNumber === 'function'\n      ? discussion.lastPostNumber()\n      : discussion.attribute?.('lastPostNumber');\n\n  if (typeof target === 'number' && target > 0) {\n    // 目标是“末楼或更后”（保守 ≥）\n    if (typeof last === 'number' && last > 0 && target >= last) return true;\n    // 若有 POST 返回的确切新楼号，用它作判定更稳\n    if (token.targetNum && target >= token.targetNum) return true;\n  }\n\n  return false;\n}\n\nfunction installRequestHook() {\n  // 只包一次\n  if ((app as any).__lbReqHooked) return;\n  (app as any).__lbReqHooked = true;\n\n  const orig = app.request.bind(app);\n\n  app.request = function (opts: any) {\n    const p = orig(opts);\n    try {\n      const method = String(opts?.method || '').toUpperCase();\n      const url = String(opts?.url || '');\n      const isCreatePost =\n        method === 'POST' &&\n        /\\/posts(?:\\?|$|\\/)/.test(url); // .../api/posts\n\n      if (!isCreatePost) return p;\n\n      return p.then((res: any) => {\n        // 解析 discussionId 与新楼号\n        const did =\n          res?.data?.relationships?.discussion?.data?.id ??\n          res?.data?.attributes?.discussionId ??\n          null;\n        const num: number | null =\n          typeof res?.data?.attributes?.number === 'number'\n            ? res.data.attributes.number\n            : null;\n\n        if (did) {\n          arm(String(did), num, 1800, 3);\n        }\n        return res;\n      });\n    } catch {\n      // 出错不影响请求链路\n      return p;\n    }\n  };\n}\n\nfunction installScrollGuards() {\n  // --- goToNumber(entry)：最早的定位入口 ---\n  const goToOrig = (PostStreamState as any).prototype.goToNumber;\n  (PostStreamState as any).prototype.goToNumber = function (target: any, ...rest: any[]) {\n    try {\n      const discussion = (this as any)?.discussion;\n      const did =\n        discussion?.id?.() ??\n        (typeof discussion?.id === 'function' ? discussion.id() : null);\n\n      if (activeFor(did) && isReplyJump(discussion, target)) {\n        consume();\n        return; // 吞掉这一次“发帖后自动滚动”\n      }\n    } catch {}\n    return goToOrig.apply(this, [target, ...rest]);\n  };\n\n  // --- PostStream.prototype.triggerScroll：滚动触发（适配不同核心版本） ---\n  const psProto: any = (PostStream as any).prototype;\n\n  if (typeof psProto.triggerScroll === 'function') {\n    const trigOrig = psProto.triggerScroll;\n    psProto.triggerScroll = function (...args: any[]) {\n      try {\n        const state = this?.attrs?.state;\n        const discussion = state?.discussion;\n        const did =\n          discussion?.id?.() ??\n          (typeof discussion?.id === 'function' ? discussion.id() : null);\n        const target =\n          state?.targetPostNumber ??\n          state?.index ??\n          (state?.visible && state.visible.number) ??\n          null;\n\n        if (activeFor(did) && isReplyJump(discussion, target)) {\n          consume();\n          return;\n        }\n      } catch {}\n      return trigOrig.apply(this, args);\n    };\n  }\n\n  // --- PostStream.prototype.scrollToNumber：另一实现路径 ---\n  if (typeof psProto.scrollToNumber === 'function') {\n    const toNumOrig = psProto.scrollToNumber;\n    psProto.scrollToNumber = function (n: number, ...rest: any[]) {\n      try {\n        const state = this?.attrs?.state;\n        const discussion = state?.discussion;\n        const did =\n          discussion?.id?.() ??\n          (typeof discussion?.id === 'function' ? discussion.id() : null);\n\n        if (activeFor(did) && isReplyJump(discussion, n)) {\n          consume();\n          return;\n        }\n      } catch {}\n      return toNumOrig.apply(this, [n, ...rest]);\n    };\n  }\n\n  // --- PostStream.prototype.scrollToIndex：极少数路径（保守） ---\n  if (typeof psProto.scrollToIndex === 'function') {\n    const toIdxOrig = psProto.scrollToIndex;\n    psProto.scrollToIndex = function (i: number, ...rest: any[]) {\n      try {\n        const state = this?.attrs?.state;\n        const discussion = state?.discussion;\n        const did =\n          discussion?.id?.() ??\n          (typeof discussion?.id === 'function' ? discussion.id() : null);\n        const approxTarget =\n          state?.visible?.number && typeof state.visible.number === 'number'\n            ? state.visible.number\n            : i;\n\n        if (activeFor(did) && isReplyJump(discussion, approxTarget)) {\n          consume();\n          return;\n        }\n      } catch {}\n      return toIdxOrig.apply(this, [i, ...rest]);\n    };\n  }\n}\n\nexport default function installReplyJumpInterceptor() {\n  app.initializers.add('lady-byron/reading-enhance-reply-jump', () => {\n    // 1) 监听“发帖成功”\n    installRequestHook();\n\n    // 2) 拦截“仅限由发帖引发的滚动”\n    installScrollGuards();\n  });\n}\n","// js/src/forum/features/readingShortcuts.ts\nimport app from 'flarum/forum/app';\n\n/**\n * 半屏/整屏翻页快捷键（桌面端优先）\n * - Shift+D  半屏下\n * - Shift+U  半屏上\n * - Shift+J  整屏下\n * - Shift+K  整屏上\n *\n * 仅在非输入/编辑状态触发；不影响弹窗、编辑器、Composer。\n */\n\ntype Options = {\n  halfRatio: number;       // 半屏比例\n  smooth: boolean;         // 是否平滑滚动\n  headerSelector: string;  // 顶栏选择器，用于抵扣可视高度\n};\n\nconst DEFAULTS: Options = {\n  halfRatio: 0.5,\n  smooth: true,\n  headerSelector: '.App-header',\n};\n\nfunction isEditableTarget(t: EventTarget | null): boolean {\n  const el = t instanceof Element ? t : null;\n  if (!el) return false;\n\n  // 常见可编辑/输入容器\n  const editable = el.closest(\n    'input, textarea, [contenteditable=\"true\"], .TextEditor, .CodeMirror, .ProseMirror, .Composer, .Modal'\n  );\n  // Composer 打开时整体禁用\n  const composerOpen = !!(app as any)?.composer?.isVisible?.();\n\n  return !!editable || composerOpen;\n}\n\nfunction headerOffsetPx(sel: string): number {\n  try {\n    const h = document.querySelector(sel);\n    return h ? h.getBoundingClientRect().height : 0;\n  } catch {\n    return 0;\n  }\n}\n\nfunction scrollByAmount(px: number, smooth: boolean) {\n  if ('scrollBy' in window) {\n    window.scrollBy({ top: px, left: 0, behavior: smooth ? 'smooth' : 'auto' });\n  } else {\n    const sc = document.scrollingElement || document.documentElement || document.body;\n    sc.scrollTop += px;\n  }\n}\n\nfunction keySig(e: KeyboardEvent): string {\n  // 只关心 Shift + 字母，不处理 Ctrl/Meta/Alt，避免系统/浏览器冲突\n  if (e.ctrlKey || e.metaKey || e.altKey) return '';\n  const parts: string[] = [];\n  if (e.shiftKey) parts.push('Shift');\n  const k = e.key.length === 1 ? e.key.toUpperCase() : e.key;\n  parts.push(k);\n  return parts.join('+');\n}\n\nexport default function installReadingShortcuts(opts?: Partial<Options>) {\n  const options: Options = Object.assign({}, DEFAULTS, opts || {});\n  let attached = false;\n\n  app.initializers.add('lady-byron/reading-enhance-shortcuts', () => {\n    if (attached) return;\n    attached = true;\n\n    const onKeydown = (e: KeyboardEvent) => {\n      // 在输入/编辑/弹窗内不触发；忽略按住不放的连发\n      if (isEditableTarget(e.target) || e.repeat) return;\n\n      const sig = keySig(e);\n      if (!sig) return;\n\n      const offset = headerOffsetPx(options.headerSelector);\n      const vh = window.innerHeight || 0;\n\n      switch (sig) {\n        case 'Shift+D': {\n          e.preventDefault(); e.stopPropagation();\n          const delta = Math.max(1, Math.round(vh * options.halfRatio) - Math.round(offset / 2));\n          scrollByAmount(delta, options.smooth);\n          break;\n        }\n        case 'Shift+U': {\n          e.preventDefault(); e.stopPropagation();\n          const delta = Math.max(1, Math.round(vh * options.halfRatio) - Math.round(offset / 2));\n          scrollByAmount(-delta, options.smooth);\n          break;\n        }\n        case 'Shift+J': {\n          e.preventDefault(); e.stopPropagation();\n          scrollByAmount(vh, options.smooth);\n          break;\n        }\n        case 'Shift+K': {\n          e.preventDefault(); e.stopPropagation();\n          scrollByAmount(-vh, options.smooth);\n          break;\n        }\n        default:\n          // 其它组合不处理\n          break;\n      }\n    };\n\n    // 捕获阶段优先处理，但不干扰其它键位\n    window.addEventListener('keydown', onKeydown, true);\n\n    // 若未来需要卸载，可暴露到全局（调试用）\n    (window as any).__lb_shortcuts = {\n      detach() {\n        window.removeEventListener('keydown', onKeydown, true);\n      },\n    };\n  });\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionPage'];","// js/src/forum/features/readingPositionRecorder.ts\nimport app from 'flarum/forum/app';\nimport { override } from 'flarum/common/extend';\nimport DiscussionPage from 'flarum/forum/components/DiscussionPage';\nimport PostStream from 'flarum/forum/components/PostStream';\n\n/**\n * 从 Flarum 提供的 onPositionChange 参数中提取楼层号\n * - 优先 number / postNumber / near\n * - 其次 visible.number\n */\nfunction derivePostNumberFromPositionChangeArgs(args: any[]): number | null {\n  for (const a of args) {\n    if (a == null) continue;\n\n    if (typeof a === 'number') {\n      if (a > 0) return a;\n    } else if (typeof a === 'object') {\n      const anyA = a as any;\n\n      if (typeof anyA.number === 'number' && anyA.number > 0) return anyA.number;\n      if (typeof anyA.postNumber === 'number' && anyA.postNumber > 0) return anyA.postNumber;\n      if (typeof anyA.near === 'number' && anyA.near > 0) return anyA.near;\n\n      if (\n        anyA.visible &&\n        typeof anyA.visible.number === 'number' &&\n        anyA.visible.number > 0\n      ) {\n        return anyA.visible.number as number;\n      }\n    }\n  }\n\n  return null;\n}\n\n/**\n * 兜底：从当前 URL 的 /d/:id/:near 或 ?near= 中提取楼层号\n */\nfunction extractNearFromUrl(): number | null {\n  try {\n    const url = new URL(window.location.href);\n\n    // /d/:id/:near\n    const parts = url.pathname.split('/').filter(Boolean);\n    const dIndex = parts.indexOf('d');\n    if (dIndex !== -1 && parts.length > dIndex + 2) {\n      const maybeNear = parseInt(parts[dIndex + 2], 10);\n      if (!Number.isNaN(maybeNear) && maybeNear > 0) return maybeNear;\n    }\n\n    // ?near=数字\n    const qNear = parseInt(url.searchParams.get('near') || '', 10);\n    if (!Number.isNaN(qNear) && qNear > 0) return qNear;\n  } catch {\n    // 忽略 URL 解析错误\n  }\n\n  return null;\n}\n\n/**\n * 写库（lb_read_post_number；静默失败即可）\n */\nfunction savePosition(discussionId: string, postNumber: number) {\n  return app\n    .request({\n      method: 'POST',\n      url: `${app.forum.attribute('apiUrl')}/ladybyron/reading-position`,\n      body: { discussionId, postNumber },\n    })\n    .catch(() => {\n      // 静默失败，不影响前端体验\n    });\n}\n\n/**\n * 200ms 轻节流 + 去重（按讨论维度）\n */\n\nconst DEBOUNCE_MS = 200;\n\nconst pendingTimerByDiscussion: Record<string, number> = Object.create(null);\nconst pendingCandidateByDiscussion: Record<string, number> = Object.create(null);\nconst lastCommittedByDiscussion: Record<string, number> = Object.create(null);\n\nfunction scheduleSaveBidirectional(discussion: any, candidate: number) {\n  const id: string = discussion.id?.() ?? discussion.id;\n  if (!id) return;\n\n  // 同一讨论内，如果 candidate 没变，就不重复 schedule\n  if (pendingCandidateByDiscussion[id] === candidate) return;\n\n  pendingCandidateByDiscussion[id] = candidate;\n\n  if (pendingTimerByDiscussion[id]) {\n    window.clearTimeout(pendingTimerByDiscussion[id]);\n  }\n\n  pendingTimerByDiscussion[id] = window.setTimeout(() => {\n    const toSend = pendingCandidateByDiscussion[id];\n    if (typeof toSend !== 'number' || toSend <= 0) return;\n\n    const current = discussion.attribute?.('lbReadingPosition') ?? 0;\n    const lastCommitted = lastCommittedByDiscussion[id] ?? current;\n\n    // 和当前记录、上一次成功写入都相同的话，就不写了\n    if (toSend === current || toSend === lastCommitted) return;\n\n    savePosition(id, toSend).then(() => {\n      lastCommittedByDiscussion[id] = toSend;\n\n      // 本地模型同步一份，方便导航增强使用\n      if (discussion.attribute && discussion.attribute('lbReadingPosition') !== toSend) {\n        discussion.pushAttributes({ lbReadingPosition: toSend });\n      }\n    });\n  }, DEBOUNCE_MS);\n}\n\nlet installed = false;\n\nexport default function installReadingPositionRecorder() {\n  if (installed) return;\n  installed = true;\n\n  app.initializers.add('lady-byron/reading-enhance-recorder', () => {\n    // 覆写 DiscussionPage.view，在 VDOM 树里找到 PostStream，挂钩 onPositionChange\n    override(DiscussionPage.prototype, 'view', function (original: any, ...args: any[]) {\n      const vdom = original(...args);\n\n      const inject = (node: any) => {\n        if (!node) return;\n\n        if (Array.isArray(node)) {\n          node.forEach(inject);\n          return;\n        }\n\n        if (node.children) inject(node.children);\n\n        if (node.tag === PostStream) {\n          node.attrs = node.attrs || {};\n          const prev = node.attrs.onPositionChange;\n\n          node.attrs.onPositionChange = (...cbArgs: any[]) => {\n            // 先让原有回调跑一遍\n            if (typeof prev === 'function') prev(...cbArgs);\n\n            // 未登录用户无需记录阅读进度\n            if (!app.session.user) return;\n\n            const dp = this as any;\n            const discussion = dp?.discussion;\n            if (!discussion) return;\n\n            // 1) 首选：从 Flarum 提供的 onPositionChange 参数里直接拿楼层号\n            let n = derivePostNumberFromPositionChangeArgs(cbArgs);\n\n            // 2) 兜底：偶发情况下从 URL 的 :near / ?near 读一次\n            if (!n) n = extractNearFromUrl();\n\n            if (n && typeof n === 'number' && n > 0) {\n              scheduleSaveBidirectional(discussion, n);\n            }\n          };\n        }\n      };\n\n      inject(vdom);\n      return vdom;\n    });\n  });\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionListItem'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/components/Link'];","// js/src/forum/features/discussionNavigation.ts\nimport app from 'flarum/forum/app';\nimport { extend } from 'flarum/common/extend';\nimport DiscussionListItem from 'flarum/forum/components/DiscussionListItem';\nimport Link from 'flarum/common/components/Link';\n\n/** ---- v17 blog 路由判定（与你现有实现一致） ---- */\n// @ts-ignore\ndeclare const flarum: any;\n\nfunction shouldRedirectDiscussionToBlog(discussion: any): boolean {\n  try {\n    // flarum.extensions 由内核注入到 window 作用域\n    // @ts-ignore\n    if (!flarum || !('v17development-blog' in flarum.extensions)) return false;\n  } catch {\n    return false;\n  }\n\n  const redirects = app.forum.attribute('blogRedirectsEnabled');\n  const discussionRedirectEnabled =\n    redirects === 'both' || redirects === 'discussions_only';\n\n  const tags = discussion.tags?.() || [];\n  if (!discussionRedirectEnabled || tags.length === 0) return false;\n\n  const blogTags = app.forum.attribute<string[]>('blogTags') || [];\n\n  return tags.some((tag: any) => {\n    if (!tag) return false;\n    const parent = tag.parent?.() || null;\n    return (\n      blogTags.indexOf(tag.id?.()!) !== -1 ||\n      (parent && blogTags.indexOf(parent.id?.()!) !== -1)\n    );\n  });\n}\n\n/** ---- URL 工具 ---- */\nfunction sameOrigin(u: URL): boolean {\n  try {\n    const base = new URL(app.forum.attribute('baseUrl'));\n    return u.origin === base.origin;\n  } catch {\n    return false;\n  }\n}\n\nfunction parseDiscussionIdFromUrl(u: URL): string | null {\n  const parts = u.pathname.split('/').filter(Boolean);\n  const dIndex = parts.indexOf('d');\n  if (dIndex === -1 || parts.length <= dIndex + 1) return null;\n  const idPart = parts[dIndex + 1];\n  const match = /^(\\d+)/.exec(idPart);\n  return match ? match[1] : null;\n}\n\n/** 显式 near 识别：数字 | 'first' | 'last' | #p123 | #reply/#last/#first */\nfunction hasExplicitNear(u: URL): number | 'first' | 'last' | null {\n  const parts = u.pathname.split('/').filter(Boolean);\n  const dIndex = parts.indexOf('d');\n\n  // /d/:id/:near（数字）\n  if (dIndex !== -1 && parts.length > dIndex + 2) {\n    const n = parseInt(parts[dIndex + 2], 10);\n    if (!Number.isNaN(n) && n > 0) return n; // near=1 也视为显式\n  }\n\n  // ?near=（数字 | first | last）\n  const nearRaw = u.searchParams.get('near');\n  if (nearRaw) {\n    const n = parseInt(nearRaw, 10);\n    if (!Number.isNaN(n) && n > 0) return n;\n    const s = nearRaw.toLowerCase();\n    if (s === 'first') return 'first';\n    if (s === 'last') return 'last';\n  }\n\n  // 锚点：#p123 / #reply / #last / #first\n  if (u.hash) {\n    const h = u.hash.toLowerCase();\n    if (/^#p\\d+$/.test(h)) return parseInt(h.slice(2), 10);\n    if (h === '#reply' || h === '#last') return 'last';\n    if (h === '#first') return 'first';\n  }\n  return null;\n}\n\n/** 从前端 store 读取 near（lbReadingPosition > lastReadPostNumber > null） */\nfunction nearFromStore(id: string): number | null {\n  const d = app.store.getById('discussions', id);\n  if (!d) return null;\n\n  const lb =\n    typeof d.attribute === 'function'\n      ? d.attribute('lbReadingPosition')\n      : (d as any).lbReadingPosition;\n\n  const last =\n    typeof d.lastReadPostNumber === 'function'\n      ? d.lastReadPostNumber()\n      : typeof d.attribute === 'function'\n      ? d.attribute('lastReadPostNumber')\n      : null;\n\n  const lbNum = typeof lb === 'number' ? lb : null;\n  const lastNum = typeof last === 'number' ? last : null;\n\n  return lbNum && lbNum > 1\n    ? lbNum\n    : lastNum && lastNum > 1\n    ? lastNum\n    : null;\n}\n\n/** 把 /d/:id[/slug] 改成 /d/:id[/slug]/:near（移除 ?near，去掉 #p123） */\nfunction buildNearUrl(u: URL, near: number): string {\n  const parts = u.pathname.split('/').filter(Boolean);\n  const dIndex = parts.indexOf('d');\n  if (dIndex === -1 || parts.length <= dIndex + 1) return u.pathname + u.search + u.hash;\n\n  const prefix = '/' + parts.slice(0, dIndex + 2).join('/');\n  u.pathname = `${prefix}/${near}`;\n  u.searchParams.delete('near');\n  if (u.hash && /^#p\\d+$/i.test(u.hash)) u.hash = '';\n\n  return u.pathname + u.search + u.hash;\n}\n\n/** 从事件 target 向上寻找 <a> */\nfunction findAnchor(target: EventTarget | null): HTMLAnchorElement | null {\n  let el = target as HTMLElement | null;\n  while (el && el !== document.body) {\n    if (el instanceof HTMLAnchorElement) return el;\n    el = el.parentElement;\n  }\n  return null;\n}\n\n/** Scrubber 相关元素：完全放行 */\nconst SCRUBBER_SKIP = '.PostStreamScrubber, .Scrubber, .item-scrubber, .PostStream-scrubber';\n\nlet attached = false;\n\nexport default function installDiscussionNavigation() {\n  if (attached) return;\n  attached = true;\n\n  app.initializers.add('lady-byron/reading-enhance-navigation', () => {\n    /** 1) 列表项改写（保留 v17 blog 支持 & 搜索页特例） */\n    extend(DiscussionListItem.prototype, 'view', function (vdom: any) {\n      // 搜索页（params.q）不改写，保留“最相关”体验\n      if ((this as any).attrs?.params?.q) return;\n\n      const discussion = (this as any).attrs?.discussion;\n      if (!discussion) return;\n\n      const recorded: number | null = discussion.attribute('lbReadingPosition') ?? null;\n      if (!recorded || recorded <= 1) return;\n\n      (vdom.children as any[]).forEach((child: any) => {\n        if (\n          !child ||\n          !child.attrs ||\n          !child.attrs.className ||\n          child.attrs.className.indexOf('DiscussionListItem-content') === -1\n        ) {\n          return;\n        }\n\n        (child.children as any[]).forEach((sub: any) => {\n          if (!sub || sub.tag !== Link) return;\n\n          let href: string;\n\n          if (shouldRedirectDiscussionToBlog(discussion)) {\n            href =\n              recorded > 1\n                ? app.route('blogArticle.near', { id: discussion.slug(), near: recorded })\n                : app.route('blogArticle', { id: discussion.slug() });\n          } else {\n            href = app.route.discussion(discussion, recorded);\n          }\n\n          sub.attrs = sub.attrs || {};\n          sub.attrs.href = href;\n          sub.attrs['data-lbRewritten'] = '1';\n        });\n      });\n    });\n\n    /** 2) Link.view 级别的通用 near 注入（不打 API） */\n    extend(Link.prototype as any, 'view', function (vdom: any) {\n      const attrs = vdom.attrs || {};\n      if (attrs['data-lbRewritten']) return;\n\n      const href: string | undefined = attrs.href;\n      if (typeof href !== 'string' || !href.trim()) return;\n\n      let u: URL;\n      try {\n        u = new URL(href, app.forum.attribute('baseUrl'));\n      } catch {\n        return;\n      }\n\n      if (!sameOrigin(u)) return;\n\n      const explicit = hasExplicitNear(u);\n      if (explicit) return;\n\n      const id = parseDiscussionIdFromUrl(u);\n      if (!id) return;\n\n      const near = nearFromStore(id);\n      if (!near || near <= 1) return;\n\n      const target = buildNearUrl(u, near);\n      vdom.attrs.href = target;\n      vdom.attrs['data-lbRewritten'] = '1';\n    });\n\n    /** 3) 兜底补丁：程序化 m.route.set('/d/:id[..]') 时补一个 near */\n    // @ts-ignore\n    const oldSet = m.route.set.bind(m.route);\n    // @ts-ignore\n    m.route.set = function (path: string, data?: any, options?: any) {\n      try {\n        if (typeof path === 'string') {\n          const url = new URL(path, window.location.origin);\n          const parts = url.pathname.split('/').filter(Boolean);\n          const dIndex = parts.indexOf('d');\n\n          if (dIndex !== -1 && parts.length > dIndex + 1) {\n            const hasNearPath =\n              parts.length > dIndex + 2 && /^\\d+$/.test(parts[dIndex + 2]);\n            const hasNearQuery = url.searchParams.has('near'); // near=first/last 也算显式\n\n            if (!hasNearPath && !hasNearQuery) {\n              const idPart = parts[dIndex + 1];\n              const idMatch = /^(\\d+)/.exec(idPart);\n              const id = idMatch ? idMatch[1] : null;\n\n              if (id) {\n                const near = nearFromStore(id);\n                if (near && near > 1) {\n                  const prefix = '/' + parts.slice(0, dIndex + 2).join('/');\n                  url.pathname = `${prefix}/${near}`;\n                  url.searchParams.delete('near');\n                  path = url.pathname + url.search + url.hash;\n                }\n              }\n            }\n          }\n        }\n      } catch {}\n\n      // @ts-ignore\n      return oldSet(path, data, options);\n    };\n\n    /** 4) DOM 级兜底：点击任意 <a> 时，只改 href，不阻断，覆盖导航栏/组件内帖子 */\n    const onDocumentClick = (e: MouseEvent) => {\n      // 已经被别的 handler 阻止的，就不碰\n      if (e.defaultPrevented) return;\n\n      // 只处理左键单击，不处理中键/右键及组合键（避免破坏“新标签页”行为）\n      if (e.button !== 0) return;\n      if (e.metaKey || e.ctrlKey || e.altKey) return;\n\n      const a = findAnchor(e.target);\n      if (!a) return;\n\n      // Scrubber / 楼层滑条相关链接：完全放行\n      if (a.matches('.Scrubber-first, .Scrubber-last') || a.closest(SCRUBBER_SKIP)) {\n        return;\n      }\n\n      const hrefAttr = a.getAttribute('href');\n      if (!hrefAttr || !hrefAttr.trim()) return;\n\n      let u: URL;\n      try {\n        u = new URL(a.href, window.location.href);\n      } catch {\n        return;\n      }\n\n      if (!sameOrigin(u)) return;\n\n      const explicit = hasExplicitNear(u);\n      if (explicit) return;\n\n      const id = parseDiscussionIdFromUrl(u);\n      if (!id) return;\n\n      const near = nearFromStore(id);\n      if (!near || near <= 1) return;\n\n      const target = buildNearUrl(u, near);\n\n      // 只修改 href，不 preventDefault；后续由 Flarum 或浏览器按新的 href 导航\n      if (a.href !== target) {\n        a.href = target;\n        a.dataset.lbRewritten = '1';\n      }\n    };\n\n    document.addEventListener('click', onDocumentClick, true);\n\n    // 调试/卸载用\n    (window as any).__lb_reading_nav = {\n      detach() {\n        document.removeEventListener('click', onDocumentClick, true);\n      },\n    };\n  });\n}\n","// js/src/forum/index.ts\nimport installReplyJumpInterceptor from './features/replyJumpInterceptor';\nimport installReadingShortcuts from './features/readingShortcuts';\nimport installReadingPositionRecorder from './features/readingPositionRecorder';\nimport installDiscussionNavigation from './features/discussionNavigation';\n\n// 纯入口：只负责注册各模块的 initializer\ninstallReplyJumpInterceptor();\ninstallReadingShortcuts();\ninstallReadingPositionRecorder();\ninstallDiscussionNavigation();\n"],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","flarum","core","compat","token","did","targetNum","left","expiresAt","now","Date","activeFor","consume","isReplyJump","discussion","target","last","lastPostNumber","attribute","DEFAULTS","halfRatio","smooth","headerSelector","scrollByAmount","px","window","scrollBy","top","behavior","document","scrollingElement","documentElement","body","scrollTop","pendingTimerByDiscussion","create","pendingCandidateByDiscussion","lastCommittedByDiscussion","installed","sameOrigin","u","base","URL","app","origin","_unused2","parseDiscussionIdFromUrl","parts","pathname","split","filter","Boolean","dIndex","indexOf","length","idPart","match","exec","hasExplicitNear","n","parseInt","Number","isNaN","nearRaw","searchParams","s","toLowerCase","hash","h","test","slice","nearFromStore","id","getById","lb","lbReadingPosition","lastReadPostNumber","lbNum","lastNum","buildNearUrl","near","search","prefix","join","attached","add","orig","bind","opts","p","method","String","toUpperCase","url","then","res","_ref","_res$data$relationshi","_res$data","_res$data2","_res$data3","data","relationships","attributes","discussionId","num","number","ttlMs","times","Math","max","arm","_unused","installRequestHook","goToOrig","PostStreamState","goToNumber","_discussion$id","this","_len","arguments","rest","Array","_key","apply","concat","psProto","PostStream","triggerScroll","trigOrig","_this$attrs","_discussion$id2","_ref2","_ref3","_state$targetPostNumb","state","attrs","targetPostNumber","index","visible","_unused3","_len2","args","_key2","scrollToNumber","toNumOrig","_this$attrs2","_discussion$id3","_unused4","_len3","_key3","scrollToIndex","toIdxOrig","i","_this$attrs3","_discussion$id4","_state$visible","approxTarget","_unused5","_len4","_key4","installScrollGuards","options","assign","onKeydown","e","t","_composer","el","Element","editable","closest","composerOpen","isVisible","isEditableTarget","repeat","sig","ctrlKey","metaKey","altKey","shiftKey","push","k","keySig","offset","sel","querySelector","getBoundingClientRect","height","headerOffsetPx","vh","innerHeight","preventDefault","stopPropagation","round","addEventListener","__lb_shortcuts","detach","removeEventListener","installReadingShortcuts","override","DiscussionPage","original","_this","vdom","inject","node","isArray","forEach","children","tag","prev","onPositionChange","cbArgs","user","_step","_iterator","_createForOfIteratorHelperLoose","done","value","anyA","postNumber","derivePostNumberFromPositionChangeArgs","location","href","maybeNear","qNear","extractNearFromUrl","candidate","clearTimeout","setTimeout","_discussion$attribute","_lastCommittedByDiscu","toSend","current","lastCommitted","pushAttributes","scheduleSaveBidirectional","extend","DiscussionListItem","_attrs","_attrs2","params","q","recorded","child","className","sub","Link","extensions","redirects","discussionRedirectEnabled","tags","blogTags","some","parent","shouldRedirectDiscussionToBlog","slug","trim","oldSet","m","route","set","path","hasNearPath","hasNearQuery","has","idMatch","onDocumentClick","defaultPrevented","button","HTMLAnchorElement","parentElement","findAnchor","matches","hrefAttr","getAttribute","dataset","lbRewritten","__lb_reading_nav"],"ignoreList":[],"sourceRoot":""}