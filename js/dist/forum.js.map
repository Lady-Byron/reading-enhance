{"version":3,"file":"forum.js","mappings":"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","sources":["webpack://@lady-byron/reading-enhance-js/webpack/bootstrap","webpack://@lady-byron/reading-enhance-js/webpack/runtime/compat get default export","webpack://@lady-byron/reading-enhance-js/webpack/runtime/define property getters","webpack://@lady-byron/reading-enhance-js/webpack/runtime/hasOwnProperty shorthand","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/app']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['common/extend']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/states/PostStreamState']\"","webpack://@lady-byron/reading-enhance-js/./src/forum/features/replyJumpInterceptor.ts","webpack://@lady-byron/reading-enhance-js/./src/forum/features/readingShortcuts.ts","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/DiscussionPage']\"","webpack://@lady-byron/reading-enhance-js/./src/forum/features/readingPositionRecorder.ts","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/DiscussionListItem']\"","webpack://@lady-byron/reading-enhance-js/./src/forum/features/discussionNavigation.ts"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/states/PostStreamState'];","// js/src/forum/features/replyJumpInterceptor.ts\nimport app from 'flarum/forum/app';\nimport { override } from 'flarum/common/extend';\nimport PostStreamState from 'flarum/forum/states/PostStreamState';\n\n/**\n * 精确令牌拦截：\n * - 仅在\"提交新回复成功（POST /api/posts）\"后，给对应讨论发一次性令牌。\n * - 在 goToNumber 入口（调用链顶端）命中当前讨论且目标=回复/末楼时吞掉滚动。\n * - 不影响 near 跳转、点楼号、路由初始定位等其它行为。\n *\n * 精简方案：\n * - 原来补丁 5 处（app.request + goToNumber + triggerScroll + scrollToNumber + scrollToIndex）\n * - 现在只需 2 处（app.request + override goToNumber），\n *   因为 goToNumber 是 ReplyComposer 成功后调用的唯一入口，下游方法由它触发。\n * - 使用 Flarum 标准 override 而非手动原型替换，正确参与扩展调用链。\n */\n\ntype Token = {\n  did: string | null;\n  targetNum: number | null;\n  left: number;\n  expiresAt: number;\n};\n\nconst token: Token = {\n  did: null,\n  targetNum: null,\n  left: 0,\n  expiresAt: 0,\n};\n\nfunction activeFor(did: string | null): boolean {\n  return (\n    !!did &&\n    token.did === did &&\n    token.left > 0 &&\n    Date.now() < token.expiresAt\n  );\n}\n\nfunction arm(did: string, targetNum: number | null, ttlMs = 1800, times = 3) {\n  token.did = did;\n  token.targetNum = typeof targetNum === 'number' && targetNum > 0 ? targetNum : null;\n  token.left = Math.max(1, times);\n  token.expiresAt = Date.now() + Math.max(300, ttlMs);\n}\n\nfunction consume() {\n  if (token.left > 0) token.left -= 1;\n  if (token.left <= 0) {\n    token.did = null;\n    token.targetNum = null;\n    token.expiresAt = 0;\n  }\n}\n\nfunction isReplyJump(discussion: any, target: any): boolean {\n  if (!discussion) return false;\n  if (target === 'reply') return true;\n\n  const last: number | null =\n    typeof discussion.lastPostNumber === 'function'\n      ? discussion.lastPostNumber()\n      : discussion.attribute?.('lastPostNumber');\n\n  if (typeof target === 'number' && target > 0) {\n    if (typeof last === 'number' && last > 0 && target >= last) return true;\n    if (token.targetNum && target >= token.targetNum) return true;\n  }\n\n  return false;\n}\n\nfunction installRequestHook() {\n  if ((app as any).__lbReqHooked) return;\n  (app as any).__lbReqHooked = true;\n\n  const orig = app.request.bind(app);\n\n  app.request = function (opts: any) {\n    const p = orig(opts);\n    try {\n      const method = String(opts?.method || '').toUpperCase();\n      const url = String(opts?.url || '');\n      // #5: 收紧正则，只匹配 Flarum 标准的 POST /api/posts 接口\n      if (method !== 'POST' || !/\\/api\\/posts(?:\\?|$)/.test(url)) return p;\n\n      return p.then((res: any) => {\n        const did =\n          res?.data?.relationships?.discussion?.data?.id ??\n          res?.data?.attributes?.discussionId ??\n          null;\n        const num: number | null =\n          typeof res?.data?.attributes?.number === 'number'\n            ? res.data.attributes.number\n            : null;\n\n        if (did) {\n          arm(String(did), num, 1800, 3);\n        }\n        return res;\n      });\n    } catch {\n      return p;\n    }\n  };\n}\n\nexport default function installReplyJumpInterceptor() {\n  app.initializers.add('lady-byron/reading-enhance-reply-jump', () => {\n    // 1) 监听\"发帖成功\"\n    installRequestHook();\n\n    // 2) 使用 Flarum 标准 override 拦截调用链顶端\n    // override 回调签名: (original, ...originalArgs)\n    override(PostStreamState.prototype, 'goToNumber', function (original: any, target: any, ...rest: any[]) {\n      try {\n        const discussion = (this as any).discussion;\n        const did =\n          typeof discussion?.id === 'function'\n            ? discussion.id()\n            : discussion?.id;\n\n        if (activeFor(did) && isReplyJump(discussion, target)) {\n          consume();\n          return;\n        }\n      } catch {\n        // 出错不影响原始行为\n      }\n      return original(target, ...rest);\n    });\n  });\n}\n","// js/src/forum/features/readingShortcuts.ts\nimport app from 'flarum/forum/app';\n\n/**\n * 半屏/整屏翻页快捷键（桌面端优先）\n * - Shift+D  半屏下\n * - Shift+U  半屏上\n * - Shift+J  整屏下\n * - Shift+K  整屏上\n *\n * 仅在非输入/编辑状态触发；不影响弹窗、编辑器、Composer。\n */\n\ntype Options = {\n  halfRatio: number;       // 半屏比例\n  smooth: boolean;         // 是否平滑滚动\n  headerSelector: string;  // 顶栏选择器，用于抵扣可视高度\n};\n\nconst DEFAULTS: Options = {\n  halfRatio: 0.5,\n  smooth: true,\n  headerSelector: '.App-header',\n};\n\nfunction isEditableTarget(t: EventTarget | null): boolean {\n  const el = t instanceof Element ? t : null;\n  if (!el) return false;\n\n  // 常见可编辑/输入容器\n  const editable = el.closest(\n    'input, textarea, [contenteditable=\"true\"], .TextEditor, .CodeMirror, .ProseMirror, .Composer, .Modal'\n  );\n  // Composer 打开时整体禁用\n  const composerOpen = !!(app as any)?.composer?.isVisible?.();\n\n  return !!editable || composerOpen;\n}\n\nfunction headerOffsetPx(sel: string): number {\n  try {\n    const h = document.querySelector(sel);\n    return h ? h.getBoundingClientRect().height : 0;\n  } catch {\n    return 0;\n  }\n}\n\nfunction scrollByAmount(px: number, smooth: boolean) {\n  if ('scrollBy' in window) {\n    window.scrollBy({ top: px, left: 0, behavior: smooth ? 'smooth' : 'auto' });\n  } else {\n    const sc = document.scrollingElement || document.documentElement || document.body;\n    sc.scrollTop += px;\n  }\n}\n\nfunction keySig(e: KeyboardEvent): string {\n  // 只关心 Shift + 字母，不处理 Ctrl/Meta/Alt，避免系统/浏览器冲突\n  if (e.ctrlKey || e.metaKey || e.altKey) return '';\n  const parts: string[] = [];\n  if (e.shiftKey) parts.push('Shift');\n  const k = e.key.length === 1 ? e.key.toUpperCase() : e.key;\n  parts.push(k);\n  return parts.join('+');\n}\n\nexport default function installReadingShortcuts(opts?: Partial<Options>) {\n  const options: Options = Object.assign({}, DEFAULTS, opts || {});\n  let attached = false;\n\n  app.initializers.add('lady-byron/reading-enhance-shortcuts', () => {\n    if (attached) return;\n    attached = true;\n\n    const onKeydown = (e: KeyboardEvent) => {\n      // 在输入/编辑/弹窗内不触发；忽略按住不放的连发\n      if (isEditableTarget(e.target) || e.repeat) return;\n\n      const sig = keySig(e);\n      if (!sig) return;\n\n      const offset = headerOffsetPx(options.headerSelector);\n      const vh = window.innerHeight || 0;\n\n      switch (sig) {\n        case 'Shift+D': {\n          e.preventDefault(); e.stopPropagation();\n          const delta = Math.max(1, Math.round(vh * options.halfRatio) - Math.round(offset / 2));\n          scrollByAmount(delta, options.smooth);\n          break;\n        }\n        case 'Shift+U': {\n          e.preventDefault(); e.stopPropagation();\n          const delta = Math.max(1, Math.round(vh * options.halfRatio) - Math.round(offset / 2));\n          scrollByAmount(-delta, options.smooth);\n          break;\n        }\n        case 'Shift+J': {\n          e.preventDefault(); e.stopPropagation();\n          // #2: 与 Shift+D/U 保持一致，扣除固定 header 高度，避免内容被遮挡\n          const downDelta = Math.max(1, vh - offset);\n          scrollByAmount(downDelta, options.smooth);\n          break;\n        }\n        case 'Shift+K': {\n          e.preventDefault(); e.stopPropagation();\n          const upDelta = Math.max(1, vh - offset);\n          scrollByAmount(-upDelta, options.smooth);\n          break;\n        }\n        default:\n          // 其它组合不处理\n          break;\n      }\n    };\n\n    // 捕获阶段优先处理，但不干扰其它键位\n    window.addEventListener('keydown', onKeydown, true);\n\n    // 若未来需要卸载，可暴露到全局（调试用）\n    (window as any).__lb_shortcuts = {\n      detach() {\n        window.removeEventListener('keydown', onKeydown, true);\n      },\n    };\n  });\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionPage'];","// js/src/forum/features/readingPositionRecorder.ts\nimport app from 'flarum/forum/app';\nimport { extend } from 'flarum/common/extend';\nimport DiscussionPage from 'flarum/forum/components/DiscussionPage';\n\n/**\n * 写库（lb_read_post_number；静默失败即可）\n */\nfunction savePosition(discussionId: string, postNumber: number) {\n  return app\n    .request({\n      method: 'POST',\n      url: `${app.forum.attribute('apiUrl')}/ladybyron/reading-position`,\n      body: { discussionId, postNumber },\n    })\n    .catch(() => {\n      // 静默失败，不影响前端体验\n    });\n}\n\n/**\n * 200ms 轻节流 + 去重（按讨论维度）\n * #10: 增加 LRU 上限，防止长时间标签页内存泄漏\n */\n\nconst DEBOUNCE_MS = 200;\nconst MAX_TRACKED = 50;\n\nconst pendingTimerByDiscussion: Record<string, number> = Object.create(null);\nconst pendingCandidateByDiscussion: Record<string, number> = Object.create(null);\nconst lastCommittedByDiscussion: Record<string, number> = Object.create(null);\nconst accessOrder: string[] = [];\n\nfunction touchLru(id: string) {\n  const idx = accessOrder.indexOf(id);\n  if (idx !== -1) accessOrder.splice(idx, 1);\n  accessOrder.push(id);\n\n  while (accessOrder.length > MAX_TRACKED) {\n    const evict = accessOrder.shift()!;\n    if (pendingTimerByDiscussion[evict]) {\n      window.clearTimeout(pendingTimerByDiscussion[evict]);\n    }\n    delete pendingTimerByDiscussion[evict];\n    delete pendingCandidateByDiscussion[evict];\n    delete lastCommittedByDiscussion[evict];\n  }\n}\n\nfunction scheduleSave(discussion: any, candidate: number) {\n  const id: string = discussion.id?.() ?? discussion.id;\n  if (!id) return;\n\n  touchLru(id);\n\n  if (pendingCandidateByDiscussion[id] === candidate) return;\n\n  pendingCandidateByDiscussion[id] = candidate;\n\n  if (pendingTimerByDiscussion[id]) {\n    window.clearTimeout(pendingTimerByDiscussion[id]);\n  }\n\n  pendingTimerByDiscussion[id] = window.setTimeout(() => {\n    const toSend = pendingCandidateByDiscussion[id];\n    if (typeof toSend !== 'number' || toSend <= 0) return;\n\n    const current = discussion.attribute?.('lbReadingPosition') ?? 0;\n    const lastCommitted = lastCommittedByDiscussion[id] ?? current;\n\n    // 和当前记录、上一次成功写入都相同的话，就不写了\n    if (toSend === current || toSend === lastCommitted) return;\n\n    savePosition(id, toSend).then(() => {\n      lastCommittedByDiscussion[id] = toSend;\n\n      // 本地模型同步，方便导航增强使用\n      if (discussion.attribute && discussion.attribute('lbReadingPosition') !== toSend) {\n        discussion.pushAttributes({ lbReadingPosition: toSend });\n      }\n    });\n  }, DEBOUNCE_MS);\n}\n\nlet installed = false;\n\nexport default function installReadingPositionRecorder() {\n  if (installed) return;\n  installed = true;\n\n  app.initializers.add('lady-byron/reading-enhance-recorder', () => {\n    const DBG = true; // ← 诊断开关\n\n    if (DBG) console.debug('[lb-rec] extending DiscussionPage.positionChanged');\n\n    extend(DiscussionPage.prototype, 'positionChanged', function (_ret: void, startNumber: number) {\n      if (!app.session.user) return;\n\n      const discussion = (this as any).discussion;\n      if (!discussion) return;\n\n      if (DBG) console.debug('[lb-rec] positionChanged fired', { startNumber, discussion: discussion.id?.() });\n\n      if (typeof startNumber === 'number' && startNumber > 0) {\n        scheduleSave(discussion, startNumber);\n      }\n    });\n  });\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionListItem'];","// js/src/forum/features/discussionNavigation.ts\nimport app from 'flarum/forum/app';\nimport { override } from 'flarum/common/extend';\nimport DiscussionListItem from 'flarum/forum/components/DiscussionListItem';\n\n// @ts-ignore\ndeclare const flarum: any;\n\n/** ---- v17 blog 路由判定 ---- */\nfunction shouldRedirectDiscussionToBlog(discussion: any): boolean {\n  try {\n    if (!flarum || !('v17development-blog' in flarum.extensions)) return false;\n  } catch {\n    return false;\n  }\n\n  const redirects = app.forum.attribute('blogRedirectsEnabled');\n  const discussionRedirectEnabled =\n    redirects === 'both' || redirects === 'discussions_only';\n\n  const tags = discussion.tags?.() || [];\n  if (!discussionRedirectEnabled || tags.length === 0) return false;\n\n  const blogTags = app.forum.attribute<string[]>('blogTags') || [];\n\n  return tags.some((tag: any) => {\n    if (!tag) return false;\n    // #12: 用安全取值替代矛盾的 ?.()! 写法\n    const tagId = tag.id?.() ?? tag.id ?? null;\n    const parent = tag.parent?.() || null;\n    const parentId = parent ? (parent.id?.() ?? parent.id ?? null) : null;\n    return (\n      (tagId != null && blogTags.indexOf(tagId) !== -1) ||\n      (parentId != null && blogTags.indexOf(parentId) !== -1)\n    );\n  });\n}\n\n/**\n * #14: 提取公共 helper — 从 store 读取有效阅读位置\n * - lbReadingPosition 存在（哪怕 =1）→ 扩展已接管：>1 返回值，<=1 返回 null（从首楼开始）\n * - lbReadingPosition 不存在 → fallback 到 lastReadPostNumber (>1)\n */\nfunction effectiveNearFromStore(id: string): number | null {\n  const d = app.store.getById('discussions', id);\n  if (!d) return null;\n\n  const rawLb =\n    typeof d.attribute === 'function'\n      ? d.attribute('lbReadingPosition')\n      : (d as any).lbReadingPosition;\n\n  if (typeof rawLb === 'number') {\n    return rawLb > 1 ? rawLb : null;\n  }\n\n  const rawLast =\n    typeof d.lastReadPostNumber === 'function'\n      ? d.lastReadPostNumber()\n      : typeof d.attribute === 'function'\n      ? d.attribute('lastReadPostNumber')\n      : null;\n\n  return typeof rawLast === 'number' && rawLast > 1 ? rawLast : null;\n}\n\n// 搜索页抑制标志：在搜索列表渲染期间禁止注入 near，保持\"最相关\"语义\nlet _suppressNear = false;\n\nlet installed = false;\n\nexport default function installDiscussionNavigation() {\n  if (installed) return;\n  installed = true;\n\n  app.initializers.add('lady-byron/reading-enhance-navigation', () => {\n    const DBG = true; // ← 诊断开关，定位完毕后改为 false\n\n    // ---- 诊断：检查 app.route.discussion 是否存在 ----\n    const hasDiscussionRoute = !!(app.route as any).discussion;\n    if (DBG) {\n      console.debug('[lb-nav] init: app.route.discussion exists?', hasDiscussionRoute);\n      console.debug('[lb-nav] init: typeof app.route =', typeof app.route);\n      console.debug('[lb-nav] init: app.route keys =', Object.keys(app.route as any));\n    }\n\n    if (!hasDiscussionRoute) {\n      if (DBG) console.warn('[lb-nav] app.route.discussion NOT found — hook aborted');\n      return;\n    }\n\n    const origDiscussionRoute = (app.route as any).discussion.bind(app.route);\n    if (DBG) console.debug('[lb-nav] hook installed, origDiscussionRoute =', origDiscussionRoute);\n\n    (app.route as any).discussion = function (discussion: any, near?: number) {\n      try {\n        if (_suppressNear) {\n          return origDiscussionRoute(discussion, near);\n        }\n\n        if (!near) {\n          const id =\n            typeof discussion?.id === 'function'\n              ? discussion.id()\n              : discussion?.id;\n\n          if (id) {\n            const stored = effectiveNearFromStore(String(id));\n\n            if (DBG) {\n              console.debug('[lb-nav] route.discussion called', {\n                id,\n                nearArg: near,\n                stored,\n                discussion,\n              });\n            }\n\n            // v17 blog 兼容：需重定向到 blog 路由时生成 blogArticle.near\n            if (stored && stored > 1 && shouldRedirectDiscussionToBlog(discussion)) {\n              try {\n                const slug =\n                  typeof discussion.slug === 'function'\n                    ? discussion.slug()\n                    : discussion.slug;\n                return app.route('blogArticle.near', { id: slug, near: stored });\n              } catch {\n                // blogArticle.near 路由不存在时 fallback\n              }\n            }\n\n            if (stored) {\n              near = stored;\n            }\n          }\n        } else if (DBG) {\n          console.debug('[lb-nav] route.discussion called with explicit near', { near });\n        }\n      } catch (e) {\n        if (DBG) console.error('[lb-nav] hook error', e);\n      }\n\n      const result = origDiscussionRoute(discussion, near);\n      if (DBG) console.debug('[lb-nav] final URL =', result, '(near =', near, ')');\n      return result;\n    };\n\n    override(DiscussionListItem.prototype, 'view', function (original: any) {\n      if ((this as any).attrs?.params?.q) {\n        _suppressNear = true;\n        try {\n          return original();\n        } finally {\n          _suppressNear = false;\n        }\n      }\n      return original();\n    });\n\n    // ---- 诊断：暴露到 window 供控制台手动检查 ----\n    if (DBG) {\n      (window as any).__lbDebug = {\n        effectiveNearFromStore,\n        dumpStore() {\n          const all = app.store.all('discussions');\n          return all.map((d: any) => ({\n            id: d.id(),\n            slug: d.slug?.(),\n            lbReadingPosition: d.attribute('lbReadingPosition'),\n            lastReadPostNumber: d.lastReadPostNumber?.() ?? d.attribute('lastReadPostNumber'),\n          }));\n        },\n        testRoute(discussionId: string) {\n          const d = app.store.getById('discussions', discussionId);\n          if (!d) return 'discussion not in store';\n          return {\n            near: effectiveNearFromStore(discussionId),\n            url: origDiscussionRoute(d),\n            urlWithNear: origDiscussionRoute(d, effectiveNearFromStore(discussionId)),\n          };\n        },\n      };\n      console.debug('[lb-nav] window.__lbDebug ready — try __lbDebug.dumpStore() or __lbDebug.testRoute(\"123\")');\n    }\n  });\n}\n"],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","flarum","core","compat","token","did","targetNum","left","expiresAt","scrollByAmount","px","smooth","window","scrollBy","top","behavior","document","scrollingElement","documentElement","body","scrollTop","pendingTimerByDiscussion","create","pendingCandidateByDiscussion","lastCommittedByDiscussion","accessOrder","installed","effectiveNearFromStore","id","app","getById","rawLb","attribute","lbReadingPosition","rawLast","lastReadPostNumber","options","attached","_suppressNear","add","orig","bind","opts","p","method","String","toUpperCase","url","test","then","res","_ref","_res$data$relationshi","_res$data","_res$data2","_res$data3","data","relationships","discussion","attributes","discussionId","num","number","ttlMs","times","Math","max","Date","now","arm","_unused","installRequestHook","override","PostStreamState","original","target","this","last","lastPostNumber","isReplyJump","_unused2","_len","arguments","length","rest","Array","_key","apply","concat","assign","halfRatio","headerSelector","onKeydown","e","t","_composer","el","Element","editable","closest","composerOpen","isVisible","isEditableTarget","repeat","sig","ctrlKey","metaKey","altKey","parts","shiftKey","push","k","join","keySig","offset","sel","h","querySelector","getBoundingClientRect","height","headerOffsetPx","vh","innerHeight","preventDefault","stopPropagation","round","addEventListener","__lb_shortcuts","detach","removeEventListener","console","debug","extend","DiscussionPage","_ret","startNumber","user","candidate","_discussion$id","idx","indexOf","splice","evict","shift","clearTimeout","touchLru","setTimeout","_discussion$attribute","_lastCommittedByDiscu","toSend","postNumber","current","lastCommitted","pushAttributes","scheduleSave","hasDiscussionRoute","keys","origDiscussionRoute","near","stored","nearArg","extensions","redirects","discussionRedirectEnabled","tags","blogTags","some","tag","_tag$id","_ref2","_parent$id","tagId","parent","parentId","shouldRedirectDiscussionToBlog","slug","error","result","DiscussionListItem","_attrs","attrs","params","q","__lbDebug","dumpStore","all","map","_d$lastReadPostNumber","testRoute","urlWithNear","warn"],"ignoreList":[],"sourceRoot":""}