{"version":3,"file":"forum.js","mappings":"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","sources":["webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/DiscussionSearchResult']\"","webpack://@lady-byron/reading-enhance-js/webpack/bootstrap","webpack://@lady-byron/reading-enhance-js/webpack/runtime/compat get default export","webpack://@lady-byron/reading-enhance-js/webpack/runtime/define property getters","webpack://@lady-byron/reading-enhance-js/webpack/runtime/hasOwnProperty shorthand","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/app']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['common/extend']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/DiscussionListItem']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/DiscussionPage']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/PostStream']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['common/components/Link']\"","webpack://@lady-byron/reading-enhance-js/./src/forum/index.ts"],"sourcesContent":["if(typeof flarum.core.compat['forum/components/DiscussionSearchResult'] === 'undefined') { var e = new Error(\"Cannot find module 'flarum.core.compat['forum/components/DiscussionSearchResult']'\"); e.code = 'MODULE_NOT_FOUND'; throw e; }\n\nmodule.exports = flarum.core.compat['forum/components/DiscussionSearchResult'];","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionListItem'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionPage'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/PostStream'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/components/Link'];","// js/src/forum/index.ts\nimport app from 'flarum/forum/app';\nimport { extend, override } from 'flarum/common/extend';\nimport DiscussionListItem from 'flarum/forum/components/DiscussionListItem';\nimport DiscussionPage from 'flarum/forum/components/DiscussionPage';\nimport PostStream from 'flarum/forum/components/PostStream';\nimport Link from 'flarum/common/components/Link';\n\n// 兼容有些构建下未导出的情况：用 require 尝试获取（存在才扩展）\ndeclare const require: any;\nlet DiscussionSearchResult: any = null;\ntry {\n  DiscussionSearchResult = require('flarum/forum/components/DiscussionSearchResult').default;\n} catch { /* noop */ }\n\n/** ---- 复制自 clark 插件的 blog 路由判定（简化版，内联） ---- */\nfunction shouldRedirectDiscussionToBlog(discussion: any): boolean {\n  // 没装 v17 blog 就直接 false\n  // @ts-ignore\n  if (!('v17development-blog' in flarum.extensions)) return false;\n\n  const redirects = app.forum.attribute('blogRedirectsEnabled');\n  const discussionRedirectEnabled =\n    redirects === 'both' || redirects === 'discussions_only';\n\n  const tags = discussion.tags?.() || [];\n  if (!discussionRedirectEnabled || tags.length === 0) return false;\n\n  const blogTags = (app.forum.attribute('blogTags') as string[]) || [];\n\n  return tags.some((tag: any) => {\n    if (!tag) return false;\n    const parent = tag.parent?.() || null;\n    return (\n      blogTags.indexOf(tag.id?.()!) !== -1 ||\n      (parent && blogTags.indexOf(parent.id?.()!) !== -1)\n    );\n  });\n}\n/** ---------------------------------------------------------- */\n\n/** 显式目标判定：有 near、/d/.../N、或 #pN 则不覆盖 */\nfunction hasExplicitTarget(href: string): boolean {\n  return /[?&]near=\\d+/.test(href) || /\\/d\\/[^/]+\\/\\d+(?:[/?#]|$)/.test(href) || /#p\\d+/.test(href);\n}\n\n/** 构造“正确”的目标 href（完全复刻思路：Blog 用 blogArticle(.near)，否则 app.route.discussion） */\nfunction buildDiscussionHref(discussion: any, nearOrZero: number): string {\n  const n = nearOrZero && nearOrZero > 1 ? nearOrZero : 0;\n\n  if (shouldRedirectDiscussionToBlog(discussion)) {\n    return n > 1\n      ? app.route('blogArticle.near', { id: discussion.slug(), near: n })\n      : app.route('blogArticle', { id: discussion.slug() });\n  }\n\n  return app.route.discussion(discussion, n);\n}\n\n/** 取视口顶部完全可见的楼层号（保存“最后稳定停留处”用） */\nfunction extractTopFullyVisiblePostNumber(): number | null {\n  const items = document.querySelectorAll<HTMLElement>('.PostStream-item[data-number]');\n  for (const el of Array.from(items)) {\n    const rect = el.getBoundingClientRect();\n    if (rect.top >= 0 && rect.bottom <= (window.innerHeight || 0)) {\n      const n = parseInt(el.dataset.number || '', 10);\n      if (n > 0) return n;\n    }\n  }\n  return null;\n}\n\n/** 写库（静默失败即可） */\nfunction savePosition(discussionId: string, postNumber: number) {\n  return app\n    .request({\n      method: 'POST',\n      url: `${app.forum.attribute('apiUrl')}/ladybyron/reading-position`,\n      body: { discussionId, postNumber },\n    })\n    .catch(() => {});\n}\n\napp.initializers.add('lady-byron/reading-enhance', () => {\n  /**\n   * A) 讨论列表：严格沿用你“已确认生效”的方式\n   *    - 不再跳过搜索页：现在连“全页搜索结果”也会按记录楼层打开\n   *    - 额外增加：若原 href 已显式指楼层，则尊重不覆盖\n   */\n  extend(DiscussionListItem.prototype, 'view', function (vdom: any) {\n    const discussion = (this as any).attrs?.discussion;\n    if (!discussion) return;\n\n    const recorded: number | null = discussion.attribute('lbReadingPosition') ?? null;\n    if (!recorded || recorded <= 1) return; // 没有记录或仅 1 楼，无需 near\n\n    // 与 clark 插件一致的 vnode 命中方式：定位到 .DiscussionListItem-content 内的第一个 Link\n    (vdom.children as any[]).forEach((child: any) => {\n      if (\n        !child ||\n        !child.attrs ||\n        !child.attrs.className ||\n        child.attrs.className.indexOf('DiscussionListItem-content') === -1\n      ) {\n        return;\n      }\n\n      (child.children as any[]).forEach((sub: any) => {\n        if (!sub || sub.tag !== Link) return;\n\n        const orig = sub.attrs?.href as string | undefined;\n        if (orig && hasExplicitTarget(orig)) return; // 显式目标 → 保持原样\n\n        sub.attrs.href = buildDiscussionHref(discussion, recorded!);\n      });\n    });\n  });\n\n  /**\n   * B) 搜索下拉：如果组件存在，按相同思路重写其中的 Link\n   *    - 这里没有 .DiscussionListItem-content，直接找子级 Link 即可\n   *    - 同样尊重显式目标\n   */\n  if (DiscussionSearchResult && DiscussionSearchResult.prototype) {\n    extend(DiscussionSearchResult.prototype, 'view', function (vdom: any) {\n      const discussion = (this as any).attrs?.discussion;\n      if (!discussion) return;\n\n      const recorded: number | null = discussion.attribute('lbReadingPosition') ?? null;\n      if (!recorded || recorded <= 1) return;\n\n      (vdom.children as any[]).forEach((sub: any) => {\n        if (!sub || sub.tag !== Link) return;\n\n        const orig = sub.attrs?.href as string | undefined;\n        if (orig && hasExplicitTarget(orig)) return;\n\n        sub.attrs.href = buildDiscussionHref(discussion, recorded!);\n      });\n    });\n  }\n\n  /**\n   * C) 深链兜底：用户直接打开 /d/slug 且无 near/#pN 时，用 replace 无刷新替换为带 near/正确路由\n   *    - 仍交给核心 Resolver/PostStreamState 完成定位\n   */\n  extend(DiscussionPage.prototype, 'show', function (_: any, discussion: any) {\n    if (!discussion) return;\n\n    const current = m.route.get();\n    if (hasExplicitTarget(current)) return; // 地址已显式指楼层 → 不覆盖\n\n    const recorded: number | null = discussion.attribute('lbReadingPosition') ?? null;\n    if (!recorded || recorded <= 1) return;\n\n    const target = buildDiscussionHref(discussion, recorded);\n    if (current !== target) {\n      m.route.set(target, undefined, { replace: true });\n    }\n  });\n\n  /**\n   * D) 继续使用核心“位置变更节流回调”落库\n   */\n  override(DiscussionPage.prototype, 'view', function (original: any, ...args: any[]) {\n    const vdom = original(...args);\n\n    const inject = (node: any) => {\n      if (!node) return;\n      if (Array.isArray(node)) return node.forEach(inject);\n      if (node.children) inject(node.children);\n\n      if (node.tag === PostStream) {\n        node.attrs = node.attrs || {};\n        const prev = node.attrs.onPositionChange;\n\n        node.attrs.onPositionChange = (...cbArgs: any[]) => {\n          if (typeof prev === 'function') prev(...cbArgs);\n          if (!app.session.user) return;\n\n          const dp = this as any;\n          const discussion = dp?.discussion;\n          if (!discussion) return;\n\n          const n = extractTopFullyVisiblePostNumber();\n          if (n && typeof n === 'number') {\n            savePosition(discussion.id(), n).then(() => {\n              // 同步模型，列表改写能立刻用到最新记录\n              if (discussion.attribute('lbReadingPosition') !== n) {\n                discussion.pushAttributes({ lbReadingPosition: n });\n              }\n            });\n          }\n        };\n      }\n    };\n\n    inject(vdom);\n    return vdom;\n  });\n});\n"],"names":["flarum","core","compat","e","Error","code","module","exports","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","__webpack_modules__","n","getter","__esModule","d","a","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","DiscussionSearchResult","require","_unused","hasExplicitTarget","href","test","buildDiscussionHref","discussion","nearOrZero","extensions","redirects","app","attribute","discussionRedirectEnabled","tags","length","blogTags","some","tag","parent","indexOf","id","shouldRedirectDiscussionToBlog","slug","near","add","extend","DiscussionListItem","vdom","_attrs","_discussion$attribute","this","attrs","recorded","children","forEach","child","className","sub","_sub$attrs","Link","orig","_attrs2","_discussion$attribute2","_sub$attrs2","DiscussionPage","_","_discussion$attribute3","current","m","route","target","set","replace","override","original","_this","_len","arguments","args","Array","_key","apply","inject","node","isArray","PostStream","prev","onPositionChange","user","discussionId","postNumber","items","document","querySelectorAll","_i","_Array$from","from","el","rect","getBoundingClientRect","top","bottom","window","innerHeight","parseInt","dataset","number","extractTopFullyVisiblePostNumber","method","url","body","then","pushAttributes","lbReadingPosition"],"sourceRoot":""}