{"version":3,"file":"forum.js","mappings":"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","sources":["webpack://@lady-byron/reading-enhance-js/webpack/bootstrap","webpack://@lady-byron/reading-enhance-js/webpack/runtime/compat get default export","webpack://@lady-byron/reading-enhance-js/webpack/runtime/define property getters","webpack://@lady-byron/reading-enhance-js/webpack/runtime/hasOwnProperty shorthand","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/app']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/states/PostStreamState']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/PostStream']\"","webpack://@lady-byron/reading-enhance-js/./src/forum/features/replyJumpInterceptor.ts","webpack://@lady-byron/reading-enhance-js/./src/forum/features/readingShortcuts.ts","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['common/extend']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/DiscussionPage']\"","webpack://@lady-byron/reading-enhance-js/./src/forum/features/readingPositionRecorder.ts","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/DiscussionListItem']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['common/components/Link']\"","webpack://@lady-byron/reading-enhance-js/./src/forum/features/discussionNavigation.ts","webpack://@lady-byron/reading-enhance-js/./src/forum/index.ts"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/states/PostStreamState'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/PostStream'];","// js/src/forum/features/replyJumpInterceptor.ts\nimport app from 'flarum/forum/app';\nimport PostStreamState from 'flarum/forum/states/PostStreamState';\nimport PostStream from 'flarum/forum/components/PostStream';\n\n/**\n * 精确令牌拦截：\n * - 仅在“提交新回复成功（POST /posts）”后，给对应讨论 did 上一次性令牌（可消费 2~3 次滚动入口）。\n * - 在 goToNumber('reply') / scrollToNumber(newNumber) / triggerScroll等入口，命中当前讨论且目标=回复/末楼时吞掉滚动。\n * - 不影响 near 跳转、点楼号、路由初始定位等其它行为。\n */\n\ntype Token = {\n  did: string | null;\n  targetNum: number | null; // 新回复的楼号（来自 POST /posts 响应）\n  left: number;             // 可吞次数（冗余入口链路下通常 2~3 次足够）\n  expiresAt: number;        // TTL，毫秒级\n};\n\nconst token: Token = {\n  did: null,\n  targetNum: null,\n  left: 0,\n  expiresAt: 0,\n};\n\nfunction now() {\n  return Date.now();\n}\nfunction activeFor(did: string | null): boolean {\n  return (\n    !!did &&\n    token.did === did &&\n    token.left > 0 &&\n    now() < token.expiresAt\n  );\n}\nfunction arm(did: string, targetNum: number | null, ttlMs = 1800, times = 3) {\n  token.did = did;\n  token.targetNum = typeof targetNum === 'number' && targetNum > 0 ? targetNum : null;\n  token.left = Math.max(1, times);\n  token.expiresAt = now() + Math.max(300, ttlMs);\n}\nfunction consume() {\n  if (token.left > 0) token.left -= 1;\n  if (token.left <= 0) {\n    token.did = null;\n    token.targetNum = null;\n    token.expiresAt = 0;\n  }\n}\n\nfunction isReplyJump(discussion: any, target: 'reply' | number | any): boolean {\n  // 仅判断“发帖后滚动到底部/新楼”的特征\n  if (!discussion) return false;\n\n  if (target === 'reply') return true;\n\n  const last: number | null =\n    typeof discussion.lastPostNumber === 'function'\n      ? discussion.lastPostNumber()\n      : discussion.attribute?.('lastPostNumber');\n\n  if (typeof target === 'number' && target > 0) {\n    // 目标是“末楼或更后”（保守 ≥）\n    if (typeof last === 'number' && last > 0 && target >= last) return true;\n    // 若有 POST 返回的确切新楼号，用它作判定更稳\n    if (token.targetNum && target >= token.targetNum) return true;\n  }\n\n  return false;\n}\n\nfunction installRequestHook() {\n  // 只包一次\n  if ((app as any).__lbReqHooked) return;\n  (app as any).__lbReqHooked = true;\n\n  const orig = app.request.bind(app);\n\n  app.request = function (opts: any) {\n    const p = orig(opts);\n    try {\n      const method = String(opts?.method || '').toUpperCase();\n      const url = String(opts?.url || '');\n      const isCreatePost =\n        method === 'POST' &&\n        /\\/posts(?:\\?|$|\\/)/.test(url); // .../api/posts\n\n      if (!isCreatePost) return p;\n\n      return p.then((res: any) => {\n        // 解析 discussionId 与新楼号\n        const did =\n          res?.data?.relationships?.discussion?.data?.id ??\n          res?.data?.attributes?.discussionId ??\n          null;\n        const num: number | null =\n          typeof res?.data?.attributes?.number === 'number'\n            ? res.data.attributes.number\n            : null;\n\n        if (did) {\n          arm(String(did), num, 1800, 3);\n        }\n        return res;\n      });\n    } catch {\n      // 出错不影响请求链路\n      return p;\n    }\n  };\n}\n\nfunction installScrollGuards() {\n  // --- goToNumber(entry)：最早的定位入口 ---\n  const goToOrig = (PostStreamState as any).prototype.goToNumber;\n  (PostStreamState as any).prototype.goToNumber = function (target: any, ...rest: any[]) {\n    try {\n      const discussion = (this as any)?.discussion;\n      const did =\n        discussion?.id?.() ??\n        (typeof discussion?.id === 'function' ? discussion.id() : null);\n\n      if (activeFor(did) && isReplyJump(discussion, target)) {\n        consume();\n        return; // 吞掉这一次“发帖后自动滚动”\n      }\n    } catch {}\n    return goToOrig.apply(this, [target, ...rest]);\n  };\n\n  // --- PostStream.prototype.triggerScroll：滚动触发（适配不同核心版本） ---\n  const psProto: any = (PostStream as any).prototype;\n\n  if (typeof psProto.triggerScroll === 'function') {\n    const trigOrig = psProto.triggerScroll;\n    psProto.triggerScroll = function (...args: any[]) {\n      try {\n        const state = this?.attrs?.state;\n        const discussion = state?.discussion;\n        const did =\n          discussion?.id?.() ??\n          (typeof discussion?.id === 'function' ? discussion.id() : null);\n        const target =\n          state?.targetPostNumber ??\n          state?.index ??\n          (state?.visible && state.visible.number) ??\n          null;\n\n        if (activeFor(did) && isReplyJump(discussion, target)) {\n          consume();\n          return;\n        }\n      } catch {}\n      return trigOrig.apply(this, args);\n    };\n  }\n\n  // --- PostStream.prototype.scrollToNumber：另一实现路径 ---\n  if (typeof psProto.scrollToNumber === 'function') {\n    const toNumOrig = psProto.scrollToNumber;\n    psProto.scrollToNumber = function (n: number, ...rest: any[]) {\n      try {\n        const state = this?.attrs?.state;\n        const discussion = state?.discussion;\n        const did =\n          discussion?.id?.() ??\n          (typeof discussion?.id === 'function' ? discussion.id() : null);\n\n        if (activeFor(did) && isReplyJump(discussion, n)) {\n          consume();\n          return;\n        }\n      } catch {}\n      return toNumOrig.apply(this, [n, ...rest]);\n    };\n  }\n\n  // --- PostStream.prototype.scrollToIndex：极少数路径（保守） ---\n  if (typeof psProto.scrollToIndex === 'function') {\n    const toIdxOrig = psProto.scrollToIndex;\n    psProto.scrollToIndex = function (i: number, ...rest: any[]) {\n      try {\n        const state = this?.attrs?.state;\n        const discussion = state?.discussion;\n        const did =\n          discussion?.id?.() ??\n          (typeof discussion?.id === 'function' ? discussion.id() : null);\n        const approxTarget =\n          state?.visible?.number && typeof state.visible.number === 'number'\n            ? state.visible.number\n            : i;\n\n        if (activeFor(did) && isReplyJump(discussion, approxTarget)) {\n          consume();\n          return;\n        }\n      } catch {}\n      return toIdxOrig.apply(this, [i, ...rest]);\n    };\n  }\n}\n\nexport default function installReplyJumpInterceptor() {\n  app.initializers.add('lady-byron/reading-enhance-reply-jump', () => {\n    // 1) 监听“发帖成功”\n    installRequestHook();\n\n    // 2) 拦截“仅限由发帖引发的滚动”\n    installScrollGuards();\n  });\n}\n","// js/src/forum/features/readingShortcuts.ts\nimport app from 'flarum/forum/app';\n\n/**\n * 半屏/整屏翻页快捷键（桌面端优先）\n * - Shift+D  半屏下\n * - Shift+U  半屏上\n * - Shift+J  整屏下\n * - Shift+K  整屏上\n *\n * 仅在非输入/编辑状态触发；不影响弹窗、编辑器、Composer。\n */\n\ntype Options = {\n  halfRatio: number;       // 半屏比例\n  smooth: boolean;         // 是否平滑滚动\n  headerSelector: string;  // 顶栏选择器，用于抵扣可视高度\n};\n\nconst DEFAULTS: Options = {\n  halfRatio: 0.5,\n  smooth: true,\n  headerSelector: '.App-header',\n};\n\nfunction isEditableTarget(t: EventTarget | null): boolean {\n  const el = t instanceof Element ? t : null;\n  if (!el) return false;\n\n  // 常见可编辑/输入容器\n  const editable = el.closest(\n    'input, textarea, [contenteditable=\"true\"], .TextEditor, .CodeMirror, .ProseMirror, .Composer, .Modal'\n  );\n  // Composer 打开时整体禁用\n  const composerOpen = !!(app as any)?.composer?.isVisible?.();\n\n  return !!editable || composerOpen;\n}\n\nfunction headerOffsetPx(sel: string): number {\n  try {\n    const h = document.querySelector(sel);\n    return h ? h.getBoundingClientRect().height : 0;\n  } catch {\n    return 0;\n  }\n}\n\nfunction scrollByAmount(px: number, smooth: boolean) {\n  if ('scrollBy' in window) {\n    window.scrollBy({ top: px, left: 0, behavior: smooth ? 'smooth' : 'auto' });\n  } else {\n    const sc = document.scrollingElement || document.documentElement || document.body;\n    sc.scrollTop += px;\n  }\n}\n\nfunction keySig(e: KeyboardEvent): string {\n  // 只关心 Shift + 字母，不处理 Ctrl/Meta/Alt，避免系统/浏览器冲突\n  if (e.ctrlKey || e.metaKey || e.altKey) return '';\n  const parts: string[] = [];\n  if (e.shiftKey) parts.push('Shift');\n  const k = e.key.length === 1 ? e.key.toUpperCase() : e.key;\n  parts.push(k);\n  return parts.join('+');\n}\n\nexport default function installReadingShortcuts(opts?: Partial<Options>) {\n  const options: Options = Object.assign({}, DEFAULTS, opts || {});\n  let attached = false;\n\n  app.initializers.add('lady-byron/reading-enhance-shortcuts', () => {\n    if (attached) return;\n    attached = true;\n\n    const onKeydown = (e: KeyboardEvent) => {\n      // 在输入/编辑/弹窗内不触发；忽略按住不放的连发\n      if (isEditableTarget(e.target) || e.repeat) return;\n\n      const sig = keySig(e);\n      if (!sig) return;\n\n      const offset = headerOffsetPx(options.headerSelector);\n      const vh = window.innerHeight || 0;\n\n      switch (sig) {\n        case 'Shift+D': {\n          e.preventDefault(); e.stopPropagation();\n          const delta = Math.max(1, Math.round(vh * options.halfRatio) - Math.round(offset / 2));\n          scrollByAmount(delta, options.smooth);\n          break;\n        }\n        case 'Shift+U': {\n          e.preventDefault(); e.stopPropagation();\n          const delta = Math.max(1, Math.round(vh * options.halfRatio) - Math.round(offset / 2));\n          scrollByAmount(-delta, options.smooth);\n          break;\n        }\n        case 'Shift+J': {\n          e.preventDefault(); e.stopPropagation();\n          scrollByAmount(vh, options.smooth);\n          break;\n        }\n        case 'Shift+K': {\n          e.preventDefault(); e.stopPropagation();\n          scrollByAmount(-vh, options.smooth);\n          break;\n        }\n        default:\n          // 其它组合不处理\n          break;\n      }\n    };\n\n    // 捕获阶段优先处理，但不干扰其它键位\n    window.addEventListener('keydown', onKeydown, true);\n\n    // 若未来需要卸载，可暴露到全局（调试用）\n    (window as any).__lb_shortcuts = {\n      detach() {\n        window.removeEventListener('keydown', onKeydown, true);\n      },\n    };\n  });\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionPage'];","// js/src/forum/features/readingPositionRecorder.ts\nimport app from 'flarum/forum/app';\nimport { override } from 'flarum/common/extend';\nimport DiscussionPage from 'flarum/forum/components/DiscussionPage';\nimport PostStream from 'flarum/forum/components/PostStream';\n\n/** ---- 工具：从 onPositionChange 的参数中提取楼号（与原版一致） ---- */\nfunction derivePostNumberFromPositionChangeArgs(args: any[]): number | null {\n  for (const a of args) {\n    if (a == null) continue;\n\n    if (typeof a === 'number') {\n      if (a > 0) return a;\n    } else if (typeof a === 'object') {\n      if (typeof (a as any).number === 'number' && (a as any).number > 0) {\n        return (a as any).number;\n      }\n      if (typeof (a as any).postNumber === 'number' && (a as any).postNumber > 0) {\n        return (a as any).postNumber;\n      }\n      if (typeof (a as any).near === 'number' && (a as any).near > 0) {\n        return (a as any).near;\n      }\n      if (\n        (a as any).visible &&\n        typeof (a as any).visible.number === 'number' &&\n        (a as any).visible.number > 0\n      ) {\n        return (a as any).visible.number as number;\n      }\n    }\n  }\n  return null;\n}\n\n/** 从当前 URL 提取 near（/d/:id/:near 或 ?near=） */\nfunction extractNearFromUrl(): number | null {\n  try {\n    const url = new URL(window.location.href);\n    const parts = url.pathname.split('/').filter(Boolean);\n    const dIndex = parts.indexOf('d');\n    if (dIndex !== -1 && parts.length > dIndex + 2) {\n      const maybeNear = parseInt(parts[dIndex + 2], 10);\n      if (!Number.isNaN(maybeNear) && maybeNear > 0) return maybeNear;\n    }\n    const qNear = parseInt(url.searchParams.get('near') || '', 10);\n    if (!Number.isNaN(qNear) && qNear > 0) return qNear;\n  } catch {}\n  return null;\n}\n\n/** 作为最后退路：扫描顶部附近的 .PostStream-item[data-number] */\nfunction extractTopPartiallyVisible(): number | null {\n  const items = document.querySelectorAll<HTMLElement>('.PostStream-item[data-number]');\n  const viewportTop = 4;\n\n  for (const el of Array.from(items)) {\n    const rect = el.getBoundingClientRect();\n    if (rect.top <= viewportTop && rect.bottom > viewportTop) {\n      const n = parseInt(el.dataset.number || '', 10);\n      if (n > 0) return n;\n    }\n  }\n\n  for (const el of Array.from(items)) {\n    const rect = el.getBoundingClientRect();\n    if (rect.top >= viewportTop && rect.top < (window.innerHeight || 0)) {\n      const n = parseInt(el.dataset.number || '', 10);\n      if (n > 0) return n;\n    }\n  }\n\n  return null;\n}\n\n/** 写库（静默失败即可） */\nfunction savePosition(discussionId: string, postNumber: number) {\n  return app\n    .request({\n      method: 'POST',\n      url: `${app.forum.attribute('apiUrl')}/ladybyron/reading-position`,\n      body: { discussionId, postNumber },\n    })\n    .catch(() => {});\n}\n\n/** 200ms 轻节流 + 去重（双向允许） */\nconst DEBOUNCE_MS = 200;\nconst pendingTimerByDiscussion: Record<string, number> = Object.create(null);\nconst pendingCandidateByDiscussion: Record<string, number> = Object.create(null);\nconst lastCommittedByDiscussion: Record<string, number> = Object.create(null);\n\nfunction scheduleSaveBidirectional(discussion: any, candidate: number) {\n  const id: string = discussion.id();\n  if (pendingCandidateByDiscussion[id] === candidate) return;\n\n  pendingCandidateByDiscussion[id] = candidate;\n\n  if (pendingTimerByDiscussion[id]) {\n    window.clearTimeout(pendingTimerByDiscussion[id]);\n  }\n\n  pendingTimerByDiscussion[id] = window.setTimeout(() => {\n    const toSend = pendingCandidateByDiscussion[id];\n    if (typeof toSend !== 'number' || toSend <= 0) return;\n\n    const current = discussion.attribute('lbReadingPosition') ?? 0;\n    const lastCommitted = lastCommittedByDiscussion[id] ?? current;\n    if (toSend === current || toSend === lastCommitted) return;\n\n    savePosition(id, toSend).then(() => {\n      lastCommittedByDiscussion[id] = toSend;\n      if (discussion.attribute('lbReadingPosition') !== toSend) {\n        discussion.pushAttributes({ lbReadingPosition: toSend });\n      }\n    });\n  }, DEBOUNCE_MS);\n}\n\nlet attached = false;\n\nexport default function installReadingPositionRecorder() {\n  if (attached) return;\n  attached = true;\n\n  app.initializers.add('lady-byron/reading-enhance-position', () => {\n    override(DiscussionPage.prototype, 'view', function (original: any, ...args: any[]) {\n      const vdom = original(...args);\n\n      const inject = (node: any) => {\n        if (!node) return;\n        if (Array.isArray(node)) return node.forEach(inject);\n        if (node.children) inject(node.children);\n\n        if (node.tag === PostStream) {\n          node.attrs = node.attrs || {};\n          const prev = node.attrs.onPositionChange;\n\n          node.attrs.onPositionChange = (...cbArgs: any[]) => {\n            if (typeof prev === 'function') prev(...cbArgs);\n            if (!app.session.user) return;\n\n            const dp = this as any;\n            const discussion = dp?.discussion;\n            if (!discussion) return;\n\n            let n = derivePostNumberFromPositionChangeArgs(cbArgs);\n            if (!n) n = extractNearFromUrl();\n            if (!n) n = extractTopPartiallyVisible();\n\n            if (n && typeof n === 'number' && n > 0) {\n              scheduleSaveBidirectional(discussion, n);\n            }\n          };\n        }\n      };\n\n      inject(vdom);\n      return vdom;\n    });\n  });\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionListItem'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/components/Link'];","// js/src/forum/features/discussionNavigation.ts\nimport app from 'flarum/forum/app';\nimport { extend } from 'flarum/common/extend';\nimport DiscussionListItem from 'flarum/forum/components/DiscussionListItem';\nimport Link from 'flarum/common/components/Link';\n\n/** ---- v17 blog 路由判定（与你现有实现一致） ---- */\nfunction shouldRedirectDiscussionToBlog(discussion: any): boolean {\n  // @ts-ignore\n  if (!(window as any).flarum || !('v17development-blog' in (window as any).flarum.extensions)) {\n    return false;\n  }\n\n  const redirects = app.forum.attribute('blogRedirectsEnabled');\n  const discussionRedirectEnabled =\n    redirects === 'both' || redirects === 'discussions_only';\n\n  const tags = discussion.tags?.() || [];\n  if (!discussionRedirectEnabled || tags.length === 0) return false;\n\n  const blogTags = app.forum.attribute<string[]>('blogTags') || [];\n\n  return tags.some((tag: any) => {\n    if (!tag) return false;\n    const parent = tag.parent?.() || null;\n    return (\n      blogTags.indexOf(tag.id?.()!) !== -1 ||\n      (parent && blogTags.indexOf(parent.id?.()!) !== -1)\n    );\n  });\n}\n\n/** ---- URL 工具 ---- */\nfunction sameOrigin(u: URL): boolean {\n  try {\n    const base = new URL(app.forum.attribute('baseUrl'));\n    return u.origin === base.origin;\n  } catch {\n    return false;\n  }\n}\n\nfunction parseDiscussionIdFromUrl(u: URL): string | null {\n  const parts = u.pathname.split('/').filter(Boolean);\n  const dIndex = parts.indexOf('d');\n  if (dIndex === -1 || parts.length <= dIndex + 1) return null;\n  const idPart = parts[dIndex + 1];\n  const match = /^(\\d+)/.exec(idPart);\n  return match ? match[1] : null;\n}\n\n/** 显式 near 识别：数字 | 'first' | 'last' | #p123 | #reply/#last/#first */\nfunction hasExplicitNear(u: URL): number | 'first' | 'last' | null {\n  const parts = u.pathname.split('/').filter(Boolean);\n  const dIndex = parts.indexOf('d');\n\n  // /d/:id/:near（数字）\n  if (dIndex !== -1 && parts.length > dIndex + 2) {\n    const n = parseInt(parts[dIndex + 2], 10);\n    if (!Number.isNaN(n) && n > 0) return n; // near=1 也视为显式\n  }\n\n  // ?near=（数字 | first | last）\n  const nearRaw = u.searchParams.get('near');\n  if (nearRaw) {\n    const n = parseInt(nearRaw, 10);\n    if (!Number.isNaN(n) && n > 0) return n;\n    const s = nearRaw.toLowerCase();\n    if (s === 'first') return 'first';\n    if (s === 'last') return 'last';\n  }\n\n  // 锚点：#p123 / #reply / #last / #first\n  if (u.hash) {\n    const h = u.hash.toLowerCase();\n    if (/^#p\\d+$/.test(h)) return parseInt(h.slice(2), 10);\n    if (h === '#reply' || h === '#last') return 'last';\n    if (h === '#first') return 'first';\n  }\n  return null;\n}\n\n/** 从前端 store 读取 near（lbReadingPosition > lastReadPostNumber > null） */\nfunction nearFromStore(id: string): number | null {\n  const d = app.store.getById('discussions', id);\n  if (!d) return null;\n\n  const lb =\n    typeof d.attribute === 'function'\n      ? d.attribute('lbReadingPosition')\n      : (d as any).lbReadingPosition;\n\n  const last =\n    typeof d.lastReadPostNumber === 'function'\n      ? d.lastReadPostNumber()\n      : typeof d.attribute === 'function'\n      ? d.attribute('lastReadPostNumber')\n      : null;\n\n  const lbNum = typeof lb === 'number' ? lb : null;\n  const lastNum = typeof last === 'number' ? last : null;\n\n  return lbNum && lbNum > 1\n    ? lbNum\n    : lastNum && lastNum > 1\n    ? lastNum\n    : null;\n}\n\n/** 把 /d/:id[/slug] 改成 /d/:id[/slug]/:near（移除 ?near，目前也不用 hash #p123） */\nfunction buildNearUrl(u: URL, near: number): string {\n  const parts = u.pathname.split('/').filter(Boolean);\n  const dIndex = parts.indexOf('d');\n  if (dIndex === -1 || parts.length <= dIndex + 1) return u.pathname + u.search + u.hash;\n\n  const prefix = '/' + parts.slice(0, dIndex + 2).join('/');\n  u.pathname = `${prefix}/${near}`;\n  u.searchParams.delete('near');\n  if (u.hash && /^#p\\d+$/i.test(u.hash)) u.hash = '';\n\n  return u.pathname + u.search + u.hash;\n}\n\nlet attached = false;\n\nexport default function installDiscussionNavigation() {\n  if (attached) return;\n  attached = true;\n\n  app.initializers.add('lady-byron/reading-enhance-navigation', () => {\n    /** 1) 列表项改写（保留 v17 blog 支持 & 搜索页特例） */\n    extend(DiscussionListItem.prototype, 'view', function (vdom: any) {\n      // 搜索页（params.q）不改写，保留“最相关”体验\n      if ((this as any).attrs?.params?.q) return;\n\n      const discussion = (this as any).attrs?.discussion;\n      if (!discussion) return;\n\n      const recorded: number | null = discussion.attribute('lbReadingPosition') ?? null;\n      if (!recorded || recorded <= 1) return;\n\n      (vdom.children as any[]).forEach((child: any) => {\n        if (\n          !child ||\n          !child.attrs ||\n          !child.attrs.className ||\n          child.attrs.className.indexOf('DiscussionListItem-content') === -1\n        ) {\n          return;\n        }\n\n        (child.children as any[]).forEach((sub: any) => {\n          if (!sub || sub.tag !== Link) return;\n\n          let href: string;\n\n          if (shouldRedirectDiscussionToBlog(discussion)) {\n            href =\n              recorded > 1\n                ? app.route('blogArticle.near', { id: discussion.slug(), near: recorded })\n                : app.route('blogArticle', { id: discussion.slug() });\n          } else {\n            href = app.route.discussion(discussion, recorded);\n          }\n\n          sub.attrs = sub.attrs || {};\n          sub.attrs.href = href;\n          sub.attrs['data-lbRewritten'] = '1';\n        });\n      });\n    });\n\n    /** 2) Link.view 级别的通用 near 注入（不打 API） */\n    extend(Link.prototype as any, 'view', function (vdom: any) {\n      const attrs = vdom.attrs || {};\n      if (attrs['data-lbRewritten']) return;\n\n      const href: string | undefined = attrs.href;\n      if (typeof href !== 'string' || !href.trim()) return;\n\n      let u: URL;\n      try {\n        // 用 baseUrl 作为相对根，兼容相对路径\n        u = new URL(href, app.forum.attribute('baseUrl'));\n      } catch {\n        return;\n      }\n\n      if (!sameOrigin(u)) return;\n\n      // 显式 near（含 first/last/#p123/#reply）一律尊重\n      const explicit = hasExplicitNear(u);\n      if (explicit) return;\n\n      const id = parseDiscussionIdFromUrl(u);\n      if (!id) return;\n\n      const near = nearFromStore(id);\n      if (!near || near <= 1) return;\n\n      const target = buildNearUrl(u, near);\n      vdom.attrs.href = target;\n      vdom.attrs['data-lbRewritten'] = '1';\n    });\n\n    /** 3) 兜底补丁：任何地方调用 m.route.set('/d/:id[..]') 时，如果我们有 near，就补上 */\n    // @ts-ignore\n    const oldSet = m.route.set.bind(m.route);\n    // @ts-ignore\n    m.route.set = function (path: string, data?: any, options?: any) {\n      try {\n        if (typeof path === 'string') {\n          const url = new URL(path, window.location.origin);\n          const parts = url.pathname.split('/').filter(Boolean);\n          const dIndex = parts.indexOf('d');\n\n          if (dIndex !== -1 && parts.length > dIndex + 1) {\n            const hasNearPath =\n              parts.length > dIndex + 2 && /^\\d+$/.test(parts[dIndex + 2]);\n            const hasNearQuery = url.searchParams.has('near'); // near=first/last 也算显式\n\n            if (!hasNearPath && !hasNearQuery) {\n              const idPart = parts[dIndex + 1];\n              const idMatch = /^(\\d+)/.exec(idPart);\n              const id = idMatch ? idMatch[1] : null;\n\n              if (id) {\n                const near = nearFromStore(id);\n                if (near && near > 1) {\n                  const prefix = '/' + parts.slice(0, dIndex + 2).join('/');\n                  url.pathname = `${prefix}/${near}`;\n                  url.searchParams.delete('near');\n                  path = url.pathname + url.search + url.hash;\n                }\n              }\n            }\n          }\n        }\n      } catch {}\n\n      // @ts-ignore\n      return oldSet(path, data, options);\n    };\n  });\n}\n","// js/src/forum/index.ts\nimport installReplyJumpInterceptor from './features/replyJumpInterceptor';\nimport installReadingShortcuts from './features/readingShortcuts';\nimport installReadingPositionRecorder from './features/readingPositionRecorder';\nimport installDiscussionNavigation from './features/discussionNavigation';\n\n// 纯入口：只负责注册各模块的 initializer\ninstallReplyJumpInterceptor();\ninstallReadingShortcuts();\ninstallReadingPositionRecorder();\ninstallDiscussionNavigation();\n"],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","flarum","core","compat","token","did","targetNum","left","expiresAt","now","Date","activeFor","consume","isReplyJump","discussion","target","last","lastPostNumber","attribute","DEFAULTS","halfRatio","smooth","headerSelector","scrollByAmount","px","window","scrollBy","top","behavior","document","scrollingElement","documentElement","body","scrollTop","pendingTimerByDiscussion","create","pendingCandidateByDiscussion","lastCommittedByDiscussion","attached","nearFromStore","id","app","getById","lb","lbReadingPosition","lastReadPostNumber","lbNum","lastNum","add","orig","bind","opts","p","method","String","toUpperCase","url","test","then","res","_ref","_res$data$relationshi","_res$data","_res$data2","_res$data3","data","relationships","attributes","discussionId","num","number","ttlMs","times","Math","max","arm","_unused","installRequestHook","goToOrig","PostStreamState","goToNumber","_discussion$id","this","_unused2","_len","arguments","length","rest","Array","_key","apply","concat","psProto","PostStream","triggerScroll","trigOrig","_this$attrs","_discussion$id2","_ref2","_ref3","_state$targetPostNumb","state","attrs","targetPostNumber","index","visible","_unused3","_len2","args","_key2","scrollToNumber","toNumOrig","n","_this$attrs2","_discussion$id3","_unused4","_len3","_key3","scrollToIndex","toIdxOrig","i","_this$attrs3","_discussion$id4","_state$visible","approxTarget","_unused5","_len4","_key4","installScrollGuards","options","assign","onKeydown","e","t","_composer","el","Element","editable","closest","composerOpen","isVisible","isEditableTarget","repeat","sig","ctrlKey","metaKey","altKey","parts","shiftKey","push","k","join","keySig","offset","sel","h","querySelector","getBoundingClientRect","height","headerOffsetPx","vh","innerHeight","preventDefault","stopPropagation","round","addEventListener","__lb_shortcuts","detach","removeEventListener","installReadingShortcuts","override","DiscussionPage","original","_this","vdom","inject","node","isArray","forEach","children","tag","prev","onPositionChange","cbArgs","user","_step","_iterator","_createForOfIteratorHelperLoose","done","value","postNumber","near","derivePostNumberFromPositionChangeArgs","URL","location","href","pathname","split","filter","Boolean","dIndex","indexOf","maybeNear","parseInt","Number","isNaN","qNear","searchParams","extractNearFromUrl","items","querySelectorAll","_i","_Array$from","from","rect","bottom","dataset","_i2","_Array$from2","extractTopPartiallyVisible","candidate","clearTimeout","setTimeout","_discussion$attribute","_lastCommittedByDiscu","toSend","current","lastCommitted","pushAttributes","scheduleSaveBidirectional","extend","DiscussionListItem","_attrs","_attrs2","params","q","recorded","child","className","sub","Link","extensions","redirects","discussionRedirectEnabled","tags","blogTags","some","parent","shouldRedirectDiscussionToBlog","slug","trim","u","base","origin","sameOrigin","explicit","nearRaw","s","toLowerCase","hash","slice","hasExplicitNear","idPart","match","exec","parseDiscussionIdFromUrl","search","prefix","buildNearUrl","oldSet","m","route","set","path","hasNearPath","hasNearQuery","has","idMatch"],"ignoreList":[],"sourceRoot":""}