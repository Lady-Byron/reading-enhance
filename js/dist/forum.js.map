{"version":3,"file":"forum.js","mappings":"MACA,IAAIA,EAAsB,CCA1BA,EAAyBC,IACxB,IAAIC,EAASD,GAAUA,EAAOE,WAC7B,IAAOF,EAAiB,QACxB,IAAM,EAEP,OADAD,EAAoBI,EAAEF,EAAQ,CAAEG,EAAGH,IAC5BA,GCLRF,EAAwB,CAACM,EAASC,KACjC,IAAI,IAAIC,KAAOD,EACXP,EAAoBS,EAAEF,EAAYC,KAASR,EAAoBS,EAAEH,EAASE,IAC5EE,OAAOC,eAAeL,EAASE,EAAK,CAAEI,YAAY,EAAMC,IAAKN,EAAWC,MCJ3ER,EAAwB,CAACc,EAAKC,IAAUL,OAAOM,UAAUC,eAAeC,KAAKJ,EAAKC,I,mBCAlF,MAAM,EAA+BI,OAAOC,KAAKC,OAAO,a,aCAxD,MAAM,EAA+BF,OAAOC,KAAKC,OAAO,mC,aCAxD,MAAM,EAA+BF,OAAOC,KAAKC,OAAO,+B,aCAxD,MAAM,EAA+BF,OAAOC,KAAKC,OAAO,iBCOxD,SAASC,IACP,IAAMC,EAAQC,EAAEC,MAAMC,OAASF,EAAEC,MAAMC,MAAM,SAAY,KACnDC,EAA0B,oBAAXC,QAA0BA,OAAOC,SAASF,MAAS,GACxE,QAASJ,GAAQ,WAAWO,KAAKH,EACnC,CA0BAI,IAAAA,aAAiBC,IAAI,6BAA8B,YASjDC,EAAAA,EAAAA,QAAOC,IAAAA,UAA0B,SAAU,WAAY,IAAAC,EACrD,GAAKJ,IAAAA,QAAYK,KAAjB,CAEA,IAAMC,EAAcC,KAAaD,WAC3BE,EAAoE,OAA7CJ,EAAa,MAAVE,OAAU,EAAVA,EAAYG,UAAU,sBAAoBL,EAAI,MAEzEb,KAAuBiB,GAAaD,KAAaG,SAEnDH,KAAaG,OAAOC,WAAa,CAAEC,OAAQJ,GAE3CD,KAAaG,OAAOG,aAAc,EATR,CAW/B,IAGAX,EAAAA,EAAAA,QAAOC,IAAAA,UAA0B,WAAY,WAAY,IAAAW,EACvD,GAAKd,IAAAA,QAAYK,KAAjB,CAEA,IAAMU,EAAKR,KACLD,EAAaS,EAAGT,WAChBE,EAAoE,OAA7CM,EAAa,MAAVR,OAAU,EAAVA,EAAYG,UAAU,sBAAoBK,EAAI,MAEzEvB,KAAuBiB,GAAYO,EAAGL,SAEzCK,EAAGL,OAAOC,WAAa,CAAEC,OAAQJ,GACjCO,EAAGL,OAAOG,aAAc,EAGxBE,EAAGL,OAAOM,WAAWR,GAAU,GAZJ,CAc/B,IAGAS,EAAAA,EAAAA,UAASd,IAAAA,UAA0B,OAAQ,SAAUe,GAA+B,QAAAC,EAAA,KAAAC,EAAAC,UAAAC,OAAbC,EAAI,IAAAC,MAAAJ,EAAA,EAAAA,EAAA,KAAAK,EAAA,EAAAA,EAAAL,EAAAK,IAAJF,EAAIE,EAAA,GAAAJ,UAAAI,GACzE,IAAMC,EAAOR,EAAQS,WAAC,EAAGJ,GAEnBK,EAAS,SAACC,GACd,GAAKA,EAAL,CACA,GAAIL,MAAMM,QAAQD,GAAO,OAAOA,EAAKE,QAAQH,GAG7C,GAFIC,EAAKG,UAAUJ,EAAOC,EAAKG,UAE3BH,EAAKI,MAAQC,IAAY,CAC3BL,EAAKM,MAAQN,EAAKM,OAAS,CAAC,EAG5B,IAAMC,EAAOP,EAAKM,MAAME,iBACxBR,EAAKM,MAAME,iBAAmB,WAE5B,GADoB,mBAATD,GAAqBA,EAAIT,WAAC,EAADN,WAC/BrB,IAAAA,QAAYK,KAAjB,CAEA,IACMC,EAAe,MADTa,OACS,EADTA,EACWb,WACvB,GAAKA,EAAL,CAEA,IAzEYgC,EAAsBC,EAyE5BC,EAtFhB,WAEE,IADA,IAAMC,EAAQC,SAASC,iBAA8B,iCACrDC,EAAA,EAAAC,EAAiBrB,MAAMsB,KAAKL,GAAMG,EAAAC,EAAAvB,OAAAsB,IAAE,CAA/B,IAAMG,EAAEF,EAAAD,GACLI,EAAOD,EAAGE,wBAChB,GAAID,EAAKE,KAAO,GAAKF,EAAKG,SAAWtD,OAAOuD,aAAe,GAAI,CAC7D,IAAMZ,EAAIa,SAASN,EAAGO,QAAQ1C,QAAU,GAAI,IAC5C,GAAI4B,EAAI,EAAG,OAAOA,CACpB,CACF,CACA,OAAO,IACT,CA4EoBe,GACNf,GAAkB,iBAANA,IA1EJF,EA2EGhC,EAAWkD,KA3EQjB,EA2EFC,EA1EjCxC,IAAAA,QACI,CACPyD,OAAQ,OACRC,IAAQ1D,IAAAA,MAAUS,UAAU,UAAS,8BACrCkD,KAAM,CAAErB,aAAAA,EAAcC,WAAAA,KACtB,MACK,WAAO,IAoE2BqB,KAAK,WAEhCtD,EAAWG,UAAU,uBAAyB+B,GAChDlC,EAAWuD,eAAe,CAAEC,kBAAmBtB,GAEnD,EATqB,CAJM,CAe/B,CAKF,CA/BiB,CAgCnB,EAGA,OADAZ,EAAOF,GACAA,CACT,EACF,E","sources":["webpack://@lady-byron/reading-enhance-js/webpack/bootstrap","webpack://@lady-byron/reading-enhance-js/webpack/runtime/compat get default export","webpack://@lady-byron/reading-enhance-js/webpack/runtime/define property getters","webpack://@lady-byron/reading-enhance-js/webpack/runtime/hasOwnProperty shorthand","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/app']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/DiscussionPage']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/PostStream']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['common/extend']\"","webpack://@lady-byron/reading-enhance-js/./src/forum/index.ts"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionPage'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/PostStream'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","// js/src/forum/index.ts\nimport app from 'flarum/forum/app';\nimport DiscussionPage from 'flarum/forum/components/DiscussionPage';\nimport PostStream from 'flarum/forum/components/PostStream';\nimport { extend, override } from 'flarum/common/extend';\n\n/** 是否存在显式目标（URL near 或 #p123 锚点） */\nfunction hasExplicitTarget(): boolean {\n  const near = (m.route.param && m.route.param('near')) || null;\n  const hash = (typeof window !== 'undefined' && window.location.hash) || '';\n  return !!near || /^#p\\d+$/i.test(hash);\n}\n\n/** 提取视口内顶部完全可见的楼层号（用于“最后稳定停留处”存盘） */\nfunction extractTopFullyVisiblePostNumber(): number | null {\n  const items = document.querySelectorAll<HTMLElement>('.PostStream-item[data-number]');\n  for (const el of Array.from(items)) {\n    const rect = el.getBoundingClientRect();\n    if (rect.top >= 0 && rect.bottom <= (window.innerHeight || 0)) {\n      const n = parseInt(el.dataset.number || '', 10);\n      if (n > 0) return n;\n    }\n  }\n  return null;\n}\n\n/** 将阅读位置写入后端（静默失败即可，不打断 UI） */\nfunction savePosition(discussionId: string, postNumber: number) {\n  return app\n    .request({\n      method: 'POST',\n      url: `${app.forum.attribute('apiUrl')}/ladybyron/reading-position`,\n      body: { discussionId, postNumber },\n    })\n    .catch(() => {});\n}\n\napp.initializers.add('lady-byron/reading-enhance', () => {\n  /**\n   * 关键修正：\n   * 1) 不再给 <PostStream> vnode 塞 targetPost\n   * 2) 而是给 PostStreamState（即 this.stream）设置 targetPost\n   *    这样才能被核心的首屏定位逻辑消费\n   */\n\n  // 在 oninit（核心创建 this.stream 之后）尽早注入目标楼层\n  extend(DiscussionPage.prototype, 'oninit', function () {\n    if (!app.session.user) return;\n\n    const discussion = (this as any).discussion;\n    const recorded: number | null = discussion?.attribute('lbReadingPosition') ?? null;\n\n    if (!hasExplicitTarget() && recorded && (this as any).stream) {\n      // ✅ 正确位置：直接写 state\n      (this as any).stream.targetPost = { number: recorded };\n      // 标一下面向下一次 update 的需求（兼容某些时序）\n      (this as any).stream.needsScroll = true;\n    }\n  });\n\n  // oncreate 再兜底一次（有些情况下数据到位稍晚）\n  extend(DiscussionPage.prototype, 'oncreate', function () {\n    if (!app.session.user) return;\n\n    const dp = this as any;\n    const discussion = dp.discussion;\n    const recorded: number | null = discussion?.attribute('lbReadingPosition') ?? null;\n\n    if (!hasExplicitTarget() && recorded && dp.stream) {\n      // 若核心在 oninit 之后又改写了 target（例如无未读时跳末帖），这里再覆盖一次\n      dp.stream.targetPost = { number: recorded };\n      dp.stream.needsScroll = true;\n\n      // 触发一次更新让 targetPost 生效（无动画，避免首屏晃动）\n      dp.stream.goToNumber(recorded, true);\n    }\n  });\n\n  // 将“最后稳定停留处”保存落库：复用核心节流回调\n  override(DiscussionPage.prototype, 'view', function (original: any, ...args: any[]) {\n    const vdom = original(...args);\n\n    const inject = (node: any) => {\n      if (!node) return;\n      if (Array.isArray(node)) return node.forEach(inject);\n      if (node.children) inject(node.children);\n\n      if (node.tag === PostStream) {\n        node.attrs = node.attrs || {};\n\n        // 1) 继续复用/尊重核心的 onPositionChange\n        const prev = node.attrs.onPositionChange;\n        node.attrs.onPositionChange = (...cbArgs: any[]) => {\n          if (typeof prev === 'function') prev(...cbArgs);\n          if (!app.session.user) return;\n\n          const dp = (this as any);\n          const discussion = dp?.discussion;\n          if (!discussion) return;\n\n          const n = extractTopFullyVisiblePostNumber();\n          if (n && typeof n === 'number') {\n            savePosition(discussion.id(), n).then(() => {\n              // 同步到前端模型，便于后续再次进入本帖立即可用\n              if (discussion.attribute('lbReadingPosition') !== n) {\n                discussion.pushAttributes({ lbReadingPosition: n });\n              }\n            });\n          }\n        };\n\n        // 2) ❌ 不再：node.attrs.targetPost = recorded\n        //    因为 <PostStream> 并不消费这个 prop；真正消费者是 state（this.stream.targetPost）\n        //    见 Flarum 1.8 PostStreamState 文档：targetPost 属性由 state/内部方法使用。\n      }\n    };\n\n    inject(vdom);\n    return vdom;\n  });\n});\n\n"],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","flarum","core","compat","hasExplicitTarget","near","m","route","param","hash","window","location","test","app","add","extend","DiscussionPage","_discussion$attribute","user","discussion","this","recorded","attribute","stream","targetPost","number","needsScroll","_discussion$attribute2","dp","goToNumber","override","original","_this","_len","arguments","length","args","Array","_key","vdom","apply","inject","node","isArray","forEach","children","tag","PostStream","attrs","prev","onPositionChange","discussionId","postNumber","n","items","document","querySelectorAll","_i","_Array$from","from","el","rect","getBoundingClientRect","top","bottom","innerHeight","parseInt","dataset","extractTopFullyVisiblePostNumber","id","method","url","body","then","pushAttributes","lbReadingPosition"],"sourceRoot":""}