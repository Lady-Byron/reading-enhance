{"version":3,"file":"forum.js","mappings":"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","sources":["webpack://@lady-byron/reading-enhance-js/webpack/bootstrap","webpack://@lady-byron/reading-enhance-js/webpack/runtime/compat get default export","webpack://@lady-byron/reading-enhance-js/webpack/runtime/define property getters","webpack://@lady-byron/reading-enhance-js/webpack/runtime/hasOwnProperty shorthand","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/app']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['common/extend']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/DiscussionListItem']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/DiscussionPage']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/PostStream']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['common/components/Link']\"","webpack://@lady-byron/reading-enhance-js/./src/forum/index.ts"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionListItem'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionPage'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/PostStream'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/components/Link'];","// js/src/forum/index.ts\nimport app from 'flarum/forum/app';\nimport { extend, override } from 'flarum/common/extend';\nimport DiscussionListItem from 'flarum/forum/components/DiscussionListItem';\nimport DiscussionPage from 'flarum/forum/components/DiscussionPage';\nimport PostStream from 'flarum/forum/components/PostStream';\nimport Link from 'flarum/common/components/Link';\n\n/** ---- 复制自 clark 插件的 blog 路由判定（简化版，内联） ---- */\nfunction shouldRedirectDiscussionToBlog(discussion: any): boolean {\n  // 没装 v17 blog 就直接 false\n  // @ts-ignore\n  if (!('v17development-blog' in flarum.extensions)) return false;\n\n  const redirects = app.forum.attribute('blogRedirectsEnabled');\n  const discussionRedirectEnabled =\n    redirects === 'both' || redirects === 'discussions_only';\n\n  const tags = discussion.tags?.() || [];\n  if (!discussionRedirectEnabled || tags.length === 0) return false;\n\n  const blogTags = app.forum.attribute<string[]>('blogTags') || [];\n\n  return tags.some((tag: any) => {\n    if (!tag) return false;\n    const parent = tag.parent?.() || null;\n    return (\n      blogTags.indexOf(tag.id?.()!) !== -1 ||\n      (parent && blogTags.indexOf(parent.id?.()!) !== -1)\n    );\n  });\n}\n/** ---------------------------------------------------------- */\n\n/** 取视口顶部完全可见的楼层号（保存“最后稳定停留处”用） */\nfunction extractTopFullyVisiblePostNumber(): number | null {\n  const items = document.querySelectorAll<HTMLElement>('.PostStream-item[data-number]');\n  for (const el of Array.from(items)) {\n    const rect = el.getBoundingClientRect();\n    if (rect.top >= 0 && rect.bottom <= (window.innerHeight || 0)) {\n      const n = parseInt(el.dataset.number || '', 10);\n      if (n > 0) return n;\n    }\n  }\n  return null;\n}\n\n/** 写库（静默失败即可） */\nfunction savePosition(discussionId: string, postNumber: number) {\n  return app\n    .request({\n      method: 'POST',\n      url: `${app.forum.attribute('apiUrl')}/ladybyron/reading-position`,\n      body: { discussionId, postNumber },\n    })\n    .catch(() => {});\n}\n\napp.initializers.add('lady-byron/reading-enhance', () => {\n  /**\n   * A) 改写“讨论列表项”里的 <Link> —— 彻底复刻 clark 的方式：\n   *    - 跳过搜索页（this.attrs.params.q 存在时不改写）\n   *    - 从 discussion.attribute('lbReadingPosition') 取“记录楼层”\n   *    - 有 blog 则生成 blog 路由；否则 app.route.discussion(discussion, near)\n   */\n  extend(DiscussionListItem.prototype, 'view', function (vdom: any) {\n    // 搜索结果有“最相关楼层”的默认逻辑；不干预\n    if ((this as any).attrs?.params?.q) return;\n\n    const discussion = (this as any).attrs?.discussion;\n    if (!discussion) return;\n\n    const recorded: number | null = discussion.attribute('lbReadingPosition') ?? null;\n    if (!recorded || recorded <= 1) return; // 没有记录或是 1 楼就不需要 near\n\n    // 与 clark 插件相同的 vnode 遍历与命中逻辑\n    (vdom.children as any[]).forEach((child: any) => {\n      if (\n        !child ||\n        !child.attrs ||\n        !child.attrs.className ||\n        child.attrs.className.indexOf('DiscussionListItem-content') === -1\n      ) {\n        return;\n      }\n\n      (child.children as any[]).forEach((sub: any) => {\n        if (!sub || sub.tag !== Link) return;\n\n        let href: string;\n\n        if (shouldRedirectDiscussionToBlog(discussion)) {\n          if (recorded > 1) {\n            href = app.route('blogArticle.near', {\n              id: discussion.slug(),\n              near: recorded,\n            });\n          } else {\n            href = app.route('blogArticle', { id: discussion.slug() });\n          }\n        } else {\n          href = app.route.discussion(discussion, recorded);\n        }\n\n        sub.attrs.href = href;\n      });\n    });\n  });\n\n  /**\n   * B) 继续使用核心“位置变更节流回调”落库\n   *    （这部分与之前一致，不影响 A 的 near 跳转）\n   */\n  override(DiscussionPage.prototype, 'view', function (original: any, ...args: any[]) {\n    const vdom = original(...args);\n\n    const inject = (node: any) => {\n      if (!node) return;\n      if (Array.isArray(node)) return node.forEach(inject);\n      if (node.children) inject(node.children);\n\n      if (node.tag === PostStream) {\n        node.attrs = node.attrs || {};\n        const prev = node.attrs.onPositionChange;\n\n        node.attrs.onPositionChange = (...cbArgs: any[]) => {\n          if (typeof prev === 'function') prev(...cbArgs);\n          if (!app.session.user) return;\n\n          const dp = this as any;\n          const discussion = dp?.discussion;\n          if (!discussion) return;\n\n          const n = extractTopFullyVisiblePostNumber();\n          if (n && typeof n === 'number') {\n            savePosition(discussion.id(), n).then(() => {\n              // 同步模型，列表改写能立刻用到最新记录\n              if (discussion.attribute('lbReadingPosition') !== n) {\n                discussion.pushAttributes({ lbReadingPosition: n });\n              }\n            });\n          }\n        };\n      }\n    };\n\n    inject(vdom);\n    return vdom;\n  });\n});\n\n"],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","flarum","core","compat","app","add","extend","DiscussionListItem","vdom","_attrs","_attrs2","_discussion$attribute","this","attrs","params","q","discussion","recorded","attribute","children","forEach","child","className","indexOf","sub","href","tag","Link","extensions","redirects","discussionRedirectEnabled","tags","length","blogTags","some","parent","id","shouldRedirectDiscussionToBlog","slug","near","override","DiscussionPage","original","_this","_len","arguments","args","Array","_key","apply","inject","node","isArray","PostStream","prev","onPositionChange","user","discussionId","postNumber","n","items","document","querySelectorAll","_i","_Array$from","from","el","rect","getBoundingClientRect","top","bottom","window","innerHeight","parseInt","dataset","number","extractTopFullyVisiblePostNumber","method","url","body","then","pushAttributes","lbReadingPosition"],"sourceRoot":""}