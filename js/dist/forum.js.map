{"version":3,"file":"forum.js","mappings":"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","sources":["webpack://@lady-byron/reading-enhance-js/webpack/bootstrap","webpack://@lady-byron/reading-enhance-js/webpack/runtime/compat get default export","webpack://@lady-byron/reading-enhance-js/webpack/runtime/define property getters","webpack://@lady-byron/reading-enhance-js/webpack/runtime/hasOwnProperty shorthand","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/app']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/states/PostStreamState']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/PostStream']\"","webpack://@lady-byron/reading-enhance-js/./src/forum/features/replyJumpInterceptor.ts","webpack://@lady-byron/reading-enhance-js/./src/forum/features/readingShortcuts.ts","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['common/extend']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/DiscussionPage']\"","webpack://@lady-byron/reading-enhance-js/./src/forum/features/readingPositionRecorder.ts","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/DiscussionListItem']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['common/components/Link']\"","webpack://@lady-byron/reading-enhance-js/./src/forum/features/discussionNavigation.ts"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/states/PostStreamState'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/PostStream'];","// js/src/forum/features/replyJumpInterceptor.ts\nimport app from 'flarum/forum/app';\nimport PostStreamState from 'flarum/forum/states/PostStreamState';\nimport PostStream from 'flarum/forum/components/PostStream';\n\n/**\n * 精确令牌拦截：\n * - 仅在“提交新回复成功（POST /posts）”后，给对应讨论 did 上一次性令牌（可消费 2~3 次滚动入口）。\n * - 在 goToNumber('reply') / scrollToNumber(newNumber) / triggerScroll等入口，命中当前讨论且目标=回复/末楼时吞掉滚动。\n * - 不影响 near 跳转、点楼号、路由初始定位等其它行为。\n */\n\ntype Token = {\n  did: string | null;\n  targetNum: number | null; // 新回复的楼号（来自 POST /posts 响应）\n  left: number;             // 可吞次数（冗余入口链路下通常 2~3 次足够）\n  expiresAt: number;        // TTL，毫秒级\n};\n\nconst token: Token = {\n  did: null,\n  targetNum: null,\n  left: 0,\n  expiresAt: 0,\n};\n\nfunction now() {\n  return Date.now();\n}\nfunction activeFor(did: string | null): boolean {\n  return (\n    !!did &&\n    token.did === did &&\n    token.left > 0 &&\n    now() < token.expiresAt\n  );\n}\nfunction arm(did: string, targetNum: number | null, ttlMs = 1800, times = 3) {\n  token.did = did;\n  token.targetNum = typeof targetNum === 'number' && targetNum > 0 ? targetNum : null;\n  token.left = Math.max(1, times);\n  token.expiresAt = now() + Math.max(300, ttlMs);\n}\nfunction consume() {\n  if (token.left > 0) token.left -= 1;\n  if (token.left <= 0) {\n    token.did = null;\n    token.targetNum = null;\n    token.expiresAt = 0;\n  }\n}\n\nfunction isReplyJump(discussion: any, target: 'reply' | number | any): boolean {\n  // 仅判断“发帖后滚动到底部/新楼”的特征\n  if (!discussion) return false;\n\n  if (target === 'reply') return true;\n\n  const last: number | null =\n    typeof discussion.lastPostNumber === 'function'\n      ? discussion.lastPostNumber()\n      : discussion.attribute?.('lastPostNumber');\n\n  if (typeof target === 'number' && target > 0) {\n    // 目标是“末楼或更后”（保守 ≥）\n    if (typeof last === 'number' && last > 0 && target >= last) return true;\n    // 若有 POST 返回的确切新楼号，用它作判定更稳\n    if (token.targetNum && target >= token.targetNum) return true;\n  }\n\n  return false;\n}\n\nfunction installRequestHook() {\n  // 只包一次\n  if ((app as any).__lbReqHooked) return;\n  (app as any).__lbReqHooked = true;\n\n  const orig = app.request.bind(app);\n\n  app.request = function (opts: any) {\n    const p = orig(opts);\n    try {\n      const method = String(opts?.method || '').toUpperCase();\n      const url = String(opts?.url || '');\n      const isCreatePost =\n        method === 'POST' &&\n        /\\/posts(?:\\?|$|\\/)/.test(url); // .../api/posts\n\n      if (!isCreatePost) return p;\n\n      return p.then((res: any) => {\n        // 解析 discussionId 与新楼号\n        const did =\n          res?.data?.relationships?.discussion?.data?.id ??\n          res?.data?.attributes?.discussionId ??\n          null;\n        const num: number | null =\n          typeof res?.data?.attributes?.number === 'number'\n            ? res.data.attributes.number\n            : null;\n\n        if (did) {\n          arm(String(did), num, 1800, 3);\n        }\n        return res;\n      });\n    } catch {\n      // 出错不影响请求链路\n      return p;\n    }\n  };\n}\n\nfunction installScrollGuards() {\n  // --- goToNumber(entry)：最早的定位入口 ---\n  const goToOrig = (PostStreamState as any).prototype.goToNumber;\n  (PostStreamState as any).prototype.goToNumber = function (target: any, ...rest: any[]) {\n    try {\n      const discussion = (this as any)?.discussion;\n      const did =\n        discussion?.id?.() ??\n        (typeof discussion?.id === 'function' ? discussion.id() : null);\n\n      if (activeFor(did) && isReplyJump(discussion, target)) {\n        consume();\n        return; // 吞掉这一次“发帖后自动滚动”\n      }\n    } catch {}\n    return goToOrig.apply(this, [target, ...rest]);\n  };\n\n  // --- PostStream.prototype.triggerScroll：滚动触发（适配不同核心版本） ---\n  const psProto: any = (PostStream as any).prototype;\n\n  if (typeof psProto.triggerScroll === 'function') {\n    const trigOrig = psProto.triggerScroll;\n    psProto.triggerScroll = function (...args: any[]) {\n      try {\n        const state = this?.attrs?.state;\n        const discussion = state?.discussion;\n        const did =\n          discussion?.id?.() ??\n          (typeof discussion?.id === 'function' ? discussion.id() : null);\n        const target =\n          state?.targetPostNumber ??\n          state?.index ??\n          (state?.visible && state.visible.number) ??\n          null;\n\n        if (activeFor(did) && isReplyJump(discussion, target)) {\n          consume();\n          return;\n        }\n      } catch {}\n      return trigOrig.apply(this, args);\n    };\n  }\n\n  // --- PostStream.prototype.scrollToNumber：另一实现路径 ---\n  if (typeof psProto.scrollToNumber === 'function') {\n    const toNumOrig = psProto.scrollToNumber;\n    psProto.scrollToNumber = function (n: number, ...rest: any[]) {\n      try {\n        const state = this?.attrs?.state;\n        const discussion = state?.discussion;\n        const did =\n          discussion?.id?.() ??\n          (typeof discussion?.id === 'function' ? discussion.id() : null);\n\n        if (activeFor(did) && isReplyJump(discussion, n)) {\n          consume();\n          return;\n        }\n      } catch {}\n      return toNumOrig.apply(this, [n, ...rest]);\n    };\n  }\n\n  // --- PostStream.prototype.scrollToIndex：极少数路径（保守） ---\n  if (typeof psProto.scrollToIndex === 'function') {\n    const toIdxOrig = psProto.scrollToIndex;\n    psProto.scrollToIndex = function (i: number, ...rest: any[]) {\n      try {\n        const state = this?.attrs?.state;\n        const discussion = state?.discussion;\n        const did =\n          discussion?.id?.() ??\n          (typeof discussion?.id === 'function' ? discussion.id() : null);\n        const approxTarget =\n          state?.visible?.number && typeof state.visible.number === 'number'\n            ? state.visible.number\n            : i;\n\n        if (activeFor(did) && isReplyJump(discussion, approxTarget)) {\n          consume();\n          return;\n        }\n      } catch {}\n      return toIdxOrig.apply(this, [i, ...rest]);\n    };\n  }\n}\n\nexport default function installReplyJumpInterceptor() {\n  app.initializers.add('lady-byron/reading-enhance-reply-jump', () => {\n    // 1) 监听“发帖成功”\n    installRequestHook();\n\n    // 2) 拦截“仅限由发帖引发的滚动”\n    installScrollGuards();\n  });\n}\n","// js/src/forum/features/readingShortcuts.ts\nimport app from 'flarum/forum/app';\n\n/**\n * 半屏/整屏翻页快捷键（桌面端优先）\n * - Shift+D  半屏下\n * - Shift+U  半屏上\n * - Shift+J  整屏下\n * - Shift+K  整屏上\n *\n * 仅在非输入/编辑状态触发；不影响弹窗、编辑器、Composer。\n */\n\ntype Options = {\n  halfRatio: number;       // 半屏比例\n  smooth: boolean;         // 是否平滑滚动\n  headerSelector: string;  // 顶栏选择器，用于抵扣可视高度\n};\n\nconst DEFAULTS: Options = {\n  halfRatio: 0.5,\n  smooth: true,\n  headerSelector: '.App-header',\n};\n\nfunction isEditableTarget(t: EventTarget | null): boolean {\n  const el = t instanceof Element ? t : null;\n  if (!el) return false;\n\n  // 常见可编辑/输入容器\n  const editable = el.closest(\n    'input, textarea, [contenteditable=\"true\"], .TextEditor, .CodeMirror, .ProseMirror, .Composer, .Modal'\n  );\n  // Composer 打开时整体禁用\n  const composerOpen = !!(app as any)?.composer?.isVisible?.();\n\n  return !!editable || composerOpen;\n}\n\nfunction headerOffsetPx(sel: string): number {\n  try {\n    const h = document.querySelector(sel);\n    return h ? h.getBoundingClientRect().height : 0;\n  } catch {\n    return 0;\n  }\n}\n\nfunction scrollByAmount(px: number, smooth: boolean) {\n  if ('scrollBy' in window) {\n    window.scrollBy({ top: px, left: 0, behavior: smooth ? 'smooth' : 'auto' });\n  } else {\n    const sc = document.scrollingElement || document.documentElement || document.body;\n    sc.scrollTop += px;\n  }\n}\n\nfunction keySig(e: KeyboardEvent): string {\n  // 只关心 Shift + 字母，不处理 Ctrl/Meta/Alt，避免系统/浏览器冲突\n  if (e.ctrlKey || e.metaKey || e.altKey) return '';\n  const parts: string[] = [];\n  if (e.shiftKey) parts.push('Shift');\n  const k = e.key.length === 1 ? e.key.toUpperCase() : e.key;\n  parts.push(k);\n  return parts.join('+');\n}\n\nexport default function installReadingShortcuts(opts?: Partial<Options>) {\n  const options: Options = Object.assign({}, DEFAULTS, opts || {});\n  let attached = false;\n\n  app.initializers.add('lady-byron/reading-enhance-shortcuts', () => {\n    if (attached) return;\n    attached = true;\n\n    const onKeydown = (e: KeyboardEvent) => {\n      // 在输入/编辑/弹窗内不触发；忽略按住不放的连发\n      if (isEditableTarget(e.target) || e.repeat) return;\n\n      const sig = keySig(e);\n      if (!sig) return;\n\n      const offset = headerOffsetPx(options.headerSelector);\n      const vh = window.innerHeight || 0;\n\n      switch (sig) {\n        case 'Shift+D': {\n          e.preventDefault(); e.stopPropagation();\n          const delta = Math.max(1, Math.round(vh * options.halfRatio) - Math.round(offset / 2));\n          scrollByAmount(delta, options.smooth);\n          break;\n        }\n        case 'Shift+U': {\n          e.preventDefault(); e.stopPropagation();\n          const delta = Math.max(1, Math.round(vh * options.halfRatio) - Math.round(offset / 2));\n          scrollByAmount(-delta, options.smooth);\n          break;\n        }\n        case 'Shift+J': {\n          e.preventDefault(); e.stopPropagation();\n          scrollByAmount(vh, options.smooth);\n          break;\n        }\n        case 'Shift+K': {\n          e.preventDefault(); e.stopPropagation();\n          scrollByAmount(-vh, options.smooth);\n          break;\n        }\n        default:\n          // 其它组合不处理\n          break;\n      }\n    };\n\n    // 捕获阶段优先处理，但不干扰其它键位\n    window.addEventListener('keydown', onKeydown, true);\n\n    // 若未来需要卸载，可暴露到全局（调试用）\n    (window as any).__lb_shortcuts = {\n      detach() {\n        window.removeEventListener('keydown', onKeydown, true);\n      },\n    };\n  });\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionPage'];","// js/src/forum/features/readingPositionRecorder.ts\nimport app from 'flarum/forum/app';\nimport { override } from 'flarum/common/extend';\nimport DiscussionPage from 'flarum/forum/components/DiscussionPage';\nimport PostStream from 'flarum/forum/components/PostStream';\n\n/**\n * 从 Flarum 提供的 onPositionChange 参数中提取楼层号\n * - 优先 number / postNumber / near\n * - 其次 visible.number\n */\nfunction derivePostNumberFromPositionChangeArgs(args: any[]): number | null {\n  for (const a of args) {\n    if (a == null) continue;\n\n    if (typeof a === 'number') {\n      if (a > 0) return a;\n    } else if (typeof a === 'object') {\n      const anyA = a as any;\n\n      if (typeof anyA.number === 'number' && anyA.number > 0) return anyA.number;\n      if (typeof anyA.postNumber === 'number' && anyA.postNumber > 0) return anyA.postNumber;\n      if (typeof anyA.near === 'number' && anyA.near > 0) return anyA.near;\n\n      if (\n        anyA.visible &&\n        typeof anyA.visible.number === 'number' &&\n        anyA.visible.number > 0\n      ) {\n        return anyA.visible.number as number;\n      }\n    }\n  }\n\n  return null;\n}\n\n/**\n * 兜底：从当前 URL 的 /d/:id/:near 或 ?near= 中提取楼层号\n */\nfunction extractNearFromUrl(): number | null {\n  try {\n    const url = new URL(window.location.href);\n\n    // /d/:id/:near\n    const parts = url.pathname.split('/').filter(Boolean);\n    const dIndex = parts.indexOf('d');\n    if (dIndex !== -1 && parts.length > dIndex + 2) {\n      const maybeNear = parseInt(parts[dIndex + 2], 10);\n      if (!Number.isNaN(maybeNear) && maybeNear > 0) return maybeNear;\n    }\n\n    // ?near=数字\n    const qNear = parseInt(url.searchParams.get('near') || '', 10);\n    if (!Number.isNaN(qNear) && qNear > 0) return qNear;\n  } catch {\n    // 忽略 URL 解析错误\n  }\n\n  return null;\n}\n\n/**\n * 写库（lb_read_post_number；静默失败即可）\n */\nfunction savePosition(discussionId: string, postNumber: number) {\n  return app\n    .request({\n      method: 'POST',\n      url: `${app.forum.attribute('apiUrl')}/ladybyron/reading-position`,\n      body: { discussionId, postNumber },\n    })\n    .catch(() => {\n      // 静默失败，不影响前端体验\n    });\n}\n\n/**\n * 200ms 轻节流 + 去重（按讨论维度）\n */\n\nconst DEBOUNCE_MS = 200;\n\nconst pendingTimerByDiscussion: Record<string, number> = Object.create(null);\nconst pendingCandidateByDiscussion: Record<string, number> = Object.create(null);\nconst lastCommittedByDiscussion: Record<string, number> = Object.create(null);\n\nfunction scheduleSaveBidirectional(discussion: any, candidate: number) {\n  const id: string = discussion.id?.() ?? discussion.id;\n  if (!id) return;\n\n  // 同一讨论内，如果 candidate 没变，就不重复 schedule\n  if (pendingCandidateByDiscussion[id] === candidate) return;\n\n  pendingCandidateByDiscussion[id] = candidate;\n\n  if (pendingTimerByDiscussion[id]) {\n    window.clearTimeout(pendingTimerByDiscussion[id]);\n  }\n\n  pendingTimerByDiscussion[id] = window.setTimeout(() => {\n    const toSend = pendingCandidateByDiscussion[id];\n    if (typeof toSend !== 'number' || toSend <= 0) return;\n\n    const current = discussion.attribute?.('lbReadingPosition') ?? 0;\n    const lastCommitted = lastCommittedByDiscussion[id] ?? current;\n\n    // 和当前记录、上一次成功写入都相同的话，就不写了\n    if (toSend === current || toSend === lastCommitted) return;\n\n    savePosition(id, toSend).then(() => {\n      lastCommittedByDiscussion[id] = toSend;\n\n      // 本地模型同步一份，方便导航增强使用\n      if (discussion.attribute && discussion.attribute('lbReadingPosition') !== toSend) {\n        discussion.pushAttributes({ lbReadingPosition: toSend });\n      }\n    });\n  }, DEBOUNCE_MS);\n}\n\nlet installed = false;\n\nexport default function installReadingPositionRecorder() {\n  if (installed) return;\n  installed = true;\n\n  app.initializers.add('lady-byron/reading-enhance-recorder', () => {\n    // 覆写 DiscussionPage.view，在 VDOM 树里找到 PostStream，挂钩 onPositionChange\n    override(DiscussionPage.prototype, 'view', function (original: any, ...args: any[]) {\n      const vdom = original(...args);\n\n      const inject = (node: any) => {\n        if (!node) return;\n\n        if (Array.isArray(node)) {\n          node.forEach(inject);\n          return;\n        }\n\n        if (node.children) inject(node.children);\n\n        if (node.tag === PostStream) {\n          node.attrs = node.attrs || {};\n          const prev = node.attrs.onPositionChange;\n\n          node.attrs.onPositionChange = (...cbArgs: any[]) => {\n            // 先让原有回调跑一遍\n            if (typeof prev === 'function') prev(...cbArgs);\n\n            // 未登录用户无需记录阅读进度\n            if (!app.session.user) return;\n\n            const dp = this as any;\n            const discussion = dp?.discussion;\n            if (!discussion) return;\n\n            // 1) 首选：从 Flarum 提供的 onPositionChange 参数里直接拿楼层号\n            let n = derivePostNumberFromPositionChangeArgs(cbArgs);\n\n            // 2) 兜底：偶发情况下从 URL 的 :near / ?near 读一次\n            if (!n) n = extractNearFromUrl();\n\n            if (n && typeof n === 'number' && n > 0) {\n              scheduleSaveBidirectional(discussion, n);\n            }\n          };\n        }\n      };\n\n      inject(vdom);\n      return vdom;\n    });\n  });\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionListItem'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/components/Link'];","// js/src/forum/features/discussionNavigation.ts\nimport app from 'flarum/forum/app';\nimport { extend } from 'flarum/common/extend';\nimport DiscussionListItem from 'flarum/forum/components/DiscussionListItem';\nimport Link from 'flarum/common/components/Link';\n\n// flarum.extensions 全局：用于检测 v17 blog\n// @ts-ignore\ndeclare const flarum: any;\n\n/** ---- v17 blog 路由判定（保持与你原来实现一致） ---- */\nfunction shouldRedirectDiscussionToBlog(discussion: any): boolean {\n  try {\n    if (!flarum || !('v17development-blog' in flarum.extensions)) return false;\n  } catch {\n    return false;\n  }\n\n  const redirects = app.forum.attribute('blogRedirectsEnabled');\n  const discussionRedirectEnabled =\n    redirects === 'both' || redirects === 'discussions_only';\n\n  const tags = discussion.tags?.() || [];\n  if (!discussionRedirectEnabled || tags.length === 0) return false;\n\n  const blogTags = app.forum.attribute<string[]>('blogTags') || [];\n\n  return tags.some((tag: any) => {\n    if (!tag) return false;\n    const parent = tag.parent?.() || null;\n    return (\n      blogTags.indexOf(tag.id?.()!) !== -1 ||\n      (parent && blogTags.indexOf(parent.id?.()!) !== -1)\n    );\n  });\n}\n\n/** ---- URL / id 工具 ---- */\n\nfunction sameOrigin(u: URL): boolean {\n  try {\n    const base = new URL(app.forum.attribute('baseUrl'));\n    return u.origin === base.origin;\n  } catch {\n    return false;\n  }\n}\n\nfunction parseDiscussionIdFromUrl(u: URL): string | null {\n  const parts = u.pathname.split('/').filter(Boolean);\n  const dIndex = parts.indexOf('d');\n  if (dIndex === -1 || parts.length <= dIndex + 1) return null;\n  const idPart = parts[dIndex + 1];\n  const match = /^(\\d+)/.exec(idPart);\n  return match ? match[1] : null;\n}\n\n/** 显式 near 识别：数字 | 'first' | 'last' | #p123 | #reply/#last/#first */\nfunction hasExplicitNear(u: URL): number | 'first' | 'last' | null {\n  const parts = u.pathname.split('/').filter(Boolean);\n  const dIndex = parts.indexOf('d');\n\n  // /d/:id/:near（数字）\n  if (dIndex !== -1 && parts.length > dIndex + 2) {\n    const n = parseInt(parts[dIndex + 2], 10);\n    if (!Number.isNaN(n) && n > 0) return n; // near=1 也视为显式\n  }\n\n  // ?near=（数字 | first | last）\n  const nearRaw = u.searchParams.get('near');\n  if (nearRaw) {\n    const n = parseInt(nearRaw, 10);\n    if (!Number.isNaN(n) && n > 0) return n;\n    const s = nearRaw.toLowerCase();\n    if (s === 'first') return 'first';\n    if (s === 'last') return 'last';\n  }\n\n  // 锚点：#p123 / #reply / #last / #first\n  if (u.hash) {\n    const h = u.hash.toLowerCase();\n    if (/^#p\\d+$/.test(h)) return parseInt(h.slice(2), 10);\n    if (h === '#reply' || h === '#last') return 'last';\n    if (h === '#first') return 'first';\n  }\n\n  return null;\n}\n\n/**\n * 从前端 store 读取阅读位置：\n * - 若 lbReadingPosition 存在（哪怕是 1），视为“扩展已接管”，完全覆盖 lastReadPostNumber\n * - 若 lb 不存在，才 fallback 到 lastReadPostNumber (>1)\n */\ntype ReadingPositionSource = 'lb' | 'last' | null;\ninterface ReadingPosition {\n  pos: number | null;\n  source: ReadingPositionSource;\n}\n\nfunction readingPositionFromStore(id: string): ReadingPosition {\n  const d = app.store.getById('discussions', id);\n  if (!d) return { pos: null, source: null };\n\n  const rawLb =\n    typeof d.attribute === 'function'\n      ? d.attribute('lbReadingPosition')\n      : (d as any).lbReadingPosition;\n\n  const rawLast =\n    typeof d.lastReadPostNumber === 'function'\n      ? d.lastReadPostNumber()\n      : typeof d.attribute === 'function'\n      ? d.attribute('lastReadPostNumber')\n      : null;\n\n  const hasLb = typeof rawLb === 'number';\n  const lbNum = hasLb ? (rawLb as number) : null;\n  const lastNum = typeof rawLast === 'number' ? (rawLast as number) : null;\n\n  if (hasLb) {\n    // 只要 lb 存在（即使是 1），就视为扩展接管，完全忽略 lastRead\n    return { pos: lbNum, source: 'lb' };\n  }\n\n  if (lastNum && lastNum > 1) {\n    return { pos: lastNum, source: 'last' };\n  }\n\n  return { pos: null, source: null };\n}\n\n/** 把 /d/:id[/slug] 改成 /d/:id[/slug]/:near（移除 ?near，去掉 #p123） */\nfunction buildNearUrl(u: URL, near: number): string {\n  const parts = u.pathname.split('/').filter(Boolean);\n  const dIndex = parts.indexOf('d');\n  if (dIndex === -1 || parts.length <= dIndex + 1) {\n    return u.pathname + u.search + u.hash;\n  }\n\n  const prefix = '/' + parts.slice(0, dIndex + 2).join('/');\n  u.pathname = `${prefix}/${near}`;\n  u.searchParams.delete('near');\n  if (u.hash && /^#p\\d+$/i.test(u.hash)) u.hash = '';\n\n  return u.pathname + u.search + u.hash;\n}\n\nlet installed = false;\n\nexport default function installDiscussionNavigation() {\n  if (installed) return;\n  installed = true;\n\n  app.initializers.add('lady-byron/reading-enhance-navigation', () => {\n    /**\n     * 1) 列表项改写（首页/标签页列表；搜索页不改，保留“最相关”体验）\n     *    这里只用 lbReadingPosition 且只在 >1 时改写，语义就是“从记录楼层继续看”\n     */\n    extend(DiscussionListItem.prototype, 'view', function (vdom: any) {\n      // 搜索页（params.q）不改写\n      if ((this as any).attrs?.params?.q) return;\n\n      const discussion = (this as any).attrs?.discussion;\n      if (!discussion) return;\n\n      const recorded: number | null = discussion.attribute('lbReadingPosition') ?? null;\n      if (!recorded || recorded <= 1) return;\n\n      (vdom.children as any[]).forEach((child: any) => {\n        if (\n          !child ||\n          !child.attrs ||\n          !child.attrs.className ||\n          child.attrs.className.indexOf('DiscussionListItem-content') === -1\n        ) {\n          return;\n        }\n\n        (child.children as any[]).forEach((sub: any) => {\n          if (!sub || sub.tag !== Link) return;\n\n          let href: string;\n\n          if (shouldRedirectDiscussionToBlog(discussion)) {\n            href =\n              recorded > 1\n                ? app.route('blogArticle.near', {\n                    id: discussion.slug(),\n                    near: recorded,\n                  })\n                : app.route('blogArticle', { id: discussion.slug() });\n          } else {\n            href = app.route.discussion(discussion, recorded);\n          }\n\n          sub.attrs = sub.attrs || {};\n          sub.attrs.href = href;\n          sub.attrs['data-lbRewritten'] = '1';\n        });\n      });\n    });\n\n    /**\n     * 2) Link.view 级别的通用 near 注入（只用 store，不打 API，不截获点击）\n     *    - 若 lb 存在：\n     *        lb > 1 → 用 lb\n     *        lb <= 1 → 明确表示“从首楼开始”，不再 fallback 到 lastRead\n     *    - 若 lb 不存在：\n     *        lastRead > 1 → 用 lastRead\n     */\n    extend(Link.prototype as any, 'view', function (vdom: any) {\n      const attrs = vdom.attrs || {};\n      if (attrs['data-lbRewritten']) return;\n\n      const href: string | undefined = attrs.href;\n      if (typeof href !== 'string' || !href.trim()) return;\n\n      let u: URL;\n      try {\n        u = new URL(href, app.forum.attribute('baseUrl'));\n      } catch {\n        return;\n      }\n\n      if (!sameOrigin(u)) return;\n\n      const explicit = hasExplicitNear(u);\n      if (explicit) return;\n\n      const id = parseDiscussionIdFromUrl(u);\n      if (!id) return;\n\n      const rp = readingPositionFromStore(id);\n\n      let near: number | null = null;\n\n      if (rp.source === 'lb') {\n        // 扩展已接管：lb > 1 才加 /near；lb <= 1 表示“从首楼开始”，不加 /1，也不看 lastRead\n        if (rp.pos && rp.pos > 1) {\n          near = rp.pos;\n        }\n      } else if (rp.source === 'last') {\n        // 没有 lb 时，才使用 lastRead > 1\n        if (rp.pos && rp.pos > 1) {\n          near = rp.pos;\n        }\n      }\n\n      if (!near || near <= 1) return;\n\n      const target = buildNearUrl(u, near);\n      vdom.attrs.href = target;\n      vdom.attrs['data-lbRewritten'] = '1';\n    });\n\n    /**\n     * 3) 钩住 app.route.discussion：所有用它生成的帖子链接都加 near（只用 store）\n     *    - 若调用方显式传了 near 参数，则尊重调用方\n     *    - 否则用 readingPositionFromStore 的结果\n     */\n    if ((app.route as any).discussion) {\n      const oldDiscussionRoute = (app.route as any).discussion.bind(app.route);\n\n      (app.route as any).discussion = function (discussion: any, near?: number) {\n        try {\n          let effectiveNear = near;\n\n          const id =\n            discussion?.id?.() ??\n            (typeof discussion?.id === 'function' ? discussion.id() : discussion?.id);\n\n          if (!effectiveNear && id) {\n            const rp = readingPositionFromStore(String(id));\n\n            if (rp.source === 'lb') {\n              if (rp.pos && rp.pos > 1) {\n                effectiveNear = rp.pos;\n              }\n            } else if (rp.source === 'last') {\n              if (rp.pos && rp.pos > 1) {\n                effectiveNear = rp.pos;\n              }\n            }\n          }\n\n          const url = oldDiscussionRoute(discussion, effectiveNear);\n\n          // 若没有有效 near，直接返回原 URL\n          if (!id || !effectiveNear || effectiveNear <= 1) {\n            return url;\n          }\n\n          try {\n            const u = new URL(url, app.forum.attribute('baseUrl'));\n            const explicit = hasExplicitNear(u);\n            if (explicit) return url;\n            const final = buildNearUrl(u, effectiveNear);\n            return final;\n          } catch {\n            return url;\n          }\n        } catch {\n          return oldDiscussionRoute(discussion, near);\n        }\n      };\n    }\n\n    /**\n     * 4) 兜底：程序化 m.route.set('/d/:id[..]') 时补一个 near（只用 store，不打 API）\n     *    逻辑同上：lb 优先，lb=1 表示“首楼”，不再 fallback 到 lastRead\n     */\n    // @ts-ignore\n    const oldSet = m.route.set.bind(m.route);\n    // @ts-ignore\n    m.route.set = function (path: string, data?: any, options?: any) {\n      try {\n        if (typeof path === 'string') {\n          const url = new URL(path, window.location.origin);\n          const parts = url.pathname.split('/').filter(Boolean);\n          const dIndex = parts.indexOf('d');\n\n          if (dIndex !== -1 && parts.length > dIndex + 1) {\n            const hasNearPath =\n              parts.length > dIndex + 2 && /^\\d+$/.test(parts[dIndex + 2]);\n            const hasNearQuery = url.searchParams.has('near'); // near=first/last 也算显式\n\n            if (!hasNearPath && !hasNearQuery) {\n              const idPart = parts[dIndex + 1];\n              const idMatch = /^(\\d+)/.exec(idPart);\n              const id = idMatch ? idMatch[1] : null;\n\n              if (id) {\n                const rp = readingPositionFromStore(id);\n                let near: number | null = null;\n\n                if (rp.source === 'lb') {\n                  if (rp.pos && rp.pos > 1) {\n                    near = rp.pos;\n                  }\n                } else if (rp.source === 'last') {\n                  if (rp.pos && rp.pos > 1) {\n                    near = rp.pos;\n                  }\n                }\n\n                if (near && near > 1) {\n                  const prefix = '/' + parts.slice(0, dIndex + 2).join('/');\n                  url.pathname = `${prefix}/${near}`;\n                  url.searchParams.delete('near');\n                  path = url.pathname + url.search + url.hash;\n                }\n              }\n            }\n          }\n        }\n      } catch {\n        // 忽略任何错误，保持原行为\n      }\n\n      // @ts-ignore\n      return oldSet(path, data, options);\n    };\n  });\n}\n"],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","flarum","core","compat","token","did","targetNum","left","expiresAt","now","Date","activeFor","consume","isReplyJump","discussion","target","last","lastPostNumber","attribute","scrollByAmount","px","smooth","window","scrollBy","top","behavior","document","scrollingElement","documentElement","body","scrollTop","pendingTimerByDiscussion","create","pendingCandidateByDiscussion","lastCommittedByDiscussion","installed","hasExplicitNear","u","parts","pathname","split","filter","Boolean","dIndex","indexOf","length","n","parseInt","Number","isNaN","nearRaw","searchParams","s","toLowerCase","hash","h","test","slice","readingPositionFromStore","id","app","getById","pos","source","rawLb","lbReadingPosition","rawLast","lastReadPostNumber","hasLb","lastNum","buildNearUrl","near","search","prefix","join","options","attached","add","orig","bind","opts","p","method","String","toUpperCase","url","then","res","_ref","_res$data$relationshi","_res$data","_res$data2","_res$data3","data","relationships","attributes","discussionId","num","number","ttlMs","times","Math","max","arm","_unused","installRequestHook","goToOrig","PostStreamState","goToNumber","_discussion$id","this","_unused2","_len","arguments","rest","Array","_key","apply","concat","psProto","PostStream","triggerScroll","trigOrig","_this$attrs","_discussion$id2","_ref2","_ref3","_state$targetPostNumb","state","attrs","targetPostNumber","index","visible","_unused3","_len2","args","_key2","scrollToNumber","toNumOrig","_this$attrs2","_discussion$id3","_unused4","_len3","_key3","scrollToIndex","toIdxOrig","i","_this$attrs3","_discussion$id4","_state$visible","approxTarget","_unused5","_len4","_key4","installScrollGuards","assign","halfRatio","headerSelector","onKeydown","e","t","_composer","el","Element","editable","closest","composerOpen","isVisible","isEditableTarget","repeat","sig","ctrlKey","metaKey","altKey","shiftKey","push","k","keySig","offset","sel","querySelector","getBoundingClientRect","height","headerOffsetPx","vh","innerHeight","preventDefault","stopPropagation","round","addEventListener","__lb_shortcuts","detach","removeEventListener","override","DiscussionPage","original","_this","vdom","inject","node","isArray","forEach","children","tag","prev","onPositionChange","cbArgs","user","_step","_iterator","_createForOfIteratorHelperLoose","done","value","anyA","postNumber","derivePostNumberFromPositionChangeArgs","URL","location","href","maybeNear","qNear","extractNearFromUrl","candidate","clearTimeout","setTimeout","_discussion$attribute","_lastCommittedByDiscu","toSend","current","lastCommitted","pushAttributes","scheduleSaveBidirectional","extend","DiscussionListItem","_attrs","_attrs2","params","q","recorded","child","className","sub","Link","extensions","redirects","discussionRedirectEnabled","tags","blogTags","some","parent","shouldRedirectDiscussionToBlog","slug","trim","base","origin","sameOrigin","idPart","match","exec","parseDiscussionIdFromUrl","rp","oldDiscussionRoute","effectiveNear","oldSet","m","route","set","path","hasNearPath","hasNearQuery","has","idMatch","_unused6"],"ignoreList":[],"sourceRoot":""}