{"version":3,"file":"forum.js","mappings":"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","sources":["webpack://@lady-byron/reading-enhance-js/webpack/bootstrap","webpack://@lady-byron/reading-enhance-js/webpack/runtime/compat get default export","webpack://@lady-byron/reading-enhance-js/webpack/runtime/define property getters","webpack://@lady-byron/reading-enhance-js/webpack/runtime/hasOwnProperty shorthand","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/app']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['common/extend']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/states/PostStreamState']\"","webpack://@lady-byron/reading-enhance-js/./src/forum/features/replyJumpInterceptor.ts","webpack://@lady-byron/reading-enhance-js/./src/forum/features/readingShortcuts.ts","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/DiscussionPage']\"","webpack://@lady-byron/reading-enhance-js/./src/forum/features/readingPositionRecorder.ts","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/DiscussionListItem']\"","webpack://@lady-byron/reading-enhance-js/./src/forum/features/discussionNavigation.ts"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/states/PostStreamState'];","// js/src/forum/features/replyJumpInterceptor.ts\nimport app from 'flarum/forum/app';\nimport { override } from 'flarum/common/extend';\nimport PostStreamState from 'flarum/forum/states/PostStreamState';\n\n/**\n * 精确令牌拦截：\n * - 仅在\"提交新回复成功（POST /api/posts）\"后，给对应讨论发一次性令牌。\n * - 在 goToNumber 入口（调用链顶端）命中当前讨论且目标=回复/末楼时吞掉滚动。\n * - 不影响 near 跳转、点楼号、路由初始定位等其它行为。\n *\n * 精简方案：\n * - 原来补丁 5 处（app.request + goToNumber + triggerScroll + scrollToNumber + scrollToIndex）\n * - 现在只需 2 处（app.request + override goToNumber），\n *   因为 goToNumber 是 ReplyComposer 成功后调用的唯一入口，下游方法由它触发。\n * - 使用 Flarum 标准 override 而非手动原型替换，正确参与扩展调用链。\n */\n\ntype Token = {\n  did: string | null;\n  targetNum: number | null;\n  left: number;\n  expiresAt: number;\n};\n\nconst token: Token = {\n  did: null,\n  targetNum: null,\n  left: 0,\n  expiresAt: 0,\n};\n\nfunction activeFor(did: string | null): boolean {\n  return (\n    !!did &&\n    token.did === did &&\n    token.left > 0 &&\n    Date.now() < token.expiresAt\n  );\n}\n\nfunction arm(did: string, targetNum: number | null, ttlMs = 1800, times = 3) {\n  token.did = did;\n  token.targetNum = typeof targetNum === 'number' && targetNum > 0 ? targetNum : null;\n  token.left = Math.max(1, times);\n  token.expiresAt = Date.now() + Math.max(300, ttlMs);\n}\n\nfunction consume() {\n  if (token.left > 0) token.left -= 1;\n  if (token.left <= 0) {\n    token.did = null;\n    token.targetNum = null;\n    token.expiresAt = 0;\n  }\n}\n\nfunction isReplyJump(discussion: any, target: any): boolean {\n  if (!discussion) return false;\n  if (target === 'reply') return true;\n\n  const last: number | null =\n    typeof discussion.lastPostNumber === 'function'\n      ? discussion.lastPostNumber()\n      : discussion.attribute?.('lastPostNumber');\n\n  if (typeof target === 'number' && target > 0) {\n    if (typeof last === 'number' && last > 0 && target >= last) return true;\n    if (token.targetNum && target >= token.targetNum) return true;\n  }\n\n  return false;\n}\n\nfunction installRequestHook() {\n  if ((app as any).__lbReqHooked) return;\n  (app as any).__lbReqHooked = true;\n\n  const orig = app.request.bind(app);\n\n  app.request = function (opts: any) {\n    const p = orig(opts);\n    try {\n      const method = String(opts?.method || '').toUpperCase();\n      const url = String(opts?.url || '');\n      // #5: 收紧正则，只匹配 Flarum 标准的 POST /api/posts 接口\n      if (method !== 'POST' || !/\\/api\\/posts(?:\\?|$)/.test(url)) return p;\n\n      return p.then((res: any) => {\n        const did =\n          res?.data?.relationships?.discussion?.data?.id ??\n          res?.data?.attributes?.discussionId ??\n          null;\n        const num: number | null =\n          typeof res?.data?.attributes?.number === 'number'\n            ? res.data.attributes.number\n            : null;\n\n        if (did) {\n          arm(String(did), num, 1800, 3);\n        }\n        return res;\n      });\n    } catch {\n      return p;\n    }\n  };\n}\n\nexport default function installReplyJumpInterceptor() {\n  app.initializers.add('lady-byron/reading-enhance-reply-jump', () => {\n    // 1) 监听\"发帖成功\"\n    installRequestHook();\n\n    // 2) 使用 Flarum 标准 override 拦截调用链顶端\n    // override 回调签名: (original, ...originalArgs)\n    override(PostStreamState.prototype, 'goToNumber', function (original: any, target: any, ...rest: any[]) {\n      try {\n        const discussion = (this as any).discussion;\n        const did =\n          typeof discussion?.id === 'function'\n            ? discussion.id()\n            : discussion?.id;\n\n        if (activeFor(did) && isReplyJump(discussion, target)) {\n          consume();\n          return;\n        }\n      } catch {\n        // 出错不影响原始行为\n      }\n      return original(target, ...rest);\n    });\n  });\n}\n","// js/src/forum/features/readingShortcuts.ts\nimport app from 'flarum/forum/app';\n\n/**\n * 半屏/整屏翻页快捷键（桌面端优先）\n * - Shift+D  半屏下\n * - Shift+U  半屏上\n * - Shift+J  整屏下\n * - Shift+K  整屏上\n *\n * 仅在非输入/编辑状态触发；不影响弹窗、编辑器、Composer。\n */\n\ntype Options = {\n  halfRatio: number;       // 半屏比例\n  smooth: boolean;         // 是否平滑滚动\n  headerSelector: string;  // 顶栏选择器，用于抵扣可视高度\n};\n\nconst DEFAULTS: Options = {\n  halfRatio: 0.5,\n  smooth: true,\n  headerSelector: '.App-header',\n};\n\nfunction isEditableTarget(t: EventTarget | null): boolean {\n  const el = t instanceof Element ? t : null;\n  if (!el) return false;\n\n  // 常见可编辑/输入容器\n  const editable = el.closest(\n    'input, textarea, [contenteditable=\"true\"], .TextEditor, .CodeMirror, .ProseMirror, .Composer, .Modal'\n  );\n  // Composer 打开时整体禁用\n  const composerOpen = !!(app as any)?.composer?.isVisible?.();\n\n  return !!editable || composerOpen;\n}\n\nfunction headerOffsetPx(sel: string): number {\n  try {\n    const h = document.querySelector(sel);\n    return h ? h.getBoundingClientRect().height : 0;\n  } catch {\n    return 0;\n  }\n}\n\nfunction scrollByAmount(px: number, smooth: boolean) {\n  if ('scrollBy' in window) {\n    window.scrollBy({ top: px, left: 0, behavior: smooth ? 'smooth' : 'auto' });\n  } else {\n    const sc = document.scrollingElement || document.documentElement || document.body;\n    sc.scrollTop += px;\n  }\n}\n\nfunction keySig(e: KeyboardEvent): string {\n  // 只关心 Shift + 字母，不处理 Ctrl/Meta/Alt，避免系统/浏览器冲突\n  if (e.ctrlKey || e.metaKey || e.altKey) return '';\n  const parts: string[] = [];\n  if (e.shiftKey) parts.push('Shift');\n  const k = e.key.length === 1 ? e.key.toUpperCase() : e.key;\n  parts.push(k);\n  return parts.join('+');\n}\n\nexport default function installReadingShortcuts(opts?: Partial<Options>) {\n  const options: Options = Object.assign({}, DEFAULTS, opts || {});\n  let attached = false;\n\n  app.initializers.add('lady-byron/reading-enhance-shortcuts', () => {\n    if (attached) return;\n    attached = true;\n\n    const onKeydown = (e: KeyboardEvent) => {\n      // 在输入/编辑/弹窗内不触发；忽略按住不放的连发\n      if (isEditableTarget(e.target) || e.repeat) return;\n\n      const sig = keySig(e);\n      if (!sig) return;\n\n      const offset = headerOffsetPx(options.headerSelector);\n      const vh = window.innerHeight || 0;\n\n      switch (sig) {\n        case 'Shift+D': {\n          e.preventDefault(); e.stopPropagation();\n          const delta = Math.max(1, Math.round(vh * options.halfRatio) - Math.round(offset / 2));\n          scrollByAmount(delta, options.smooth);\n          break;\n        }\n        case 'Shift+U': {\n          e.preventDefault(); e.stopPropagation();\n          const delta = Math.max(1, Math.round(vh * options.halfRatio) - Math.round(offset / 2));\n          scrollByAmount(-delta, options.smooth);\n          break;\n        }\n        case 'Shift+J': {\n          e.preventDefault(); e.stopPropagation();\n          // #2: 与 Shift+D/U 保持一致，扣除固定 header 高度，避免内容被遮挡\n          const downDelta = Math.max(1, vh - offset);\n          scrollByAmount(downDelta, options.smooth);\n          break;\n        }\n        case 'Shift+K': {\n          e.preventDefault(); e.stopPropagation();\n          const upDelta = Math.max(1, vh - offset);\n          scrollByAmount(-upDelta, options.smooth);\n          break;\n        }\n        default:\n          // 其它组合不处理\n          break;\n      }\n    };\n\n    // 捕获阶段优先处理，但不干扰其它键位\n    window.addEventListener('keydown', onKeydown, true);\n\n    // 若未来需要卸载，可暴露到全局（调试用）\n    (window as any).__lb_shortcuts = {\n      detach() {\n        window.removeEventListener('keydown', onKeydown, true);\n      },\n    };\n  });\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionPage'];","// js/src/forum/features/readingPositionRecorder.ts\nimport app from 'flarum/forum/app';\nimport { extend } from 'flarum/common/extend';\nimport DiscussionPage from 'flarum/forum/components/DiscussionPage';\n\n/**\n * 写库（lb_read_post_number；静默失败即可）\n */\nfunction savePosition(discussionId: string, postNumber: number) {\n  return app\n    .request({\n      method: 'POST',\n      url: `${app.forum.attribute('apiUrl')}/ladybyron/reading-position`,\n      body: { discussionId, postNumber },\n    })\n    .catch(() => {\n      // 静默失败，不影响前端体验\n    });\n}\n\n/**\n * 200ms 轻节流 + 去重（按讨论维度）\n * #10: 增加 LRU 上限，防止长时间标签页内存泄漏\n */\n\nconst DEBOUNCE_MS = 200;\nconst MAX_TRACKED = 50;\n\nconst pendingTimerByDiscussion: Record<string, number> = Object.create(null);\nconst pendingCandidateByDiscussion: Record<string, number> = Object.create(null);\nconst lastCommittedByDiscussion: Record<string, number> = Object.create(null);\nconst accessOrder: string[] = [];\n\nfunction touchLru(id: string) {\n  const idx = accessOrder.indexOf(id);\n  if (idx !== -1) accessOrder.splice(idx, 1);\n  accessOrder.push(id);\n\n  while (accessOrder.length > MAX_TRACKED) {\n    const evict = accessOrder.shift()!;\n    if (pendingTimerByDiscussion[evict]) {\n      window.clearTimeout(pendingTimerByDiscussion[evict]);\n    }\n    delete pendingTimerByDiscussion[evict];\n    delete pendingCandidateByDiscussion[evict];\n    delete lastCommittedByDiscussion[evict];\n  }\n}\n\nfunction scheduleSave(discussion: any, candidate: number) {\n  const id: string = discussion.id?.() ?? discussion.id;\n  if (!id) return;\n\n  touchLru(id);\n\n  if (pendingCandidateByDiscussion[id] === candidate) return;\n\n  pendingCandidateByDiscussion[id] = candidate;\n\n  if (pendingTimerByDiscussion[id]) {\n    window.clearTimeout(pendingTimerByDiscussion[id]);\n  }\n\n  pendingTimerByDiscussion[id] = window.setTimeout(() => {\n    const toSend = pendingCandidateByDiscussion[id];\n    if (typeof toSend !== 'number' || toSend <= 0) return;\n\n    const current = discussion.attribute?.('lbReadingPosition') ?? 0;\n    const lastCommitted = lastCommittedByDiscussion[id] ?? current;\n\n    // 和当前记录、上一次成功写入都相同的话，就不写了\n    if (toSend === current || toSend === lastCommitted) return;\n\n    savePosition(id, toSend).then(() => {\n      lastCommittedByDiscussion[id] = toSend;\n\n      // 本地模型同步，方便导航增强使用\n      if (discussion.attribute && discussion.attribute('lbReadingPosition') !== toSend) {\n        discussion.pushAttributes({ lbReadingPosition: toSend });\n      }\n    });\n  }, DEBOUNCE_MS);\n}\n\nlet installed = false;\n\nexport default function installReadingPositionRecorder() {\n  if (installed) return;\n  installed = true;\n\n  app.initializers.add('lady-byron/reading-enhance-recorder', () => {\n    const DBG = true; // ← 诊断开关\n\n    if (DBG) console.debug('[lb-rec] extending DiscussionPage.positionChanged');\n\n    extend(DiscussionPage.prototype, 'positionChanged', function (_ret: void, startNumber: number) {\n      if (!app.session.user) return;\n\n      const discussion = (this as any).discussion;\n      if (!discussion) return;\n\n      if (DBG) console.debug('[lb-rec] positionChanged fired', { startNumber, discussion: discussion.id?.() });\n\n      if (typeof startNumber === 'number' && startNumber > 0) {\n        scheduleSave(discussion, startNumber);\n      }\n    });\n  });\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionListItem'];","// js/src/forum/features/discussionNavigation.ts\nimport app from 'flarum/forum/app';\nimport { extend } from 'flarum/common/extend';\nimport DiscussionListItem from 'flarum/forum/components/DiscussionListItem';\n\n// @ts-ignore\ndeclare const flarum: any;\n\nconst DBG = true; // ← 诊断开关，定位完毕后改为 false\n\n/** ---- v17 blog 路由判定 ---- */\nfunction shouldRedirectDiscussionToBlog(discussion: any): boolean {\n  try {\n    if (!flarum || !('v17development-blog' in flarum.extensions)) return false;\n  } catch {\n    return false;\n  }\n\n  const redirects = app.forum.attribute('blogRedirectsEnabled');\n  const discussionRedirectEnabled =\n    redirects === 'both' || redirects === 'discussions_only';\n\n  const tags = discussion.tags?.() || [];\n  if (!discussionRedirectEnabled || tags.length === 0) return false;\n\n  const blogTags = app.forum.attribute<string[]>('blogTags') || [];\n\n  return tags.some((tag: any) => {\n    if (!tag) return false;\n    const tagId = tag.id?.() ?? tag.id ?? null;\n    const parent = tag.parent?.() || null;\n    const parentId = parent ? (parent.id?.() ?? parent.id ?? null) : null;\n    return (\n      (tagId != null && blogTags.indexOf(tagId) !== -1) ||\n      (parentId != null && blogTags.indexOf(parentId) !== -1)\n    );\n  });\n}\n\n/**\n * 从 store 读取有效阅读位置\n */\nfunction effectiveNearFromStore(id: string): number | null {\n  const d = app.store.getById('discussions', id);\n  if (!d) return null;\n\n  const rawLb =\n    typeof d.attribute === 'function'\n      ? d.attribute('lbReadingPosition')\n      : (d as any).lbReadingPosition;\n\n  if (typeof rawLb === 'number') {\n    return rawLb > 1 ? rawLb : null;\n  }\n\n  const rawLast =\n    typeof d.lastReadPostNumber === 'function'\n      ? d.lastReadPostNumber()\n      : typeof d.attribute === 'function'\n      ? d.attribute('lastReadPostNumber')\n      : null;\n\n  return typeof rawLast === 'number' && rawLast > 1 ? rawLast : null;\n}\n\n/**\n * 递归遍历 VDOM，把匹配 /d/{slug} 的 href 改写为 /d/{slug}/{near}。\n * 只改还没有 near 的链接（末尾不是 /数字 的）。\n */\nfunction patchDiscussionLinks(vnode: any, near: number, replacement?: string): void {\n  if (!vnode || typeof vnode !== 'object') return;\n\n  if (Array.isArray(vnode)) {\n    for (let i = 0; i < vnode.length; i++) patchDiscussionLinks(vnode[i], near, replacement);\n    return;\n  }\n\n  const href: string | undefined = vnode.attrs?.href;\n  if (typeof href === 'string' && /^\\/d\\/[^/]+$/.test(href)) {\n    vnode.attrs.href = replacement ?? href + '/' + near;\n    if (DBG) console.debug('[lb-nav] patched list-item link', { from: href, to: vnode.attrs.href });\n  }\n\n  if (vnode.children) {\n    if (Array.isArray(vnode.children)) {\n      for (let i = 0; i < vnode.children.length; i++) patchDiscussionLinks(vnode.children[i], near, replacement);\n    } else {\n      patchDiscussionLinks(vnode.children, near, replacement);\n    }\n  }\n}\n\nlet installed = false;\n\nexport default function installDiscussionNavigation() {\n  if (installed) return;\n  installed = true;\n\n  app.initializers.add('lady-byron/reading-enhance-navigation', () => {\n    // ================================================================\n    //  Layer A: 钩住 app.route.discussion\n    //  覆盖 positionChanged URL 重写 / Link 组件 / 以及其它经由此函数的调用\n    // ================================================================\n    if ((app.route as any).discussion) {\n      const origDiscussionRoute = (app.route as any).discussion.bind(app.route);\n      if (DBG) console.debug('[lb-nav] hooking app.route.discussion');\n\n      (app.route as any).discussion = function (discussion: any, near?: number) {\n        try {\n          if (!near) {\n            const id =\n              typeof discussion?.id === 'function'\n                ? discussion.id()\n                : discussion?.id;\n\n            if (id) {\n              const stored = effectiveNearFromStore(String(id));\n\n              if (stored && stored > 1 && shouldRedirectDiscussionToBlog(discussion)) {\n                try {\n                  const slug =\n                    typeof discussion.slug === 'function'\n                      ? discussion.slug()\n                      : discussion.slug;\n                  return app.route('blogArticle.near', { id: slug, near: stored });\n                } catch {\n                  // blogArticle.near 路由不存在时 fallback\n                }\n              }\n\n              if (stored) {\n                near = stored;\n              }\n            }\n          }\n        } catch {\n          // 出错时保持原始行为\n        }\n\n        return origDiscussionRoute(discussion, near);\n      };\n    } else if (DBG) {\n      console.warn('[lb-nav] app.route.discussion NOT found — Layer A skipped');\n    }\n\n    // ================================================================\n    //  Layer B: 补丁 DiscussionListItem 列表项链接\n    //  Flarum 1.8 的 DiscussionListItem 直接调用 app.route('discussion',{id:...})\n    //  而非 app.route.discussion()，Layer A 覆盖不到这里。\n    //  extend 在原 view() 之后执行，拿到已渲染的 VDOM，找到讨论链接并补上 /near。\n    // ================================================================\n    extend(DiscussionListItem.prototype, 'view', function (vdom: any) {\n      // 搜索结果不改写，保持\"最相关\"语义\n      if ((this as any).attrs?.params?.q) return;\n\n      const discussion = (this as any).attrs?.discussion;\n      if (!discussion) return;\n\n      const id = typeof discussion.id === 'function' ? discussion.id() : discussion.id;\n      if (!id) return;\n\n      const near = effectiveNearFromStore(String(id));\n      if (!near || near <= 1) return;\n\n      // Blog 兼容：如需重定向到 blog 路由则替换整个 URL\n      if (shouldRedirectDiscussionToBlog(discussion)) {\n        try {\n          const slug = typeof discussion.slug === 'function' ? discussion.slug() : discussion.slug;\n          const blogUrl = app.route('blogArticle.near', { id: slug, near });\n          patchDiscussionLinks(vdom, near, blogUrl);\n          return;\n        } catch {\n          // fallback 到普通讨论链接补丁\n        }\n      }\n\n      patchDiscussionLinks(vdom, near);\n    });\n\n    // ---- 诊断工具 ----\n    if (DBG) {\n      (window as any).__lbDebug = {\n        effectiveNearFromStore,\n        dumpStore() {\n          const all = app.store.all('discussions');\n          return all.map((d: any) => ({\n            id: d.id(),\n            slug: d.slug?.(),\n            lbReadingPosition: d.attribute('lbReadingPosition'),\n            lastReadPostNumber: d.lastReadPostNumber?.() ?? d.attribute('lastReadPostNumber'),\n          }));\n        },\n      };\n      console.debug('[lb-nav] __lbDebug ready');\n    }\n  });\n}\n"],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","flarum","core","compat","token","did","targetNum","left","expiresAt","scrollByAmount","px","smooth","window","scrollBy","top","behavior","document","scrollingElement","documentElement","body","scrollTop","pendingTimerByDiscussion","create","pendingCandidateByDiscussion","lastCommittedByDiscussion","accessOrder","installed","shouldRedirectDiscussionToBlog","discussion","extensions","_unused","redirects","app","attribute","discussionRedirectEnabled","tags","length","blogTags","some","tag","_ref","_tag$id","_ref2","_parent$id","tagId","id","parent","parentId","indexOf","effectiveNearFromStore","getById","rawLb","lbReadingPosition","rawLast","lastReadPostNumber","patchDiscussionLinks","vnode","near","replacement","_vnode$attrs","Array","isArray","i","href","attrs","test","console","debug","from","to","children","options","attached","add","orig","bind","opts","p","method","String","toUpperCase","url","then","res","_res$data$relationshi","_res$data","_res$data2","_res$data3","data","relationships","attributes","discussionId","num","number","ttlMs","times","Math","max","Date","now","arm","installRequestHook","override","PostStreamState","original","target","this","last","lastPostNumber","isReplyJump","_unused2","_len","arguments","rest","_key","apply","concat","assign","halfRatio","headerSelector","onKeydown","e","t","_composer","el","Element","editable","closest","composerOpen","isVisible","isEditableTarget","repeat","sig","ctrlKey","metaKey","altKey","parts","shiftKey","push","k","join","keySig","offset","sel","h","querySelector","getBoundingClientRect","height","headerOffsetPx","vh","innerHeight","preventDefault","stopPropagation","round","addEventListener","__lb_shortcuts","detach","removeEventListener","extend","DiscussionPage","_ret","startNumber","user","candidate","_discussion$id","idx","splice","evict","shift","clearTimeout","touchLru","setTimeout","_discussion$attribute","_lastCommittedByDiscu","toSend","postNumber","current","lastCommitted","pushAttributes","scheduleSave","origDiscussionRoute","stored","slug","_unused3","warn","DiscussionListItem","vdom","_attrs","_attrs2","params","q","_unused4","__lbDebug","dumpStore","all","map","_d$lastReadPostNumber"],"ignoreList":[],"sourceRoot":""}