{"version":3,"file":"forum.js","mappings":"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","sources":["webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/DiscussionSearchResult']\"","webpack://@lady-byron/reading-enhance-js/webpack/bootstrap","webpack://@lady-byron/reading-enhance-js/webpack/runtime/compat get default export","webpack://@lady-byron/reading-enhance-js/webpack/runtime/define property getters","webpack://@lady-byron/reading-enhance-js/webpack/runtime/hasOwnProperty shorthand","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/app']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['common/extend']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/DiscussionListItem']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/DiscussionPage']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/PostStream']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['common/components/Link']\"","webpack://@lady-byron/reading-enhance-js/./src/forum/index.ts"],"sourcesContent":["if(typeof flarum.core.compat['forum/components/DiscussionSearchResult'] === 'undefined') { var e = new Error(\"Cannot find module 'flarum.core.compat['forum/components/DiscussionSearchResult']'\"); e.code = 'MODULE_NOT_FOUND'; throw e; }\n\nmodule.exports = flarum.core.compat['forum/components/DiscussionSearchResult'];","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionListItem'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionPage'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/PostStream'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/components/Link'];","// js/src/forum/index.ts\nimport app from 'flarum/forum/app';\nimport { extend, override } from 'flarum/common/extend';\nimport DiscussionListItem from 'flarum/forum/components/DiscussionListItem';\nimport DiscussionPage from 'flarum/forum/components/DiscussionPage';\nimport PostStream from 'flarum/forum/components/PostStream';\nimport Link from 'flarum/common/components/Link';\n\n// 可选加载：有的构建下没有这个导出\nlet DiscussionSearchResult: any = null;\ntry {\n  // @ts-ignore\n  DiscussionSearchResult = require('flarum/forum/components/DiscussionSearchResult').default;\n} catch { /* noop */ }\n\n/** ===== Blog 路由判定（复刻 clark 插件逻辑） ===== */\nfunction shouldRedirectDiscussionToBlog(discussion: any): boolean {\n  // @ts-ignore: flarum.extensions 来自全局\n  if (!('v17development-blog' in flarum.extensions)) return false;\n\n  const redirects = app.forum.attribute('blogRedirectsEnabled');\n  const discussionRedirectEnabled = redirects === 'both' || redirects === 'discussions_only';\n\n  const tags = discussion.tags?.() || [];\n  if (!discussionRedirectEnabled || tags.length === 0) return false;\n\n  const blogTags: string[] = app.forum.attribute('blogTags') || [];\n\n  return tags.some((tag: any) => {\n    if (!tag) return false;\n    const parent = tag.parent?.() || null;\n    return (\n      blogTags.indexOf(tag.id?.()!) !== -1 ||\n      (parent && blogTags.indexOf(parent.id?.()!) !== -1)\n    );\n  });\n}\n\n/** 链接是否已有显式目标（尊重不改） */\nfunction hrefHasExplicitTarget(href: string): boolean {\n  return /[?&]near=\\d+/.test(href) || /\\/d\\/[^/]+\\/\\d+(?:[/?#]|$)/.test(href) || /#p\\d+/.test(href);\n}\n\n/** 生成“正确”的进入讨论链接（严格复刻插件做法，兼容 Blog） */\nfunction buildDiscussionHref(discussion: any, recorded: number | null): string {\n  const n = recorded && recorded > 1 ? recorded : 0;\n\n  if (shouldRedirectDiscussionToBlog(discussion)) {\n    if (n > 1) {\n      return app.route('blogArticle.near', { id: discussion.slug(), near: n });\n    } else {\n      return app.route('blogArticle', { id: discussion.slug() });\n    }\n  }\n\n  // 非 Blog：直接走核心\n  return app.route.discussion(discussion, n);\n}\n\n/** 视口顶部“完全可见”的楼层号（写库用） */\nfunction extractTopFullyVisiblePostNumber(): number | null {\n  const items = document.querySelectorAll<HTMLElement>('.PostStream-item[data-number]');\n  for (const el of Array.from(items)) {\n    const rect = el.getBoundingClientRect();\n    if (rect.top >= 0 && rect.bottom <= (window.innerHeight || 0)) {\n      const n = parseInt(el.dataset.number || '', 10);\n      if (n > 0) return n;\n    }\n  }\n  return null;\n}\n\n/** 写库（静默失败即可） */\nfunction savePosition(discussionId: string, postNumber: number) {\n  return app\n    .request({\n      method: 'POST',\n      url: `${app.forum.attribute('apiUrl')}/ladybyron/reading-position`,\n      body: { discussionId, postNumber },\n    })\n    .catch(() => {});\n}\n\napp.initializers.add('lady-byron/reading-enhance', () => {\n  /** A) 讨论列表：复刻 clark 的写法，直接生成 href（含 Blog 分支） */\n  extend(DiscussionListItem.prototype, 'view', function (vdom: any) {\n    const discussion = (this as any).attrs?.discussion;\n    if (!discussion) return;\n\n    const recorded: number | null = discussion.attribute('lbReadingPosition') ?? null;\n\n    // 遍历到 content 容器，再找里面的 Link（与 clark 插件一致）\n    (vdom.children as any[]).forEach((c: any) => {\n      if (!c || !c.attrs?.className || c.attrs.className.indexOf('DiscussionListItem-content') === -1) return;\n\n      (c.children as any[]).forEach((sub: any) => {\n        if (!sub || sub.tag !== Link) return;\n\n        // 若原 href 已显式指楼层，则尊重原样（不覆盖）\n        if (sub.attrs?.href && hrefHasExplicitTarget(sub.attrs.href)) return;\n\n        sub.attrs.href = buildDiscussionHref(discussion, recorded);\n      });\n    });\n  });\n\n  /** B) 搜索下拉：若组件存在，做同样的 href 生成（含 Blog 分支） */\n  if (DiscussionSearchResult && DiscussionSearchResult.prototype) {\n    extend(DiscussionSearchResult.prototype, 'view', function (vdom: any) {\n      const discussion = (this as any).attrs?.discussion;\n      if (!discussion) return;\n\n      const recorded: number | null = discussion.attribute('lbReadingPosition') ?? null;\n\n      // 搜索条目结构简单，直接找第一个 Link\n      (vdom.children as any[]).forEach((sub: any) => {\n        if (!sub || sub.tag !== Link) return;\n\n        if (sub.attrs?.href && hrefHasExplicitTarget(sub.attrs.href)) return;\n\n        sub.attrs.href = buildDiscussionHref(discussion, recorded);\n      });\n    });\n  }\n\n  /** C) 深链兜底：/d/slug 直接打开且无 near/#pN 时，替换为“正确路由” */\n  extend(DiscussionPage.prototype, 'show', function (_ret: any, discussion: any) {\n    if (!discussion) return;\n\n    const current = m.route.get();\n    if (hrefHasExplicitTarget(current)) return;\n\n    const recorded: number | null = discussion.attribute('lbReadingPosition') ?? null;\n    const target = buildDiscussionHref(discussion, recorded);\n\n    if (current !== target) {\n      m.route.set(target, undefined, { replace: true });\n    }\n  });\n\n  /** D) 实时写库：官方节流时机 */\n  override(DiscussionPage.prototype, 'view', function (original: any, ...args: any[]) {\n    const vdom = original(...args);\n\n    const inject = (node: any) => {\n      if (!node) return;\n      if (Array.isArray(node)) return node.forEach(inject);\n      if (node.children) inject(node.children);\n\n      if (node.tag === PostStream) {\n        node.attrs = node.attrs || {};\n        const prev = node.attrs.onPositionChange;\n\n        node.attrs.onPositionChange = (...cbArgs: any[]) => {\n          if (typeof prev === 'function') prev(...cbArgs);\n          if (!app.session.user) return;\n\n          const dp = this as any;\n          const discussion = dp?.discussion;\n          if (!discussion) return;\n\n          const n = extractTopFullyVisiblePostNumber();\n          if (n && typeof n === 'number') {\n            savePosition(discussion.id(), n).then(() => {\n              if (discussion.attribute('lbReadingPosition') !== n) {\n                discussion.pushAttributes({ lbReadingPosition: n });\n              }\n            });\n          }\n        };\n      }\n    };\n\n    inject(vdom);\n    return vdom;\n  });\n});\n"],"names":["flarum","core","compat","e","Error","code","module","exports","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","__webpack_modules__","n","getter","__esModule","d","a","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","DiscussionSearchResult","require","_unused","hrefHasExplicitTarget","href","test","buildDiscussionHref","discussion","recorded","extensions","redirects","app","attribute","discussionRedirectEnabled","tags","length","blogTags","some","tag","parent","indexOf","id","shouldRedirectDiscussionToBlog","slug","near","add","extend","DiscussionListItem","vdom","_attrs","_discussion$attribute","this","attrs","children","forEach","c","_c$attrs","className","sub","_sub$attrs","Link","_attrs2","_discussion$attribute2","_sub$attrs2","DiscussionPage","_ret","_discussion$attribute3","current","m","route","target","set","replace","override","original","_this","_len","arguments","args","Array","_key","apply","inject","node","isArray","PostStream","prev","onPositionChange","user","discussionId","postNumber","items","document","querySelectorAll","_i","_Array$from","from","el","rect","getBoundingClientRect","top","bottom","window","innerHeight","parseInt","dataset","number","extractTopFullyVisiblePostNumber","method","url","body","then","pushAttributes","lbReadingPosition"],"sourceRoot":""}