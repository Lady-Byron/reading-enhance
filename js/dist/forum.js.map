{"version":3,"file":"forum.js","mappings":"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","sources":["webpack://@lady-byron/reading-enhance-js/webpack/bootstrap","webpack://@lady-byron/reading-enhance-js/webpack/runtime/compat get default export","webpack://@lady-byron/reading-enhance-js/webpack/runtime/define property getters","webpack://@lady-byron/reading-enhance-js/webpack/runtime/hasOwnProperty shorthand","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/app']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/states/PostStreamState']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/PostStream']\"","webpack://@lady-byron/reading-enhance-js/./src/forum/features/replyJumpInterceptor.ts","webpack://@lady-byron/reading-enhance-js/./src/forum/features/readingShortcuts.ts","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['common/extend']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/DiscussionPage']\"","webpack://@lady-byron/reading-enhance-js/./src/forum/features/readingPositionRecorder.ts","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/DiscussionListItem']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['common/components/Link']\"","webpack://@lady-byron/reading-enhance-js/./src/forum/features/discussionNavigation.ts"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/states/PostStreamState'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/PostStream'];","// js/src/forum/features/replyJumpInterceptor.ts\nimport app from 'flarum/forum/app';\nimport PostStreamState from 'flarum/forum/states/PostStreamState';\nimport PostStream from 'flarum/forum/components/PostStream';\n\n/**\n * 精确令牌拦截：\n * - 仅在“提交新回复成功（POST /posts）”后，给对应讨论 did 上一次性令牌（可消费 2~3 次滚动入口）。\n * - 在 goToNumber('reply') / scrollToNumber(newNumber) / triggerScroll等入口，命中当前讨论且目标=回复/末楼时吞掉滚动。\n * - 不影响 near 跳转、点楼号、路由初始定位等其它行为。\n */\n\ntype Token = {\n  targetNum: number | null; // 新回复的楼号（来自 POST /posts 响应）\n  left: number;             // 可吞次数（冗余入口链路下通常 2~3 次足够）\n  expiresAt: number;        // TTL，毫秒级\n};\n\n/** 按讨论 ID 存储令牌，避免多讨论快速发帖时互相覆盖 */\nconst tokens: Record<string, Token> = Object.create(null);\n\nfunction now() {\n  return Date.now();\n}\n\nfunction getToken(did: string): Token | null {\n  const t = tokens[did];\n  if (!t) return null;\n  if (t.left <= 0 || now() >= t.expiresAt) {\n    delete tokens[did];\n    return null;\n  }\n  return t;\n}\n\nfunction activeFor(did: string | null): boolean {\n  return !!did && getToken(did) !== null;\n}\n\nfunction arm(did: string, targetNum: number | null, ttlMs = 1800, times = 3) {\n  tokens[did] = {\n    targetNum: typeof targetNum === 'number' && targetNum > 0 ? targetNum : null,\n    left: Math.max(1, times),\n    expiresAt: now() + Math.max(300, ttlMs),\n  };\n}\n\nfunction consume(did: string) {\n  const t = tokens[did];\n  if (!t) return;\n  t.left -= 1;\n  if (t.left <= 0) {\n    delete tokens[did];\n  }\n}\n\nfunction isReplyJump(discussion: any, did: string, target: 'reply' | number | any): boolean {\n  // 仅判断\"发帖后滚动到底部/新楼\"的特征\n  if (!discussion) return false;\n\n  if (target === 'reply') return true;\n\n  const last: number | null =\n    typeof discussion.lastPostNumber === 'function'\n      ? discussion.lastPostNumber()\n      : discussion.attribute?.('lastPostNumber');\n\n  if (typeof target === 'number' && target > 0) {\n    // 目标是\"末楼或更后\"（保守 ≥）\n    if (typeof last === 'number' && last > 0 && target >= last) return true;\n    // 若有 POST 返回的确切新楼号，用它作判定更稳\n    const t = getToken(did);\n    if (t?.targetNum && target >= t.targetNum) return true;\n  }\n\n  return false;\n}\n\nfunction installRequestHook() {\n  // 只包一次\n  if ((app as any).__lbReqHooked) return;\n  (app as any).__lbReqHooked = true;\n\n  const orig = app.request.bind(app);\n\n  app.request = function (opts: any) {\n    const p = orig(opts);\n    try {\n      const method = String(opts?.method || '').toUpperCase();\n      const url = String(opts?.url || '');\n      const isCreatePost =\n        method === 'POST' &&\n        /\\/posts(?:\\?|$|\\/)/.test(url); // .../api/posts\n\n      if (!isCreatePost) return p;\n\n      return p.then((res: any) => {\n        // 解析 discussionId 与新楼号\n        const did =\n          res?.data?.relationships?.discussion?.data?.id ??\n          res?.data?.attributes?.discussionId ??\n          null;\n        const num: number | null =\n          typeof res?.data?.attributes?.number === 'number'\n            ? res.data.attributes.number\n            : null;\n\n        if (did) {\n          arm(String(did), num, 1800, 3);\n        }\n        return res;\n      });\n    } catch {\n      // 出错不影响请求链路\n      return p;\n    }\n  };\n}\n\nfunction installScrollGuards() {\n  // --- goToNumber(entry)：最早的定位入口 ---\n  const goToOrig = (PostStreamState as any).prototype.goToNumber;\n  (PostStreamState as any).prototype.goToNumber = function (target: any, ...rest: any[]) {\n    try {\n      const discussion = (this as any)?.discussion;\n      const did =\n        discussion?.id?.() ??\n        (typeof discussion?.id === 'function' ? discussion.id() : null);\n\n      if (activeFor(did) && isReplyJump(discussion, did, target)) {\n        consume(did);\n        return; // 吞掉这一次\"发帖后自动滚动\"\n      }\n    } catch {}\n    return goToOrig.apply(this, [target, ...rest]);\n  };\n\n  // --- PostStream.prototype.triggerScroll：滚动触发（适配不同核心版本） ---\n  const psProto: any = (PostStream as any).prototype;\n\n  if (typeof psProto.triggerScroll === 'function') {\n    const trigOrig = psProto.triggerScroll;\n    psProto.triggerScroll = function (...args: any[]) {\n      try {\n        const state = this?.attrs?.state;\n        const discussion = state?.discussion;\n        const did =\n          discussion?.id?.() ??\n          (typeof discussion?.id === 'function' ? discussion.id() : null);\n        const target =\n          state?.targetPostNumber ??\n          state?.index ??\n          (state?.visible && state.visible.number) ??\n          null;\n\n        if (activeFor(did) && isReplyJump(discussion, did, target)) {\n          consume(did);\n          return;\n        }\n      } catch {}\n      return trigOrig.apply(this, args);\n    };\n  }\n\n  // --- PostStream.prototype.scrollToNumber：另一实现路径 ---\n  if (typeof psProto.scrollToNumber === 'function') {\n    const toNumOrig = psProto.scrollToNumber;\n    psProto.scrollToNumber = function (n: number, ...rest: any[]) {\n      try {\n        const state = this?.attrs?.state;\n        const discussion = state?.discussion;\n        const did =\n          discussion?.id?.() ??\n          (typeof discussion?.id === 'function' ? discussion.id() : null);\n\n        if (activeFor(did) && isReplyJump(discussion, did, n)) {\n          consume(did);\n          return;\n        }\n      } catch {}\n      return toNumOrig.apply(this, [n, ...rest]);\n    };\n  }\n\n  // --- PostStream.prototype.scrollToIndex：极少数路径（保守） ---\n  if (typeof psProto.scrollToIndex === 'function') {\n    const toIdxOrig = psProto.scrollToIndex;\n    psProto.scrollToIndex = function (i: number, ...rest: any[]) {\n      try {\n        const state = this?.attrs?.state;\n        const discussion = state?.discussion;\n        const did =\n          discussion?.id?.() ??\n          (typeof discussion?.id === 'function' ? discussion.id() : null);\n        const approxTarget =\n          state?.visible?.number && typeof state.visible.number === 'number'\n            ? state.visible.number\n            : i;\n\n        if (activeFor(did) && isReplyJump(discussion, did, approxTarget)) {\n          consume(did);\n          return;\n        }\n      } catch {}\n      return toIdxOrig.apply(this, [i, ...rest]);\n    };\n  }\n}\n\nexport default function installReplyJumpInterceptor() {\n  app.initializers.add('lady-byron/reading-enhance-reply-jump', () => {\n    // 1) 监听“发帖成功”\n    installRequestHook();\n\n    // 2) 拦截“仅限由发帖引发的滚动”\n    installScrollGuards();\n  });\n}\n","// js/src/forum/features/readingShortcuts.ts\nimport app from 'flarum/forum/app';\n\n/**\n * 半屏/整屏翻页快捷键（桌面端优先）\n * - Shift+D  半屏下\n * - Shift+U  半屏上\n * - Shift+J  整屏下\n * - Shift+K  整屏上\n *\n * 仅在非输入/编辑状态触发；不影响弹窗、编辑器、Composer。\n */\n\ntype Options = {\n  halfRatio: number;       // 半屏比例\n  smooth: boolean;         // 是否平滑滚动\n  headerSelector: string;  // 顶栏选择器，用于抵扣可视高度\n};\n\nconst DEFAULTS: Options = {\n  halfRatio: 0.5,\n  smooth: true,\n  headerSelector: '.App-header',\n};\n\nfunction isEditableTarget(t: EventTarget | null): boolean {\n  const el = t instanceof Element ? t : null;\n  if (!el) return false;\n\n  // 常见可编辑/输入容器\n  const editable = el.closest(\n    'input, textarea, [contenteditable=\"true\"], .TextEditor, .CodeMirror, .ProseMirror, .Composer, .Modal'\n  );\n  // Composer 打开时整体禁用\n  const composerOpen = !!(app as any)?.composer?.isVisible?.();\n\n  return !!editable || composerOpen;\n}\n\nfunction headerOffsetPx(sel: string): number {\n  try {\n    const h = document.querySelector(sel);\n    return h ? h.getBoundingClientRect().height : 0;\n  } catch {\n    return 0;\n  }\n}\n\nfunction scrollByAmount(px: number, smooth: boolean) {\n  if ('scrollBy' in window) {\n    window.scrollBy({ top: px, left: 0, behavior: smooth ? 'smooth' : 'auto' });\n  } else {\n    const sc = document.scrollingElement || document.documentElement || document.body;\n    sc.scrollTop += px;\n  }\n}\n\nfunction keySig(e: KeyboardEvent): string {\n  // 只关心 Shift + 字母，不处理 Ctrl/Meta/Alt，避免系统/浏览器冲突\n  if (e.ctrlKey || e.metaKey || e.altKey) return '';\n  const parts: string[] = [];\n  if (e.shiftKey) parts.push('Shift');\n  const k = e.key.length === 1 ? e.key.toUpperCase() : e.key;\n  parts.push(k);\n  return parts.join('+');\n}\n\nexport default function installReadingShortcuts(opts?: Partial<Options>) {\n  const options: Options = Object.assign({}, DEFAULTS, opts || {});\n  let attached = false;\n\n  app.initializers.add('lady-byron/reading-enhance-shortcuts', () => {\n    if (attached) return;\n    attached = true;\n\n    const onKeydown = (e: KeyboardEvent) => {\n      // 在输入/编辑/弹窗内不触发；忽略按住不放的连发\n      if (isEditableTarget(e.target) || e.repeat) return;\n\n      const sig = keySig(e);\n      if (!sig) return;\n\n      const offset = headerOffsetPx(options.headerSelector);\n      const vh = window.innerHeight || 0;\n\n      switch (sig) {\n        case 'Shift+D': {\n          e.preventDefault(); e.stopPropagation();\n          const delta = Math.max(1, Math.round(vh * options.halfRatio) - Math.round(offset / 2));\n          scrollByAmount(delta, options.smooth);\n          break;\n        }\n        case 'Shift+U': {\n          e.preventDefault(); e.stopPropagation();\n          const delta = Math.max(1, Math.round(vh * options.halfRatio) - Math.round(offset / 2));\n          scrollByAmount(-delta, options.smooth);\n          break;\n        }\n        case 'Shift+J': {\n          e.preventDefault(); e.stopPropagation();\n          scrollByAmount(vh, options.smooth);\n          break;\n        }\n        case 'Shift+K': {\n          e.preventDefault(); e.stopPropagation();\n          scrollByAmount(-vh, options.smooth);\n          break;\n        }\n        default:\n          // 其它组合不处理\n          break;\n      }\n    };\n\n    // 捕获阶段优先处理，但不干扰其它键位\n    window.addEventListener('keydown', onKeydown, true);\n  });\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionPage'];","// js/src/forum/features/readingPositionRecorder.ts\nimport app from 'flarum/forum/app';\nimport { override } from 'flarum/common/extend';\nimport DiscussionPage from 'flarum/forum/components/DiscussionPage';\nimport PostStream from 'flarum/forum/components/PostStream';\n\n/**\n * 从 Flarum 提供的 onPositionChange 参数中提取楼层号\n * - 优先 number / postNumber / near\n * - 其次 visible.number\n */\nfunction derivePostNumberFromPositionChangeArgs(args: any[]): number | null {\n  for (const a of args) {\n    if (a == null) continue;\n\n    if (typeof a === 'number') {\n      if (a > 0) return a;\n    } else if (typeof a === 'object') {\n      const anyA = a as any;\n\n      if (typeof anyA.number === 'number' && anyA.number > 0) return anyA.number;\n      if (typeof anyA.postNumber === 'number' && anyA.postNumber > 0) return anyA.postNumber;\n      if (typeof anyA.near === 'number' && anyA.near > 0) return anyA.near;\n\n      if (\n        anyA.visible &&\n        typeof anyA.visible.number === 'number' &&\n        anyA.visible.number > 0\n      ) {\n        return anyA.visible.number as number;\n      }\n    }\n  }\n\n  return null;\n}\n\n/**\n * 兜底：从当前 URL 的 /d/:id/:near 或 ?near= 中提取楼层号\n */\nfunction extractNearFromUrl(): number | null {\n  try {\n    const url = new URL(window.location.href);\n\n    // /d/:id/:near\n    const parts = url.pathname.split('/').filter(Boolean);\n    const dIndex = parts.indexOf('d');\n    if (dIndex !== -1 && parts.length > dIndex + 2) {\n      const maybeNear = parseInt(parts[dIndex + 2], 10);\n      if (!Number.isNaN(maybeNear) && maybeNear > 0) return maybeNear;\n    }\n\n    // ?near=数字\n    const qNear = parseInt(url.searchParams.get('near') || '', 10);\n    if (!Number.isNaN(qNear) && qNear > 0) return qNear;\n  } catch {\n    // 忽略 URL 解析错误\n  }\n\n  return null;\n}\n\n/**\n * 写库（lb_read_post_number）\n * 返回的 promise 在请求失败时 reject，由调用方决定如何处理。\n */\nfunction savePosition(discussionId: string, postNumber: number) {\n  return app.request({\n    method: 'POST',\n    url: `${app.forum.attribute('apiUrl')}/ladybyron/reading-position`,\n    body: { discussionId, postNumber },\n  });\n}\n\n/**\n * 200ms 轻节流 + 去重（按讨论维度）\n */\n\nconst DEBOUNCE_MS = 200;\n\nconst pendingTimerByDiscussion: Record<string, number> = Object.create(null);\nconst pendingCandidateByDiscussion: Record<string, number> = Object.create(null);\nconst lastCommittedByDiscussion: Record<string, number> = Object.create(null);\n\n/** 当前活跃的讨论 ID；切换讨论时清理旧条目防止内存泄漏 */\nlet activeDiscussionId: string | null = null;\n\nfunction cleanupStaleEntries(currentId: string) {\n  if (activeDiscussionId && activeDiscussionId !== currentId) {\n    const old = activeDiscussionId;\n    if (pendingTimerByDiscussion[old]) {\n      window.clearTimeout(pendingTimerByDiscussion[old]);\n    }\n    delete pendingTimerByDiscussion[old];\n    delete pendingCandidateByDiscussion[old];\n    delete lastCommittedByDiscussion[old];\n  }\n  activeDiscussionId = currentId;\n}\n\nfunction scheduleSaveBidirectional(discussion: any, candidate: number) {\n  const id: string = discussion.id?.() ?? discussion.id;\n  if (!id) return;\n\n  cleanupStaleEntries(id);\n\n  // 同一讨论内，如果 candidate 没变，就不重复 schedule\n  if (pendingCandidateByDiscussion[id] === candidate) return;\n\n  pendingCandidateByDiscussion[id] = candidate;\n\n  if (pendingTimerByDiscussion[id]) {\n    window.clearTimeout(pendingTimerByDiscussion[id]);\n  }\n\n  pendingTimerByDiscussion[id] = window.setTimeout(() => {\n    const toSend = pendingCandidateByDiscussion[id];\n    if (typeof toSend !== 'number' || toSend <= 0) return;\n\n    const current = discussion.attribute?.('lbReadingPosition') ?? 0;\n    const lastCommitted = lastCommittedByDiscussion[id] ?? current;\n\n    // 和当前记录、上一次成功写入都相同的话，就不写了\n    if (toSend === current || toSend === lastCommitted) return;\n\n    savePosition(id, toSend).then(\n      () => {\n        lastCommittedByDiscussion[id] = toSend;\n\n        // 本地模型同步一份，方便导航增强使用\n        if (discussion.attribute && discussion.attribute('lbReadingPosition') !== toSend) {\n          discussion.pushAttributes({ lbReadingPosition: toSend });\n        }\n      },\n      () => {\n        // 请求失败：不更新本地状态，下次滚动时允许重试\n      }\n    );\n  }, DEBOUNCE_MS);\n}\n\nlet installed = false;\n\nexport default function installReadingPositionRecorder() {\n  if (installed) return;\n  installed = true;\n\n  app.initializers.add('lady-byron/reading-enhance-recorder', () => {\n    // 覆写 DiscussionPage.view，在 VDOM 树里找到 PostStream，挂钩 onPositionChange\n    override(DiscussionPage.prototype, 'view', function (original: any, ...args: any[]) {\n      const vdom = original(...args);\n\n      const inject = (node: any) => {\n        if (!node) return;\n\n        if (Array.isArray(node)) {\n          node.forEach(inject);\n          return;\n        }\n\n        if (node.children) inject(node.children);\n\n        if (node.tag === PostStream) {\n          node.attrs = node.attrs || {};\n          const prev = node.attrs.onPositionChange;\n\n          node.attrs.onPositionChange = (...cbArgs: any[]) => {\n            // 先让原有回调跑一遍\n            if (typeof prev === 'function') prev(...cbArgs);\n\n            // 未登录用户无需记录阅读进度\n            if (!app.session.user) return;\n\n            const dp = this as any;\n            const discussion = dp?.discussion;\n            if (!discussion) return;\n\n            // 1) 首选：从 Flarum 提供的 onPositionChange 参数里直接拿楼层号\n            let n = derivePostNumberFromPositionChangeArgs(cbArgs);\n\n            // 2) 兜底：偶发情况下从 URL 的 :near / ?near 读一次\n            if (!n) n = extractNearFromUrl();\n\n            if (n && typeof n === 'number' && n > 0) {\n              scheduleSaveBidirectional(discussion, n);\n            }\n          };\n        }\n      };\n\n      inject(vdom);\n      return vdom;\n    });\n  });\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionListItem'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/components/Link'];","// js/src/forum/features/discussionNavigation.ts\nimport app from 'flarum/forum/app';\nimport { extend } from 'flarum/common/extend';\nimport DiscussionListItem from 'flarum/forum/components/DiscussionListItem';\nimport Link from 'flarum/common/components/Link';\n\n// flarum.extensions 全局：用于检测 v17 blog\n// @ts-ignore\ndeclare const flarum: any;\n\n/** ---- v17 blog 路由判定（保持与你原来实现一致） ---- */\nfunction shouldRedirectDiscussionToBlog(discussion: any): boolean {\n  try {\n    if (!flarum || !('v17development-blog' in flarum.extensions)) return false;\n  } catch {\n    return false;\n  }\n\n  const redirects = app.forum.attribute('blogRedirectsEnabled');\n  const discussionRedirectEnabled =\n    redirects === 'both' || redirects === 'discussions_only';\n\n  const tags = discussion.tags?.() || [];\n  if (!discussionRedirectEnabled || tags.length === 0) return false;\n\n  const blogTags = app.forum.attribute<string[]>('blogTags') || [];\n\n  return tags.some((tag: any) => {\n    if (!tag) return false;\n    const parent = tag.parent?.() || null;\n    return (\n      blogTags.indexOf(tag.id?.() ?? '') !== -1 ||\n      (parent && blogTags.indexOf(parent.id?.() ?? '') !== -1)\n    );\n  });\n}\n\n/** ---- URL / id 工具 ---- */\n\nfunction sameOrigin(u: URL): boolean {\n  try {\n    const base = new URL(app.forum.attribute('baseUrl'));\n    return u.origin === base.origin;\n  } catch {\n    return false;\n  }\n}\n\nfunction parseDiscussionIdFromUrl(u: URL): string | null {\n  const parts = u.pathname.split('/').filter(Boolean);\n  const dIndex = parts.indexOf('d');\n  if (dIndex === -1 || parts.length <= dIndex + 1) return null;\n  const idPart = parts[dIndex + 1];\n  const match = /^(\\d+)/.exec(idPart);\n  return match ? match[1] : null;\n}\n\n/** 显式 near 识别：数字 | 'first' | 'last' | #p123 | #reply/#last/#first */\nfunction hasExplicitNear(u: URL): number | 'first' | 'last' | null {\n  const parts = u.pathname.split('/').filter(Boolean);\n  const dIndex = parts.indexOf('d');\n\n  // /d/:id/:near（数字）\n  if (dIndex !== -1 && parts.length > dIndex + 2) {\n    const n = parseInt(parts[dIndex + 2], 10);\n    if (!Number.isNaN(n) && n > 0) return n; // near=1 也视为显式\n  }\n\n  // ?near=（数字 | first | last）\n  const nearRaw = u.searchParams.get('near');\n  if (nearRaw) {\n    const n = parseInt(nearRaw, 10);\n    if (!Number.isNaN(n) && n > 0) return n;\n    const s = nearRaw.toLowerCase();\n    if (s === 'first') return 'first';\n    if (s === 'last') return 'last';\n  }\n\n  // 锚点：#p123 / #reply / #last / #first\n  if (u.hash) {\n    const h = u.hash.toLowerCase();\n    if (/^#p\\d+$/.test(h)) return parseInt(h.slice(2), 10);\n    if (h === '#reply' || h === '#last') return 'last';\n    if (h === '#first') return 'first';\n  }\n\n  return null;\n}\n\n/**\n * 从前端 store 读取阅读位置：\n * - 若 lbReadingPosition 存在（哪怕是 1），视为“扩展已接管”，完全覆盖 lastReadPostNumber\n * - 若 lb 不存在，才 fallback 到 lastReadPostNumber (>1)\n */\ntype ReadingPositionSource = 'lb' | 'last' | null;\ninterface ReadingPosition {\n  pos: number | null;\n  source: ReadingPositionSource;\n}\n\nfunction readingPositionFromStore(id: string): ReadingPosition {\n  const d = app.store.getById('discussions', id);\n  if (!d) return { pos: null, source: null };\n\n  const rawLb =\n    typeof d.attribute === 'function'\n      ? d.attribute('lbReadingPosition')\n      : (d as any).lbReadingPosition;\n\n  const rawLast =\n    typeof d.lastReadPostNumber === 'function'\n      ? d.lastReadPostNumber()\n      : typeof d.attribute === 'function'\n      ? d.attribute('lastReadPostNumber')\n      : null;\n\n  const hasLb = typeof rawLb === 'number';\n  const lbNum = hasLb ? (rawLb as number) : null;\n  const lastNum = typeof rawLast === 'number' ? (rawLast as number) : null;\n\n  if (hasLb) {\n    // 只要 lb 存在（即使是 1），就视为扩展接管，完全忽略 lastRead\n    return { pos: lbNum, source: 'lb' };\n  }\n\n  if (lastNum && lastNum > 1) {\n    return { pos: lastNum, source: 'last' };\n  }\n\n  return { pos: null, source: null };\n}\n\n/** 把 /d/:id[/slug] 改成 /d/:id[/slug]/:near（移除 ?near，去掉 #p123） */\nfunction buildNearUrl(u: URL, near: number): string {\n  const parts = u.pathname.split('/').filter(Boolean);\n  const dIndex = parts.indexOf('d');\n  if (dIndex === -1 || parts.length <= dIndex + 1) {\n    return u.pathname + u.search + u.hash;\n  }\n\n  // 克隆 URL 避免修改调用方的对象\n  const clone = new URL(u.href);\n  const prefix = '/' + parts.slice(0, dIndex + 2).join('/');\n  clone.pathname = `${prefix}/${near}`;\n  clone.searchParams.delete('near');\n  if (clone.hash && /^#p\\d+$/i.test(clone.hash)) clone.hash = '';\n\n  return clone.pathname + clone.search + clone.hash;\n}\n\nlet installed = false;\n\nexport default function installDiscussionNavigation() {\n  if (installed) return;\n  installed = true;\n\n  app.initializers.add('lady-byron/reading-enhance-navigation', () => {\n    /**\n     * 1) 列表项改写（首页/标签页列表；搜索页不改，保留“最相关”体验）\n     *    这里只用 lbReadingPosition 且只在 >1 时改写，语义就是“从记录楼层继续看”\n     */\n    extend(DiscussionListItem.prototype, 'view', function (vdom: any) {\n      // 搜索页（params.q）不改写\n      if ((this as any).attrs?.params?.q) return;\n\n      const discussion = (this as any).attrs?.discussion;\n      if (!discussion) return;\n\n      const recorded: number | null = discussion.attribute('lbReadingPosition') ?? null;\n      if (!recorded || recorded <= 1) return;\n\n      (vdom.children as any[]).forEach((child: any) => {\n        if (\n          !child ||\n          !child.attrs ||\n          !child.attrs.className ||\n          child.attrs.className.indexOf('DiscussionListItem-content') === -1\n        ) {\n          return;\n        }\n\n        (child.children as any[]).forEach((sub: any) => {\n          if (!sub || sub.tag !== Link) return;\n\n          let href: string;\n\n          if (shouldRedirectDiscussionToBlog(discussion)) {\n            href =\n              recorded > 1\n                ? app.route('blogArticle.near', {\n                    id: discussion.slug(),\n                    near: recorded,\n                  })\n                : app.route('blogArticle', { id: discussion.slug() });\n          } else {\n            href = app.route.discussion(discussion, recorded);\n          }\n\n          sub.attrs = sub.attrs || {};\n          sub.attrs.href = href;\n          sub.attrs['data-lbRewritten'] = '1';\n        });\n      });\n    });\n\n    /**\n     * 2) Link.view 级别的通用 near 注入（只用 store，不打 API，不截获点击）\n     *    - 若 lb 存在：\n     *        lb > 1 → 用 lb\n     *        lb <= 1 → 明确表示“从首楼开始”，不再 fallback 到 lastRead\n     *    - 若 lb 不存在：\n     *        lastRead > 1 → 用 lastRead\n     */\n    extend(Link.prototype as any, 'view', function (vdom: any) {\n      const attrs = vdom.attrs || {};\n      if (attrs['data-lbRewritten']) return;\n\n      const href: string | undefined = attrs.href;\n      if (typeof href !== 'string' || !href.trim()) return;\n\n      let u: URL;\n      try {\n        u = new URL(href, app.forum.attribute('baseUrl'));\n      } catch {\n        return;\n      }\n\n      if (!sameOrigin(u)) return;\n\n      const explicit = hasExplicitNear(u);\n      if (explicit) return;\n\n      const id = parseDiscussionIdFromUrl(u);\n      if (!id) return;\n\n      const rp = readingPositionFromStore(id);\n\n      let near: number | null = null;\n\n      if (rp.source === 'lb') {\n        // 扩展已接管：lb > 1 才加 /near；lb <= 1 表示“从首楼开始”，不加 /1，也不看 lastRead\n        if (rp.pos && rp.pos > 1) {\n          near = rp.pos;\n        }\n      } else if (rp.source === 'last') {\n        // 没有 lb 时，才使用 lastRead > 1\n        if (rp.pos && rp.pos > 1) {\n          near = rp.pos;\n        }\n      }\n\n      if (!near || near <= 1) return;\n\n      const target = buildNearUrl(u, near);\n      vdom.attrs.href = target;\n      vdom.attrs['data-lbRewritten'] = '1';\n    });\n\n    /**\n     * 3) 钩住 app.route.discussion：所有用它生成的帖子链接都加 near（只用 store）\n     *    - 若调用方显式传了 near 参数，则尊重调用方\n     *    - 否则用 readingPositionFromStore 的结果\n     */\n    if ((app.route as any).discussion) {\n      const oldDiscussionRoute = (app.route as any).discussion.bind(app.route);\n\n      (app.route as any).discussion = function (discussion: any, near?: number) {\n        try {\n          let effectiveNear = near;\n\n          const id =\n            discussion?.id?.() ??\n            (typeof discussion?.id === 'function' ? discussion.id() : discussion?.id);\n\n          if (!effectiveNear && id) {\n            const rp = readingPositionFromStore(String(id));\n\n            if (rp.source === 'lb') {\n              if (rp.pos && rp.pos > 1) {\n                effectiveNear = rp.pos;\n              }\n            } else if (rp.source === 'last') {\n              if (rp.pos && rp.pos > 1) {\n                effectiveNear = rp.pos;\n              }\n            }\n          }\n\n          // oldDiscussionRoute 已经把 effectiveNear 编入了 URL（/d/:id/:near 格式），\n          // 无需再做 hasExplicitNear 检查或 buildNearUrl 二次改写。\n          return oldDiscussionRoute(discussion, effectiveNear);\n        } catch {\n          return oldDiscussionRoute(discussion, near);\n        }\n      };\n    }\n\n    /**\n     * 4) 兜底：程序化 m.route.set('/d/:id[..]') 时补一个 near（只用 store，不打 API）\n     *    逻辑同上：lb 优先，lb=1 表示“首楼”，不再 fallback 到 lastRead\n     */\n    // @ts-ignore\n    const oldSet = m.route.set.bind(m.route);\n    // @ts-ignore\n    m.route.set = function (path: string, data?: any, options?: any) {\n      try {\n        if (typeof path === 'string') {\n          const url = new URL(path, window.location.origin);\n          const parts = url.pathname.split('/').filter(Boolean);\n          const dIndex = parts.indexOf('d');\n\n          if (dIndex !== -1 && parts.length > dIndex + 1) {\n            const hasNearPath =\n              parts.length > dIndex + 2 && /^\\d+$/.test(parts[dIndex + 2]);\n            const hasNearQuery = url.searchParams.has('near'); // near=first/last 也算显式\n\n            if (!hasNearPath && !hasNearQuery) {\n              const idPart = parts[dIndex + 1];\n              const idMatch = /^(\\d+)/.exec(idPart);\n              const id = idMatch ? idMatch[1] : null;\n\n              if (id) {\n                const rp = readingPositionFromStore(id);\n                let near: number | null = null;\n\n                if (rp.source === 'lb') {\n                  if (rp.pos && rp.pos > 1) {\n                    near = rp.pos;\n                  }\n                } else if (rp.source === 'last') {\n                  if (rp.pos && rp.pos > 1) {\n                    near = rp.pos;\n                  }\n                }\n\n                if (near && near > 1) {\n                  const prefix = '/' + parts.slice(0, dIndex + 2).join('/');\n                  url.pathname = `${prefix}/${near}`;\n                  url.searchParams.delete('near');\n                  path = url.pathname + url.search + url.hash;\n                }\n              }\n            }\n          }\n        }\n      } catch {\n        // 忽略任何错误，保持原行为\n      }\n\n      // @ts-ignore\n      return oldSet(path, data, options);\n    };\n  });\n}\n"],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","flarum","core","compat","tokens","create","now","Date","getToken","did","t","left","expiresAt","activeFor","consume","isReplyJump","discussion","target","last","lastPostNumber","attribute","targetNum","scrollByAmount","px","smooth","window","scrollBy","top","behavior","document","scrollingElement","documentElement","body","scrollTop","pendingTimerByDiscussion","pendingCandidateByDiscussion","lastCommittedByDiscussion","activeDiscussionId","installed","readingPositionFromStore","id","app","getById","pos","source","rawLb","lbReadingPosition","rawLast","lastReadPostNumber","hasLb","lastNum","options","attached","add","orig","bind","opts","p","method","String","toUpperCase","url","test","then","res","_ref","_res$data$relationshi","_res$data","_res$data2","_res$data3","data","relationships","attributes","discussionId","num","number","ttlMs","times","Math","max","arm","_unused","installRequestHook","goToOrig","PostStreamState","goToNumber","_discussion$id","this","_unused2","_len","arguments","length","rest","Array","_key","apply","concat","psProto","PostStream","triggerScroll","trigOrig","_this$attrs","_discussion$id2","_ref2","_ref3","_state$targetPostNumb","state","attrs","targetPostNumber","index","visible","_unused3","_len2","args","_key2","scrollToNumber","toNumOrig","n","_this$attrs2","_discussion$id3","_unused4","_len3","_key3","scrollToIndex","toIdxOrig","i","_this$attrs3","_discussion$id4","_state$visible","approxTarget","_unused5","_len4","_key4","installScrollGuards","assign","halfRatio","headerSelector","addEventListener","e","_composer","el","Element","editable","closest","composerOpen","isVisible","isEditableTarget","repeat","sig","ctrlKey","metaKey","altKey","parts","shiftKey","push","k","join","keySig","offset","sel","h","querySelector","getBoundingClientRect","height","headerOffsetPx","vh","innerHeight","preventDefault","stopPropagation","round","override","DiscussionPage","original","_this","vdom","inject","node","isArray","forEach","children","tag","prev","onPositionChange","cbArgs","user","_step","_iterator","_createForOfIteratorHelperLoose","done","value","anyA","postNumber","near","derivePostNumberFromPositionChangeArgs","URL","location","href","pathname","split","filter","Boolean","dIndex","indexOf","maybeNear","parseInt","Number","isNaN","qNear","searchParams","extractNearFromUrl","candidate","currentId","old","clearTimeout","cleanupStaleEntries","setTimeout","_discussion$attribute","_lastCommittedByDiscu","toSend","current","lastCommitted","pushAttributes","scheduleSaveBidirectional","extend","DiscussionListItem","_attrs","_attrs2","params","q","recorded","child","className","sub","Link","extensions","redirects","discussionRedirectEnabled","tags","blogTags","some","_tag$id","_parent$id","parent","shouldRedirectDiscussionToBlog","slug","trim","u","base","origin","sameOrigin","explicit","nearRaw","s","toLowerCase","hash","slice","hasExplicitNear","idPart","match","exec","parseDiscussionIdFromUrl","rp","search","clone","prefix","buildNearUrl","oldDiscussionRoute","effectiveNear","oldSet","m","route","set","path","hasNearPath","hasNearQuery","has","idMatch"],"ignoreList":[],"sourceRoot":""}