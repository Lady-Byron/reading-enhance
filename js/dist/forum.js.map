{"version":3,"file":"forum.js","mappings":"MACA,IAAIA,EAAsB,CCA1BA,EAAyBC,IACxB,IAAIC,EAASD,GAAUA,EAAOE,WAC7B,IAAOF,EAAiB,QACxB,IAAM,EAEP,OADAD,EAAoBI,EAAEF,EAAQ,CAAEG,EAAGH,IAC5BA,GCLRF,EAAwB,CAACM,EAASC,KACjC,IAAI,IAAIC,KAAOD,EACXP,EAAoBS,EAAEF,EAAYC,KAASR,EAAoBS,EAAEH,EAASE,IAC5EE,OAAOC,eAAeL,EAASE,EAAK,CAAEI,YAAY,EAAMC,IAAKN,EAAWC,MCJ3ER,EAAwB,CAACc,EAAKC,IAAUL,OAAOM,UAAUC,eAAeC,KAAKJ,EAAKC,I,mBCAlF,MAAM,EAA+BI,OAAOC,KAAKC,OAAO,a,aCAxD,MAAM,EAA+BF,OAAOC,KAAKC,OAAO,iBCAlD,EAA+BF,OAAOC,KAAKC,OAAO,uC,aCAxD,MAAM,EAA+BF,OAAOC,KAAKC,OAAO,2C,aCAxD,MAAM,EAA+BF,OAAOC,KAAKC,OAAO,mC,aCAxD,MAAM,EAA+BF,OAAOC,KAAKC,OAAO,+B,aCAxD,MAAM,EAA+BF,OAAOC,KAAKC,OAAO,0B,mHCUxD,SAASC,EAAsBC,GAC7B,MAAO,eAAeC,KAAKD,IACpB,6BAA6BC,KAAKD,IAClC,QAAQC,KAAKD,EACtB,CAGA,SAASE,EAAaF,EAAcG,GAClC,IACE,IAAMC,EAAI,IAAIC,IAAIL,EAAMM,OAAOC,SAASC,QAExC,OADKJ,EAAEK,aAAaC,IAAI,SAASN,EAAEK,aAAaE,IAAI,OAAQC,OAAOT,IAC5DC,EAAES,SAAWT,EAAEU,OAASV,EAAEW,IACnC,CAAE,MAAAC,GACA,OAAOhB,GAAQA,EAAKiB,SAAS,KAAO,IAAM,KAAO,QAAUd,CAC7D,CACF,CA2BA,SAASe,EAAmBC,GAC1B,IAAKA,EAAM,OAAO,KAClB,GAAIC,MAAMC,QAAQF,GAAO,CACvB,IAAK,IAAmBG,EAAxBC,E,4rBAAAC,CAAoBL,KAAIG,EAAAC,KAAAE,MAAE,KAClBC,EAAMR,EADEI,EAAAK,OAEd,GAAID,EAAK,OAAOA,CAClB,CACA,OAAO,IACT,CACA,OAAIP,EAAKS,MAAQC,IAAaV,EAC1BA,EAAKW,SAAiBZ,EAAmBC,EAAKW,UAC3C,IACT,CAEAC,IAAAA,aAAiBC,IAAI,6BAA8B,YAKjDC,EAAAA,EAAAA,QAAOC,IAAAA,UAA8B,OAAQ,SAAUC,GAAW,IAAAC,EAAAC,EAAAC,EAC1DC,EAAgC,OAAtBH,EAAII,KAAaC,YAAK,EAAnBL,EAAqBG,WACxC,GAAKA,EAAL,CAEA,IAAMG,EAAmE,OAA5CL,EAAGE,EAAWI,UAAU,sBAAoBN,EAAI,KAC7E,GAAKK,KAAYA,GAAY,GAA7B,CAEA,IAAME,EAAO1B,EAAmBiB,GAChC,GAAKS,GAAmB,OAAXN,EAACM,EAAKH,QAALH,EAAYtC,KAA1B,CAEA,IAAM6C,EAAkBD,EAAKH,MAAMzC,KAC/BD,EAAsB8C,KAE1BD,EAAKH,MAAMzC,KAAOE,EAAa2C,EAASH,GALF,CAHA,CAHf,CAYzB,IAMAT,EAAAA,EAAAA,QAAOa,IAAAA,UAAkC,OAAQ,SAAUX,GAAW,IAAAY,EAAAC,EAAAC,EAC9DV,EAAgC,OAAtBQ,EAAIP,KAAaC,YAAK,EAAnBM,EAAqBR,WACxC,GAAKA,EAAL,CAEA,IAAMG,EAAmE,OAA5CM,EAAGT,EAAWI,UAAU,sBAAoBK,EAAI,KAC7E,GAAKN,KAAYA,GAAY,GAA7B,CAEA,IAAME,EAAO1B,EAAmBiB,GAChC,GAAKS,GAAmB,OAAXK,EAACL,EAAKH,QAALQ,EAAYjD,KAA1B,CAEA,IAAM6C,EAAkBD,EAAKH,MAAMzC,KAC/BD,EAAsB8C,KAE1BD,EAAKH,MAAMzC,KAAOE,EAAa2C,EAASH,GALF,CAHA,CAHf,CAYzB,IAOAT,EAAAA,EAAAA,QAAOiB,IAAAA,UAA0B,OAAQ,SAAUC,EAAQZ,GAAiB,IAAAa,EAC1E,GAAKb,EAAL,CAEA,IAAMc,EAAUC,EAAEC,MAAMjE,MACxB,IAAIS,EAAsBsD,GAA1B,CAEA,IAAMX,EAAmE,OAA5CU,EAAGb,EAAWI,UAAU,sBAAoBS,EAAI,KAC7E,GAAKV,KAAYA,GAAY,GAA7B,CAEA,IAAMc,EAAStD,EAAa6B,IAAAA,MAAUQ,WAAWA,GAAaG,GAC1DW,IAAYG,GACdF,EAAEC,MAAM5C,IAAI6C,OAAQC,EAAW,CAAEC,SAAS,GAJN,CAHI,CAHnB,CAYzB,IAKAC,EAAAA,EAAAA,UAAST,IAAAA,UAA0B,OAAQ,SAAUU,GAA+B,QAAAC,EAAA,KAAAC,EAAAC,UAAAC,OAAbC,EAAI,IAAA7C,MAAA0C,EAAA,EAAAA,EAAA,KAAAI,EAAA,EAAAA,EAAAJ,EAAAI,IAAJD,EAAIC,EAAA,GAAAH,UAAAG,GACzE,IAAM/B,EAAOyB,EAAQO,WAAC,EAAGF,GAEnBG,EAAS,SAACjD,GACd,GAAKA,EAAL,CACA,GAAIC,MAAMC,QAAQF,GAAO,OAAOA,EAAKkD,QAAQD,GAG7C,GAFIjD,EAAKW,UAAUsC,EAAOjD,EAAKW,UAE3BX,EAAKS,MAAQ0C,IAAY,CAC3BnD,EAAKsB,MAAQtB,EAAKsB,OAAS,CAAC,EAC5B,IAAM8B,EAAOpD,EAAKsB,MAAM+B,iBAExBrD,EAAKsB,MAAM+B,iBAAmB,WAE5B,GADoB,mBAATD,GAAqBA,EAAIJ,WAAC,EAADJ,WAC/BhC,IAAAA,QAAY0C,KAAjB,CAEA,IACMlC,EAAe,MADVsB,OACU,EADVA,EACYtB,WACvB,GAAKA,EAAL,CAEA,IA7GYmC,EAAsBC,EA6G5BC,EA1HhB,WAEE,IADA,IAAMC,EAAQC,SAASC,iBAA8B,iCACrDC,EAAA,EAAAC,EAAiB7D,MAAM8D,KAAKL,GAAMG,EAAAC,EAAAjB,OAAAgB,IAAE,CAA/B,IAAMG,EAAEF,EAAAD,GACLI,EAAOD,EAAGE,wBAChB,GAAID,EAAKE,KAAO,GAAKF,EAAKG,SAAWjF,OAAOkF,aAAe,GAAI,CAC7D,IAAMZ,EAAIa,SAASN,EAAGO,QAAQC,QAAU,GAAI,IAC5C,GAAIf,EAAI,EAAG,OAAOA,CACpB,CACF,CACA,OAAO,IACT,CAgHoBgB,GACNhB,GAAkB,iBAANA,IA9GJF,EA+GGnC,EAAWsD,KA/GQlB,EA+GFC,EA9GjC7C,IAAAA,QACI,CACP+D,OAAQ,OACRC,IAAQhE,IAAAA,MAAUY,UAAU,UAAS,8BACrCqD,KAAM,CAAEtB,aAAAA,EAAcC,WAAAA,KACtB,MACK,WAAO,IAwG2BsB,KAAK,WAChC1D,EAAWI,UAAU,uBAAyBiC,GAChDrC,EAAW2D,eAAe,CAAEC,kBAAmBvB,GAEnD,EARqB,CAJM,CAc/B,CACF,CAzBiB,CA0BnB,EAGA,OADAR,EAAOjC,GACAA,CACT,EACF,E","sources":["webpack://@lady-byron/reading-enhance-js/webpack/bootstrap","webpack://@lady-byron/reading-enhance-js/webpack/runtime/compat get default export","webpack://@lady-byron/reading-enhance-js/webpack/runtime/define property getters","webpack://@lady-byron/reading-enhance-js/webpack/runtime/hasOwnProperty shorthand","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/app']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['common/extend']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/DiscussionListItem']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/DiscussionSearchResult']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/DiscussionPage']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['forum/components/PostStream']\"","webpack://@lady-byron/reading-enhance-js/external root \"flarum.core.compat['common/components/Link']\"","webpack://@lady-byron/reading-enhance-js/./src/forum/index.ts"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionListItem'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionSearchResult'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionPage'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/PostStream'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/components/Link'];","// js/src/forum/index.ts\nimport app from 'flarum/forum/app';\nimport { extend, override } from 'flarum/common/extend';\nimport DiscussionListItem from 'flarum/forum/components/DiscussionListItem';\nimport DiscussionSearchResult from 'flarum/forum/components/DiscussionSearchResult';\nimport DiscussionPage from 'flarum/forum/components/DiscussionPage';\nimport PostStream from 'flarum/forum/components/PostStream';\nimport Link from 'flarum/common/components/Link';\n\n/** —— 工具：判断链接是否已有显式目标（尊重不改） —— */\nfunction linkHasExplicitTarget(href: string): boolean {\n  return /[?&]near=\\d+/.test(href)        // ?near=123\n      || /\\/d\\/[^/]+\\/\\d+(?:[/?#]|$)/.test(href) // /d/slug-or-id/123\n      || /#p\\d+/.test(href);              // #p123\n}\n\n/** 给已有 href 追加 near（相对/绝对 href 都可） */\nfunction hrefWithNear(href: string, near: number): string {\n  try {\n    const u = new URL(href, window.location.origin);\n    if (!u.searchParams.has('near')) u.searchParams.set('near', String(near));\n    return u.pathname + u.search + u.hash; // 返回相对地址，避免整页刷新\n  } catch {\n    return href + (href.includes('?') ? '&' : '?') + 'near=' + near;\n  }\n}\n\n/** 取“视口顶部完全可见”的楼层号（作为“最后稳定停留处”） */\nfunction extractTopFullyVisiblePostNumber(): number | null {\n  const items = document.querySelectorAll<HTMLElement>('.PostStream-item[data-number]');\n  for (const el of Array.from(items)) {\n    const rect = el.getBoundingClientRect();\n    if (rect.top >= 0 && rect.bottom <= (window.innerHeight || 0)) {\n      const n = parseInt(el.dataset.number || '', 10);\n      if (n > 0) return n;\n    }\n  }\n  return null;\n}\n\n/** 写库（静默失败即可） */\nfunction savePosition(discussionId: string, postNumber: number) {\n  return app\n    .request({\n      method: 'POST',\n      url: `${app.forum.attribute('apiUrl')}/ladybyron/reading-position`,\n      body: { discussionId, postNumber },\n    })\n    .catch(() => {});\n}\n\n/** 递归在 vnode 树里找第一个 <Link> 节点 */\nfunction findFirstLinkVNode(node: any): any | null {\n  if (!node) return null;\n  if (Array.isArray(node)) {\n    for (const child of node) {\n      const hit = findFirstLinkVNode(child);\n      if (hit) return hit;\n    }\n    return null;\n  }\n  if (node.tag === Link) return node;\n  if (node.children) return findFirstLinkVNode(node.children);\n  return null;\n}\n\napp.initializers.add('lady-byron/reading-enhance', () => {\n  /**\n   * A. 讨论列表入口（首页、标签、关注/未读等都复用 DiscussionListItem）\n   *    若链接无显式目标且我们有记录值，则在 <Link> 上注入 ?near=记录楼层\n   */\n  extend(DiscussionListItem.prototype, 'view', function (vdom: any) {\n    const discussion = (this as any).attrs?.discussion;\n    if (!discussion) return;\n\n    const recorded: number | null = discussion.attribute('lbReadingPosition') ?? null;\n    if (!recorded || recorded <= 1) return;\n\n    const link = findFirstLinkVNode(vdom);\n    if (!link || !link.attrs?.href) return;\n\n    const oldHref: string = link.attrs.href;\n    if (linkHasExplicitTarget(oldHref)) return; // 已经指明楼层，尊重\n\n    link.attrs.href = hrefWithNear(oldHref, recorded);\n  });\n\n  /**\n   * B. 搜索结果入口（快速搜索下拉 & 搜索页都用 DiscussionSearchResult）\n   *    同样规则：只在“无显式目标且我们有记录值”时追加 near\n   */\n  extend(DiscussionSearchResult.prototype, 'view', function (vdom: any) {\n    const discussion = (this as any).attrs?.discussion;\n    if (!discussion) return;\n\n    const recorded: number | null = discussion.attribute('lbReadingPosition') ?? null;\n    if (!recorded || recorded <= 1) return;\n\n    const link = findFirstLinkVNode(vdom);\n    if (!link || !link.attrs?.href) return;\n\n    const oldHref: string = link.attrs.href;\n    if (linkHasExplicitTarget(oldHref)) return;\n\n    link.attrs.href = hrefWithNear(oldHref, recorded);\n  });\n\n  /**\n   * C. 深链兜底：用户直接打开 /d/slug（没有 near/#pN）时\n   *    在 DiscussionPage.show 里用 replace 把 URL 替换为带 near 的版本，\n   *    再交给核心 Resolver 完成定位（不会污染历史栈）\n   */\n  extend(DiscussionPage.prototype, 'show', function (_: any, discussion: any) {\n    if (!discussion) return;\n\n    const current = m.route.get();\n    if (linkHasExplicitTarget(current)) return; // 有显式目标就尊重\n\n    const recorded: number | null = discussion.attribute('lbReadingPosition') ?? null;\n    if (!recorded || recorded <= 1) return;\n\n    const target = hrefWithNear(app.route.discussion(discussion), recorded);\n    if (current !== target) {\n      m.route.set(target, undefined, { replace: true });\n    }\n  });\n\n  /**\n   * D. 继续使用核心“位置变更节流回调”实时写库\n   */\n  override(DiscussionPage.prototype, 'view', function (original: any, ...args: any[]) {\n    const vdom = original(...args);\n\n    const inject = (node: any) => {\n      if (!node) return;\n      if (Array.isArray(node)) return node.forEach(inject);\n      if (node.children) inject(node.children);\n\n      if (node.tag === PostStream) {\n        node.attrs = node.attrs || {};\n        const prev = node.attrs.onPositionChange;\n\n        node.attrs.onPositionChange = (...cbArgs: any[]) => {\n          if (typeof prev === 'function') prev(...cbArgs);\n          if (!app.session.user) return;\n\n          const dp = this as any;\n          const discussion = dp?.discussion;\n          if (!discussion) return;\n\n          const n = extractTopFullyVisiblePostNumber();\n          if (n && typeof n === 'number') {\n            savePosition(discussion.id(), n).then(() => {\n              if (discussion.attribute('lbReadingPosition') !== n) {\n                discussion.pushAttributes({ lbReadingPosition: n });\n              }\n            });\n          }\n        };\n      }\n    };\n\n    inject(vdom);\n    return vdom;\n  });\n});\n"],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","flarum","core","compat","linkHasExplicitTarget","href","test","hrefWithNear","near","u","URL","window","location","origin","searchParams","has","set","String","pathname","search","hash","_unused","includes","findFirstLinkVNode","node","Array","isArray","_step","_iterator","_createForOfIteratorHelperLoose","done","hit","value","tag","Link","children","app","add","extend","DiscussionListItem","vdom","_attrs","_discussion$attribute","_link$attrs","discussion","this","attrs","recorded","attribute","link","oldHref","DiscussionSearchResult","_attrs2","_discussion$attribute2","_link$attrs2","DiscussionPage","_","_discussion$attribute3","current","m","route","target","undefined","replace","override","original","_this","_len","arguments","length","args","_key","apply","inject","forEach","PostStream","prev","onPositionChange","user","discussionId","postNumber","n","items","document","querySelectorAll","_i","_Array$from","from","el","rect","getBoundingClientRect","top","bottom","innerHeight","parseInt","dataset","number","extractTopFullyVisiblePostNumber","id","method","url","body","then","pushAttributes","lbReadingPosition"],"sourceRoot":""}