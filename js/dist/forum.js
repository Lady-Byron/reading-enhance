(()=>{var t={n:e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return t.d(n,{a:n}),n},d:(e,n)=>{for(var o in n)t.o(n,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:n[o]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};(()=>{"use strict";const e=flarum.core.compat["forum/app"];var n=t.n(e);const o=flarum.core.compat["common/extend"],r=flarum.core.compat["forum/states/PostStreamState"];var i=t.n(r),u={did:null,targetNum:null,left:0,expiresAt:0};function l(t,e){"scrollBy"in window?window.scrollBy({top:t,left:0,behavior:e?"smooth":"auto"}):(document.scrollingElement||document.documentElement||document.body).scrollTop+=t}const a=flarum.core.compat["forum/components/DiscussionPage"];var s=t.n(a),d=Object.create(null),c=Object.create(null),f=Object.create(null),b=[];var p=!1;const v=flarum.core.compat["forum/components/DiscussionListItem"];var m=t.n(v);function g(t){var e=n().store.getById("discussions",t);if(!e)return null;var o="function"==typeof e.attribute?e.attribute("lbReadingPosition"):e.lbReadingPosition;if("number"==typeof o)return o>1?o:null;var r="function"==typeof e.lastReadPostNumber?e.lastReadPostNumber():"function"==typeof e.attribute?e.attribute("lastReadPostNumber"):null;return"number"==typeof r&&r>1?r:null}var h,y,w=!1,P=!1;n().initializers.add("lady-byron/reading-enhance-reply-jump",function(){(function(){if(!n().__lbReqHooked){n().__lbReqHooked=!0;var t=n().request.bind(n());n().request=function(e){var n=t(e);try{var o=String((null==e?void 0:e.method)||"").toUpperCase(),r=String((null==e?void 0:e.url)||"");return"POST"===o&&/\/api\/posts(?:\?|$)/.test(r)?n.then(function(t){var e,n,o,r,i,l=null!=(e=null!=(n=null==t||null==(o=t.data)||null==(o=o.relationships)||null==(o=o.discussion)||null==(o=o.data)?void 0:o.id)?n:null==t||null==(r=t.data)||null==(r=r.attributes)?void 0:r.discussionId)?e:null,a="number"==typeof(null==t||null==(i=t.data)||null==(i=i.attributes)?void 0:i.number)?t.data.attributes.number:null;return l&&function(t,e,n,o){void 0===n&&(n=1800),void 0===o&&(o=3),u.did=t,u.targetNum="number"==typeof e&&e>0?e:null,u.left=Math.max(1,o),u.expiresAt=Date.now()+Math.max(300,n)}(String(l),a,1800,3),t}):n}catch(t){return n}}}})(),(0,o.override)(i().prototype,"goToNumber",function(t,e){try{var n=this.discussion;if((o="function"==typeof(null==n?void 0:n.id)?n.id():null==n?void 0:n.id)&&u.did===o&&u.left>0&&Date.now()<u.expiresAt&&function(t,e){if(!t)return!1;if("reply"===e)return!0;var n="function"==typeof t.lastPostNumber?t.lastPostNumber():null==t.attribute?void 0:t.attribute("lastPostNumber");if("number"==typeof e&&e>0){if("number"==typeof n&&n>0&&e>=n)return!0;if(u.targetNum&&e>=u.targetNum)return!0}return!1}(n,e))return u.left>0&&(u.left-=1),void(u.left<=0&&(u.did=null,u.targetNum=null,u.expiresAt=0))}catch(t){}for(var o,r=arguments.length,i=new Array(r>2?r-2:0),l=2;l<r;l++)i[l-2]=arguments[l];return t.apply(void 0,[e].concat(i))})}),h=Object.assign({},{halfRatio:.5,smooth:!0,headerSelector:".App-header"},{}),y=!1,n().initializers.add("lady-byron/reading-enhance-shortcuts",function(){if(!y){y=!0;var t=function(t){if(!function(t){var e,o=t instanceof Element?t:null;if(!o)return!1;var r=o.closest('input, textarea, [contenteditable="true"], .TextEditor, .CodeMirror, .ProseMirror, .Composer, .Modal'),i=!(null==n()||null==(e=n().composer)||null==e.isVisible||!e.isVisible());return!!r||i}(t.target)&&!t.repeat){var e=function(t){if(t.ctrlKey||t.metaKey||t.altKey)return"";var e=[];t.shiftKey&&e.push("Shift");var n=1===t.key.length?t.key.toUpperCase():t.key;return e.push(n),e.join("+")}(t);if(e){var o=function(t){try{var e=document.querySelector(t);return e?e.getBoundingClientRect().height:0}catch(t){return 0}}(h.headerSelector),r=window.innerHeight||0;switch(e){case"Shift+D":t.preventDefault(),t.stopPropagation(),l(Math.max(1,Math.round(r*h.halfRatio)-Math.round(o/2)),h.smooth);break;case"Shift+U":t.preventDefault(),t.stopPropagation(),l(-Math.max(1,Math.round(r*h.halfRatio)-Math.round(o/2)),h.smooth);break;case"Shift+J":t.preventDefault(),t.stopPropagation(),l(Math.max(1,r-o),h.smooth);break;case"Shift+K":t.preventDefault(),t.stopPropagation(),l(-Math.max(1,r-o),h.smooth)}}}};window.addEventListener("keydown",t,!0),window.__lb_shortcuts={detach:function(){window.removeEventListener("keydown",t,!0)}}}}),p||(p=!0,n().initializers.add("lady-byron/reading-enhance-recorder",function(){console.debug("[lb-rec] extending DiscussionPage.positionChanged"),(0,o.extend)(s().prototype,"positionChanged",function(t,e){if(n().session.user){var o=this.discussion;o&&(console.debug("[lb-rec] positionChanged fired",{startNumber:e,discussion:null==o.id?void 0:o.id()}),"number"==typeof e&&e>0&&function(t,e){var o,r=null!=(o=null==t.id?void 0:t.id())?o:t.id;r&&(function(t){var e=b.indexOf(t);for(-1!==e&&b.splice(e,1),b.push(t);b.length>50;){var n=b.shift();d[n]&&window.clearTimeout(d[n]),delete d[n],delete c[n],delete f[n]}}(r),c[r]!==e&&(c[r]=e,d[r]&&window.clearTimeout(d[r]),d[r]=window.setTimeout(function(){var e,o,i=c[r];if(!("number"!=typeof i||i<=0)){var u,l,a=null!=(e=null==t.attribute?void 0:t.attribute("lbReadingPosition"))?e:0,s=null!=(o=f[r])?o:a;i!==a&&i!==s&&(u=r,l=i,n().request({method:"POST",url:n().forum.attribute("apiUrl")+"/ladybyron/reading-position",body:{discussionId:u,postNumber:l}}).catch(function(){})).then(function(){f[r]=i,t.attribute&&t.attribute("lbReadingPosition")!==i&&t.pushAttributes({lbReadingPosition:i})})}},200)))}(o,e))}})})),P||(P=!0,n().initializers.add("lady-byron/reading-enhance-navigation",function(){var t=!!n().route.discussion;if(console.debug("[lb-nav] init: app.route.discussion exists?",t),console.debug("[lb-nav] init: typeof app.route =",typeof n().route),console.debug("[lb-nav] init: app.route keys =",Object.keys(n().route)),t){var e=n().route.discussion.bind(n().route);console.debug("[lb-nav] hook installed, origDiscussionRoute =",e),n().route.discussion=function(t,o){try{if(w)return e(t,o);if(o)console.debug("[lb-nav] route.discussion called with explicit near",{near:o});else{var r="function"==typeof(null==t?void 0:t.id)?t.id():null==t?void 0:t.id;if(r){var i=g(String(r));if(console.debug("[lb-nav] route.discussion called",{id:r,nearArg:o,stored:i,discussion:t}),i&&i>1&&function(t){try{if(!flarum||!("v17development-blog"in flarum.extensions))return!1}catch(t){return!1}var e=n().forum.attribute("blogRedirectsEnabled"),o="both"===e||"discussions_only"===e,r=(null==t.tags?void 0:t.tags())||[];if(!o||0===r.length)return!1;var i=n().forum.attribute("blogTags")||[];return r.some(function(t){var e,n,o,r;if(!t)return!1;var u=null!=(e=null!=(n=null==t.id?void 0:t.id())?n:t.id)?e:null,l=(null==t.parent?void 0:t.parent())||null,a=l&&null!=(o=null!=(r=null==l.id?void 0:l.id())?r:l.id)?o:null;return null!=u&&-1!==i.indexOf(u)||null!=a&&-1!==i.indexOf(a)})}(t))try{var u="function"==typeof t.slug?t.slug():t.slug;return n().route("blogArticle.near",{id:u,near:i})}catch(t){}i&&(o=i)}}}catch(t){console.error("[lb-nav] hook error",t)}var l=e(t,o);return console.debug("[lb-nav] final URL =",l,"(near =",o,")"),l},(0,o.override)(m().prototype,"view",function(t){var e;if(null!=(e=this.attrs)&&null!=(e=e.params)&&e.q){w=!0;try{return t()}finally{w=!1}}return t()}),window.__lbDebug={effectiveNearFromStore:g,dumpStore:function(){return n().store.all("discussions").map(function(t){var e;return{id:t.id(),slug:null==t.slug?void 0:t.slug(),lbReadingPosition:t.attribute("lbReadingPosition"),lastReadPostNumber:null!=(e=null==t.lastReadPostNumber?void 0:t.lastReadPostNumber())?e:t.attribute("lastReadPostNumber")}})},testRoute:function(t){var o=n().store.getById("discussions",t);return o?{near:g(t),url:e(o),urlWithNear:e(o,g(t))}:"discussion not in store"}},console.debug('[lb-nav] window.__lbDebug ready — try __lbDebug.dumpStore() or __lbDebug.testRoute("123")')}else console.warn("[lb-nav] app.route.discussion NOT found — hook aborted")}))})(),module.exports={}})();
//# sourceMappingURL=forum.js.map