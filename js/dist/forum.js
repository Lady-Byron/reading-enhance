(()=>{var r={n:t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return r.d(e,{a:e}),e},d:(t,e)=>{for(var n in e)r.o(e,n)&&!r.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},o:(r,t)=>Object.prototype.hasOwnProperty.call(r,t)};(()=>{"use strict";const t=flarum.core.compat["forum/app"];var e=r.n(t);const n=flarum.core.compat["common/extend"],o=flarum.core.compat["forum/components/DiscussionListItem"];var i=r.n(o);const a=flarum.core.compat["forum/components/DiscussionPage"];var u=r.n(a);const l=flarum.core.compat["forum/components/PostStream"];var s=r.n(l);const f=flarum.core.compat["common/components/Link"];var c=r.n(f);function m(r,t){(null==t||t>r.length)&&(t=r.length);for(var e=0,n=Array(t);e<t;e++)n[e]=r[e];return n}var d=Object.create(null),b=Object.create(null),v=Object.create(null);e().initializers.add("lady-byron/reading-enhance",function(){(0,n.extend)(i().prototype,"view",function(r){var t,n,o;if(null==(t=this.attrs)||null==(t=t.params)||!t.q){var i=null==(n=this.attrs)?void 0:n.discussion;if(i){var a=null!=(o=i.attribute("lbReadingPosition"))?o:null;!a||a<=1||r.children.forEach(function(r){r&&r.attrs&&r.attrs.className&&-1!==r.attrs.className.indexOf("DiscussionListItem-content")&&r.children.forEach(function(r){var t;r&&r.tag===c()&&(t=function(r){if(!("v17development-blog"in flarum.extensions))return!1;var t=e().forum.attribute("blogRedirectsEnabled"),n="both"===t||"discussions_only"===t,o=(null==r.tags?void 0:r.tags())||[];if(!n||0===o.length)return!1;var i=e().forum.attribute("blogTags")||[];return o.some(function(r){if(!r)return!1;var t=(null==r.parent?void 0:r.parent())||null;return-1!==i.indexOf(null==r.id?void 0:r.id())||t&&-1!==i.indexOf(null==t.id?void 0:t.id())})}(i)?a>1?e().route("blogArticle.near",{id:i.slug(),near:a}):e().route("blogArticle",{id:i.slug()}):e().route.discussion(i,a),r.attrs.href=t)})})}}}),(0,n.override)(u().prototype,"view",function(r){for(var t=this,n=arguments.length,o=new Array(n>1?n-1:0),i=1;i<n;i++)o[i-1]=arguments[i];var a=r.apply(void 0,o),u=function(r){if(r){if(Array.isArray(r))return r.forEach(u);if(r.children&&u(r.children),r.tag===s()){r.attrs=r.attrs||{};var n=r.attrs.onPositionChange;r.attrs.onPositionChange=function(){for(var r=arguments.length,o=new Array(r),i=0;i<r;i++)o[i]=arguments[i];if("function"==typeof n&&n.apply(void 0,o),e().session.user){var a=null==t?void 0:t.discussion;if(a){var u=function(r){for(var t,e=function(r,t){var e="undefined"!=typeof Symbol&&r[Symbol.iterator]||r["@@iterator"];if(e)return(e=e.call(r)).next.bind(e);if(Array.isArray(r)||(e=function(r,t){if(r){if("string"==typeof r)return m(r,t);var e={}.toString.call(r).slice(8,-1);return"Object"===e&&r.constructor&&(e=r.constructor.name),"Map"===e||"Set"===e?Array.from(r):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?m(r,t):void 0}}(r))||t&&r&&"number"==typeof r.length){e&&(r=e);var n=0;return function(){return n>=r.length?{done:!0}:{done:!1,value:r[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(r);!(t=e()).done;){var n=t.value;if(null!=n)if("number"!=typeof n){if("object"==typeof n){if("number"==typeof n.number&&n.number>0)return n.number;if("number"==typeof n.postNumber&&n.postNumber>0)return n.postNumber;if("number"==typeof n.near&&n.near>0)return n.near;if(n.visible&&"number"==typeof n.visible.number&&n.visible.number>0)return n.visible.number}}else if(n>0)return n}return null}(o);u||(u=function(){try{var r=new URL(window.location.href),t=r.pathname.split("/").filter(Boolean),e=t.indexOf("d");if(-1!==e&&t.length>e+2){var n=parseInt(t[e+2],10);if(!Number.isNaN(n)&&n>0)return n}var o=parseInt(r.searchParams.get("near")||"",10);if(!Number.isNaN(o)&&o>0)return o}catch(r){}return null}()),u||(u=function(){for(var r=document.querySelectorAll(".PostStream-item[data-number]"),t=0,e=Array.from(r);t<e.length;t++){var n=e[t],o=n.getBoundingClientRect();if(o.top<=4&&o.bottom>4){var i=parseInt(n.dataset.number||"",10);if(i>0)return i}}for(var a=0,u=Array.from(r);a<u.length;a++){var l=u[a],s=l.getBoundingClientRect();if(s.top>=4&&s.top<(window.innerHeight||0)){var f=parseInt(l.dataset.number||"",10);if(f>0)return f}}return null}()),u&&"number"==typeof u&&u>0&&function(r,t){var n=r.id();b[n]!==t&&(b[n]=t,d[n]&&window.clearTimeout(d[n]),d[n]=window.setTimeout(function(){var t,o,i=b[n];if(!("number"!=typeof i||i<=0)){var a,u,l=null!=(t=r.attribute("lbReadingPosition"))?t:0,s=null!=(o=v[n])?o:l;i!==l&&i!==s&&(a=n,u=i,e().request({method:"POST",url:e().forum.attribute("apiUrl")+"/ladybyron/reading-position",body:{discussionId:a,postNumber:u}}).catch(function(){})).then(function(){v[n]=i,r.attribute("lbReadingPosition")!==i&&r.pushAttributes({lbReadingPosition:i})})}},200))}(a,u)}}}}}};return u(a),a})})})(),module.exports={}})();
//# sourceMappingURL=forum.js.map