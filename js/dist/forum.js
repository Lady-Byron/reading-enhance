(()=>{var t={n:e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return t.d(n,{a:n}),n},d:(e,n)=>{for(var r in n)t.o(n,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:n[r]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};(()=>{"use strict";const e=flarum.core.compat["forum/app"];var n=t.n(e);const r=flarum.core.compat["common/extend"],i=flarum.core.compat["forum/states/PostStreamState"];var o=t.n(i),u={did:null,targetNum:null,left:0,expiresAt:0};function a(t,e){"scrollBy"in window?window.scrollBy({top:t,left:0,behavior:e?"smooth":"auto"}):(document.scrollingElement||document.documentElement||document.body).scrollTop+=t}const l=flarum.core.compat["forum/components/DiscussionPage"];var s=t.n(l),d=Object.create(null),c=Object.create(null),f=Object.create(null),p=[];var b=!1;const v=flarum.core.compat["forum/components/DiscussionListItem"];var m=t.n(v);function h(t){try{if(!flarum||!("v17development-blog"in flarum.extensions))return!1}catch(t){return!1}var e=n().forum.attribute("blogRedirectsEnabled"),r="both"===e||"discussions_only"===e,i=(null==t.tags?void 0:t.tags())||[];if(!r||0===i.length)return!1;var o=n().forum.attribute("blogTags")||[];return i.some(function(t){var e,n,r,i;if(!t)return!1;var u=null!=(e=null!=(n=null==t.id?void 0:t.id())?n:t.id)?e:null,a=(null==t.parent?void 0:t.parent())||null,l=a&&null!=(r=null!=(i=null==a.id?void 0:a.id())?i:a.id)?r:null;return null!=u&&-1!==o.indexOf(u)||null!=l&&-1!==o.indexOf(l)})}function g(t){var e=n().store.getById("discussions",t);if(!e)return null;var r="function"==typeof e.attribute?e.attribute("lbReadingPosition"):e.lbReadingPosition;if("number"==typeof r)return r>1?r:null;var i="function"==typeof e.lastReadPostNumber?e.lastReadPostNumber():"function"==typeof e.attribute?e.attribute("lastReadPostNumber"):null;return"number"==typeof i&&i>1?i:null}function y(t,e,n){var r;if(t&&"object"==typeof t)if(Array.isArray(t))for(var i=0;i<t.length;i++)y(t[i],e,n);else{var o=null==(r=t.attrs)?void 0:r.href;if("string"==typeof o&&/^\/d\/[^/]+$/.test(o)&&(t.attrs.href=null!=n?n:o+"/"+e,console.debug("[lb-nav] patched list-item link",{from:o,to:t.attrs.href})),t.children)if(Array.isArray(t.children))for(var u=0;u<t.children.length;u++)y(t.children[u],e,n);else y(t.children,e,n)}}var w,P,x=!1;n().initializers.add("lady-byron/reading-enhance-reply-jump",function(){(function(){if(!n().__lbReqHooked){n().__lbReqHooked=!0;var t=n().request.bind(n());n().request=function(e){var n=t(e);try{var r=String((null==e?void 0:e.method)||"").toUpperCase(),i=String((null==e?void 0:e.url)||"");return"POST"===r&&/\/api\/posts(?:\?|$)/.test(i)?n.then(function(t){var e,n,r,i,o,a=null!=(e=null!=(n=null==t||null==(r=t.data)||null==(r=r.relationships)||null==(r=r.discussion)||null==(r=r.data)?void 0:r.id)?n:null==t||null==(i=t.data)||null==(i=i.attributes)?void 0:i.discussionId)?e:null,l="number"==typeof(null==t||null==(o=t.data)||null==(o=o.attributes)?void 0:o.number)?t.data.attributes.number:null;return a&&function(t,e,n,r){void 0===n&&(n=1800),void 0===r&&(r=3),u.did=t,u.targetNum="number"==typeof e&&e>0?e:null,u.left=Math.max(1,r),u.expiresAt=Date.now()+Math.max(300,n)}(String(a),l,1800,3),t}):n}catch(t){return n}}}})(),(0,r.override)(o().prototype,"goToNumber",function(t,e){try{var n=this.discussion;if((r="function"==typeof(null==n?void 0:n.id)?n.id():null==n?void 0:n.id)&&u.did===r&&u.left>0&&Date.now()<u.expiresAt&&function(t,e){if(!t)return!1;if("reply"===e)return!0;var n="function"==typeof t.lastPostNumber?t.lastPostNumber():null==t.attribute?void 0:t.attribute("lastPostNumber");if("number"==typeof e&&e>0){if("number"==typeof n&&n>0&&e>=n)return!0;if(u.targetNum&&e>=u.targetNum)return!0}return!1}(n,e))return u.left>0&&(u.left-=1),void(u.left<=0&&(u.did=null,u.targetNum=null,u.expiresAt=0))}catch(t){}for(var r,i=arguments.length,o=new Array(i>2?i-2:0),a=2;a<i;a++)o[a-2]=arguments[a];return t.apply(void 0,[e].concat(o))})}),w=Object.assign({},{halfRatio:.5,smooth:!0,headerSelector:".App-header"},{}),P=!1,n().initializers.add("lady-byron/reading-enhance-shortcuts",function(){if(!P){P=!0;var t=function(t){if(!function(t){var e,r=t instanceof Element?t:null;if(!r)return!1;var i=r.closest('input, textarea, [contenteditable="true"], .TextEditor, .CodeMirror, .ProseMirror, .Composer, .Modal'),o=!(null==n()||null==(e=n().composer)||null==e.isVisible||!e.isVisible());return!!i||o}(t.target)&&!t.repeat){var e=function(t){if(t.ctrlKey||t.metaKey||t.altKey)return"";var e=[];t.shiftKey&&e.push("Shift");var n=1===t.key.length?t.key.toUpperCase():t.key;return e.push(n),e.join("+")}(t);if(e){var r=function(t){try{var e=document.querySelector(t);return e?e.getBoundingClientRect().height:0}catch(t){return 0}}(w.headerSelector),i=window.innerHeight||0;switch(e){case"Shift+D":t.preventDefault(),t.stopPropagation(),a(Math.max(1,Math.round(i*w.halfRatio)-Math.round(r/2)),w.smooth);break;case"Shift+U":t.preventDefault(),t.stopPropagation(),a(-Math.max(1,Math.round(i*w.halfRatio)-Math.round(r/2)),w.smooth);break;case"Shift+J":t.preventDefault(),t.stopPropagation(),a(Math.max(1,i-r),w.smooth);break;case"Shift+K":t.preventDefault(),t.stopPropagation(),a(-Math.max(1,i-r),w.smooth)}}}};window.addEventListener("keydown",t,!0),window.__lb_shortcuts={detach:function(){window.removeEventListener("keydown",t,!0)}}}}),b||(b=!0,n().initializers.add("lady-byron/reading-enhance-recorder",function(){console.debug("[lb-rec] extending DiscussionPage.positionChanged"),(0,r.extend)(s().prototype,"positionChanged",function(t,e){if(n().session.user){var r=this.discussion;r&&(console.debug("[lb-rec] positionChanged fired",{startNumber:e,discussion:null==r.id?void 0:r.id()}),"number"==typeof e&&e>0&&function(t,e){var r,i=null!=(r=null==t.id?void 0:t.id())?r:t.id;i&&(function(t){var e=p.indexOf(t);for(-1!==e&&p.splice(e,1),p.push(t);p.length>50;){var n=p.shift();d[n]&&window.clearTimeout(d[n]),delete d[n],delete c[n],delete f[n]}}(i),c[i]!==e&&(c[i]=e,d[i]&&window.clearTimeout(d[i]),d[i]=window.setTimeout(function(){var e,r,o=c[i];if(!("number"!=typeof o||o<=0)){var u,a,l=null!=(e=null==t.attribute?void 0:t.attribute("lbReadingPosition"))?e:0,s=null!=(r=f[i])?r:l;o!==l&&o!==s&&(u=i,a=o,n().request({method:"POST",url:n().forum.attribute("apiUrl")+"/ladybyron/reading-position",body:{discussionId:u,postNumber:a}}).catch(function(){})).then(function(){f[i]=o,t.attribute&&t.attribute("lbReadingPosition")!==o&&t.pushAttributes({lbReadingPosition:o})})}},200)))}(r,e))}})})),x||(x=!0,n().initializers.add("lady-byron/reading-enhance-navigation",function(){if(n().route.discussion){var t=n().route.discussion.bind(n().route);console.debug("[lb-nav] hooking app.route.discussion"),n().route.discussion=function(e,r){try{if(!r){var i="function"==typeof(null==e?void 0:e.id)?e.id():null==e?void 0:e.id;if(i){var o=g(String(i));if(o&&o>1&&h(e))try{var u="function"==typeof e.slug?e.slug():e.slug;return n().route("blogArticle.near",{id:u,near:o})}catch(t){}o&&(r=o)}}}catch(t){}return t(e,r)}}else console.warn("[lb-nav] app.route.discussion NOT found â€” Layer A skipped");(0,r.extend)(m().prototype,"view",function(t){var e,r;if(null==(e=this.attrs)||null==(e=e.params)||!e.q){var i=null==(r=this.attrs)?void 0:r.discussion;if(i){var o="function"==typeof i.id?i.id():i.id;if(o){var u=g(String(o));if(u&&!(u<=1)){if(h(i))try{var a="function"==typeof i.slug?i.slug():i.slug;return void y(t,u,n().route("blogArticle.near",{id:a,near:u}))}catch(t){}y(t,u)}}}}}),window.__lbDebug={effectiveNearFromStore:g,dumpStore:function(){return n().store.all("discussions").map(function(t){var e;return{id:t.id(),slug:null==t.slug?void 0:t.slug(),lbReadingPosition:t.attribute("lbReadingPosition"),lastReadPostNumber:null!=(e=null==t.lastReadPostNumber?void 0:t.lastReadPostNumber())?e:t.attribute("lastReadPostNumber")}})}},console.debug("[lb-nav] __lbDebug ready")}))})(),module.exports={}})();
//# sourceMappingURL=forum.js.map