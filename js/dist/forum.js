(()=>{var t={n:r=>{var e=r&&r.__esModule?()=>r.default:()=>r;return t.d(e,{a:e}),e},d:(r,e)=>{for(var n in e)t.o(e,n)&&!t.o(r,n)&&Object.defineProperty(r,n,{enumerable:!0,get:e[n]})},o:(t,r)=>Object.prototype.hasOwnProperty.call(t,r)};(()=>{"use strict";const r=flarum.core.compat["forum/app"];var e=t.n(r);const n=flarum.core.compat["forum/states/PostStreamState"];var i=t.n(n);const o=flarum.core.compat["forum/components/PostStream"];var a=t.n(o),l={did:null,targetNum:null,left:0,expiresAt:0};function u(){return Date.now()}function s(t){return!!t&&l.did===t&&l.left>0&&u()<l.expiresAt}function f(){l.left>0&&(l.left-=1),l.left<=0&&(l.did=null,l.targetNum=null,l.expiresAt=0)}function c(t,r){if(!t)return!1;if("reply"===r)return!0;var e="function"==typeof t.lastPostNumber?t.lastPostNumber():null==t.attribute?void 0:t.attribute("lastPostNumber");if("number"==typeof r&&r>0){if("number"==typeof e&&e>0&&r>=e)return!0;if(l.targetNum&&r>=l.targetNum)return!0}return!1}function d(t,r){"scrollBy"in window?window.scrollBy({top:t,left:0,behavior:r?"smooth":"auto"}):(document.scrollingElement||document.documentElement||document.body).scrollTop+=t}const p=flarum.core.compat["common/extend"],v=flarum.core.compat["forum/components/DiscussionPage"];var h=t.n(v);function b(t,r){(null==r||r>t.length)&&(r=t.length);for(var e=0,n=Array(r);e<r;e++)n[e]=t[e];return n}var y=Object.create(null),g=Object.create(null),w=Object.create(null);var N=!1;const P=flarum.core.compat["forum/components/DiscussionListItem"];var x=t.n(P);const S=flarum.core.compat["common/components/Link"];var R=t.n(S);function A(t){var r=t.pathname.split("/").filter(Boolean),e=r.indexOf("d");if(-1!==e&&r.length>e+2){var n=parseInt(r[e+2],10);if(!Number.isNaN(n)&&n>0)return n}var i=t.searchParams.get("near");if(i){var o=parseInt(i,10);if(!Number.isNaN(o)&&o>0)return o;var a=i.toLowerCase();if("first"===a)return"first";if("last"===a)return"last"}if(t.hash){var l=t.hash.toLowerCase();if(/^#p\d+$/.test(l))return parseInt(l.slice(2),10);if("#reply"===l||"#last"===l)return"last";if("#first"===l)return"first"}return null}function O(t){var r=e().store.getById("discussions",t);if(!r)return{pos:null,source:null};var n="function"==typeof r.attribute?r.attribute("lbReadingPosition"):r.lbReadingPosition,i="function"==typeof r.lastReadPostNumber?r.lastReadPostNumber():"function"==typeof r.attribute?r.attribute("lastReadPostNumber"):null,o="number"==typeof n,a="number"==typeof i?i:null;return o?{pos:o?n:null,source:"lb"}:a&&a>1?{pos:a,source:"last"}:{pos:null,source:null}}function I(t,r){var e=t.pathname.split("/").filter(Boolean),n=e.indexOf("d");if(-1===n||e.length<=n+1)return t.pathname+t.search+t.hash;var i="/"+e.slice(0,n+2).join("/");return t.pathname=i+"/"+r,t.searchParams.delete("near"),t.hash&&/^#p\d+$/i.test(t.hash)&&(t.hash=""),t.pathname+t.search+t.hash}var T,j,M=!1;e().initializers.add("lady-byron/reading-enhance-reply-jump",function(){(function(){if(!e().__lbReqHooked){e().__lbReqHooked=!0;var t=e().request.bind(e());e().request=function(r){var e=t(r);try{var n=String((null==r?void 0:r.method)||"").toUpperCase(),i=String((null==r?void 0:r.url)||"");return"POST"===n&&/\/posts(?:\?|$|\/)/.test(i)?e.then(function(t){var r,e,n,i,o,a=null!=(r=null!=(e=null==t||null==(n=t.data)||null==(n=n.relationships)||null==(n=n.discussion)||null==(n=n.data)?void 0:n.id)?e:null==t||null==(i=t.data)||null==(i=i.attributes)?void 0:i.discussionId)?r:null,s="number"==typeof(null==t||null==(o=t.data)||null==(o=o.attributes)?void 0:o.number)?t.data.attributes.number:null;return a&&function(t,r,e,n){void 0===e&&(e=1800),void 0===n&&(n=3),l.did=t,l.targetNum="number"==typeof r&&r>0?r:null,l.left=Math.max(1,n),l.expiresAt=u()+Math.max(300,e)}(String(a),s,1800,3),t}):e}catch(t){return e}}}})(),function(){var t=i().prototype.goToNumber;i().prototype.goToNumber=function(r){try{var e,n=null==this?void 0:this.discussion;if(s(null!=(e=null==n||null==n.id?void 0:n.id())?e:"function"==typeof(null==n?void 0:n.id)?n.id():null)&&c(n,r))return void f()}catch(t){}for(var i=arguments.length,o=new Array(i>1?i-1:0),a=1;a<i;a++)o[a-1]=arguments[a];return t.apply(this,[r].concat(o))};var r=a().prototype;if("function"==typeof r.triggerScroll){var e=r.triggerScroll;r.triggerScroll=function(){try{var t,r,n,i,o,a=null==this||null==(t=this.attrs)?void 0:t.state,l=null==a?void 0:a.discussion,u=null!=(r=null==l||null==l.id?void 0:l.id())?r:"function"==typeof(null==l?void 0:l.id)?l.id():null,d=null!=(n=null!=(i=null!=(o=null==a?void 0:a.targetPostNumber)?o:null==a?void 0:a.index)?i:(null==a?void 0:a.visible)&&a.visible.number)?n:null;if(s(u)&&c(l,d))return void f()}catch(t){}for(var p=arguments.length,v=new Array(p),m=0;m<p;m++)v[m]=arguments[m];return e.apply(this,v)}}if("function"==typeof r.scrollToNumber){var n=r.scrollToNumber;r.scrollToNumber=function(t){try{var r,e,i=null==this||null==(r=this.attrs)?void 0:r.state,o=null==i?void 0:i.discussion;if(s(null!=(e=null==o||null==o.id?void 0:o.id())?e:"function"==typeof(null==o?void 0:o.id)?o.id():null)&&c(o,t))return void f()}catch(t){}for(var a=arguments.length,l=new Array(a>1?a-1:0),u=1;u<a;u++)l[u-1]=arguments[u];return n.apply(this,[t].concat(l))}}if("function"==typeof r.scrollToIndex){var o=r.scrollToIndex;r.scrollToIndex=function(t){try{var r,e,n,i=null==this||null==(r=this.attrs)?void 0:r.state,a=null==i?void 0:i.discussion,l=null!=(e=null==a||null==a.id?void 0:a.id())?e:"function"==typeof(null==a?void 0:a.id)?a.id():null,u=null!=i&&null!=(n=i.visible)&&n.number&&"number"==typeof i.visible.number?i.visible.number:t;if(s(l)&&c(a,u))return void f()}catch(t){}for(var d=arguments.length,p=new Array(d>1?d-1:0),v=1;v<d;v++)p[v-1]=arguments[v];return o.apply(this,[t].concat(p))}}}()}),T=Object.assign({},{halfRatio:.5,smooth:!0,headerSelector:".App-header"},{}),j=!1,e().initializers.add("lady-byron/reading-enhance-shortcuts",function(){if(!j){j=!0;var t=function(t){if(!function(t){var r,n=t instanceof Element?t:null;if(!n)return!1;var i=n.closest('input, textarea, [contenteditable="true"], .TextEditor, .CodeMirror, .ProseMirror, .Composer, .Modal'),o=!(null==e()||null==(r=e().composer)||null==r.isVisible||!r.isVisible());return!!i||o}(t.target)&&!t.repeat){var r=function(t){if(t.ctrlKey||t.metaKey||t.altKey)return"";var r=[];t.shiftKey&&r.push("Shift");var e=1===t.key.length?t.key.toUpperCase():t.key;return r.push(e),r.join("+")}(t);if(r){var n=function(t){try{var r=document.querySelector(t);return r?r.getBoundingClientRect().height:0}catch(t){return 0}}(T.headerSelector),i=window.innerHeight||0;switch(r){case"Shift+D":t.preventDefault(),t.stopPropagation(),d(Math.max(1,Math.round(i*T.halfRatio)-Math.round(n/2)),T.smooth);break;case"Shift+U":t.preventDefault(),t.stopPropagation(),d(-Math.max(1,Math.round(i*T.halfRatio)-Math.round(n/2)),T.smooth);break;case"Shift+J":t.preventDefault(),t.stopPropagation(),d(i,T.smooth);break;case"Shift+K":t.preventDefault(),t.stopPropagation(),d(-i,T.smooth)}}}};window.addEventListener("keydown",t,!0),window.__lb_shortcuts={detach:function(){window.removeEventListener("keydown",t,!0)}}}}),N||(N=!0,e().initializers.add("lady-byron/reading-enhance-recorder",function(){(0,p.override)(h().prototype,"view",function(t){for(var r=this,n=arguments.length,i=new Array(n>1?n-1:0),o=1;o<n;o++)i[o-1]=arguments[o];var l=t.apply(void 0,i),u=function(t){if(t)if(Array.isArray(t))t.forEach(u);else if(t.children&&u(t.children),t.tag===a()){t.attrs=t.attrs||{};var n=t.attrs.onPositionChange;t.attrs.onPositionChange=function(){for(var t=arguments.length,i=new Array(t),o=0;o<t;o++)i[o]=arguments[o];if("function"==typeof n&&n.apply(void 0,i),e().session.user){var a=null==r?void 0:r.discussion;if(a){var l=function(t){for(var r,e=function(t,r){var e="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(e)return(e=e.call(t)).next.bind(e);if(Array.isArray(t)||(e=function(t,r){if(t){if("string"==typeof t)return b(t,r);var e={}.toString.call(t).slice(8,-1);return"Object"===e&&t.constructor&&(e=t.constructor.name),"Map"===e||"Set"===e?Array.from(t):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?b(t,r):void 0}}(t))||r&&t&&"number"==typeof t.length){e&&(t=e);var n=0;return function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(t);!(r=e()).done;){var n=r.value;if(null!=n)if("number"==typeof n){if(n>0)return n}else if("object"==typeof n){var i=n;if("number"==typeof i.number&&i.number>0)return i.number;if("number"==typeof i.postNumber&&i.postNumber>0)return i.postNumber;if("number"==typeof i.near&&i.near>0)return i.near;if(i.visible&&"number"==typeof i.visible.number&&i.visible.number>0)return i.visible.number}}return null}(i);l||(l=function(){try{var t=new URL(window.location.href),r=t.pathname.split("/").filter(Boolean),e=r.indexOf("d");if(-1!==e&&r.length>e+2){var n=parseInt(r[e+2],10);if(!Number.isNaN(n)&&n>0)return n}var i=parseInt(t.searchParams.get("near")||"",10);if(!Number.isNaN(i)&&i>0)return i}catch(t){}return null}()),l&&"number"==typeof l&&l>0&&function(t,r){var n,i=null!=(n=null==t.id?void 0:t.id())?n:t.id;i&&g[i]!==r&&(g[i]=r,y[i]&&window.clearTimeout(y[i]),y[i]=window.setTimeout(function(){var r,n,o=g[i];if(!("number"!=typeof o||o<=0)){var a,l,u=null!=(r=null==t.attribute?void 0:t.attribute("lbReadingPosition"))?r:0,s=null!=(n=w[i])?n:u;o!==u&&o!==s&&(a=i,l=o,e().request({method:"POST",url:e().forum.attribute("apiUrl")+"/ladybyron/reading-position",body:{discussionId:a,postNumber:l}}).catch(function(){})).then(function(){w[i]=o,t.attribute&&t.attribute("lbReadingPosition")!==o&&t.pushAttributes({lbReadingPosition:o})})}},200))}(a,l)}}}}};return u(l),l})})),M||(M=!0,e().initializers.add("lady-byron/reading-enhance-navigation",function(){if((0,p.extend)(x().prototype,"view",function(t){var r,n,i;if(null==(r=this.attrs)||null==(r=r.params)||!r.q){var o=null==(n=this.attrs)?void 0:n.discussion;if(o){var a=null!=(i=o.attribute("lbReadingPosition"))?i:null;!a||a<=1||t.children.forEach(function(t){t&&t.attrs&&t.attrs.className&&-1!==t.attrs.className.indexOf("DiscussionListItem-content")&&t.children.forEach(function(t){var r;t&&t.tag===R()&&(r=function(t){try{if(!flarum||!("v17development-blog"in flarum.extensions))return!1}catch(t){return!1}var r=e().forum.attribute("blogRedirectsEnabled"),n="both"===r||"discussions_only"===r,i=(null==t.tags?void 0:t.tags())||[];if(!n||0===i.length)return!1;var o=e().forum.attribute("blogTags")||[];return i.some(function(t){if(!t)return!1;var r=(null==t.parent?void 0:t.parent())||null;return-1!==o.indexOf(null==t.id?void 0:t.id())||r&&-1!==o.indexOf(null==r.id?void 0:r.id())})}(o)?a>1?e().route("blogArticle.near",{id:o.slug(),near:a}):e().route("blogArticle",{id:o.slug()}):e().route.discussion(o,a),t.attrs=t.attrs||{},t.attrs.href=r,t.attrs["data-lbRewritten"]="1")})})}}}),(0,p.extend)(R().prototype,"view",function(t){var r=t.attrs||{};if(!r["data-lbRewritten"]){var n=r.href;if("string"==typeof n&&n.trim()){var i;try{i=new URL(n,e().forum.attribute("baseUrl"))}catch(t){return}if(function(t){try{var r=new URL(e().forum.attribute("baseUrl"));return t.origin===r.origin}catch(t){return!1}}(i)&&!A(i)){var o=function(t){var r=t.pathname.split("/").filter(Boolean),e=r.indexOf("d");if(-1===e||r.length<=e+1)return null;var n=r[e+1],i=/^(\d+)/.exec(n);return i?i[1]:null}(i);if(o){var a=O(o),l=null;if("lb"===a.source?a.pos&&a.pos>1&&(l=a.pos):"last"===a.source&&a.pos&&a.pos>1&&(l=a.pos),l&&!(l<=1)){var u=I(i,l);t.attrs.href=u,t.attrs["data-lbRewritten"]="1"}}}}}}),e().route.discussion){var t=e().route.discussion.bind(e().route);e().route.discussion=function(r,n){try{var i,o=n,a=null!=(i=null==r||null==r.id?void 0:r.id())?i:"function"==typeof(null==r?void 0:r.id)?r.id():null==r?void 0:r.id;if(!o&&a){var l=O(String(a));"lb"===l.source?l.pos&&l.pos>1&&(o=l.pos):"last"===l.source&&l.pos&&l.pos>1&&(o=l.pos)}var u=t(r,o);if(!a||!o||o<=1)return u;try{var s=new URL(u,e().forum.attribute("baseUrl"));return A(s)?u:I(s,o)}catch(t){return u}}catch(e){return t(r,n)}}}var r=m.route.set.bind(m.route);m.route.set=function(t,e,n){try{if("string"==typeof t){var i=new URL(t,window.location.origin),o=i.pathname.split("/").filter(Boolean),a=o.indexOf("d");if(-1!==a&&o.length>a+1){var l=o.length>a+2&&/^\d+$/.test(o[a+2]),u=i.searchParams.has("near");if(!l&&!u){var s=o[a+1],f=/^(\d+)/.exec(s),c=f?f[1]:null;if(c){var d=O(c),p=null;if("lb"===d.source?d.pos&&d.pos>1&&(p=d.pos):"last"===d.source&&d.pos&&d.pos>1&&(p=d.pos),p&&p>1){var v="/"+o.slice(0,a+2).join("/");i.pathname=v+"/"+p,i.searchParams.delete("near"),t=i.pathname+i.search+i.hash}}}}}}catch(t){}return r(t,e,n)}}))})(),module.exports={}})();
//# sourceMappingURL=forum.js.map